!function(e){"use strict";function t(i){if(i&&i.__esModule)return i;var r=Object.create(null);return i&&Object.keys(i).forEach(function(e){var t;"default"!==e&&(t=Object.getOwnPropertyDescriptor(i,e),Object.defineProperty(r,e,t.get?t:{enumerable:!0,get:function(){return i[e]}}))}),r.default=i,Object.freeze(r)}var i,a=t(e),r="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function s(i){if(i.__esModule)return i;var r=Object.defineProperty({},"__esModule",{value:!0});return Object.keys(i).forEach(function(e){var t=Object.getOwnPropertyDescriptor(i,e);Object.defineProperty(r,e,t.get?t:{enumerable:!0,get:function(){return i[e]}})}),r}var o=new Uint8Array(16);function c(){if(!i&&!(i="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return i(o)}var n=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function l(e){return"string"==typeof e&&n.test(e)}for(var d,u,h=[],p=0;p<256;++p)h.push((p+256).toString(16).substr(1));function g(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,t=(h[e[t+0]]+h[e[t+1]]+h[e[t+2]]+h[e[t+3]]+"-"+h[e[t+4]]+h[e[t+5]]+"-"+h[e[t+6]]+h[e[t+7]]+"-"+h[e[t+8]]+h[e[t+9]]+"-"+h[e[t+10]]+h[e[t+11]]+h[e[t+12]]+h[e[t+13]]+h[e[t+14]]+h[e[t+15]]).toLowerCase();if(!l(t))throw TypeError("Stringified UUID is invalid");return t}var m=0,v=0;function f(e){if(!l(e))throw TypeError("Invalid UUID");var t,i=new Uint8Array(16);return i[0]=(t=parseInt(e.slice(0,8),16))>>>24,i[1]=t>>>16&255,i[2]=t>>>8&255,i[3]=255&t,i[4]=(t=parseInt(e.slice(9,13),16))>>>8,i[5]=255&t,i[6]=(t=parseInt(e.slice(14,18),16))>>>8,i[7]=255&t,i[8]=(t=parseInt(e.slice(19,23),16))>>>8,i[9]=255&t,i[10]=(t=parseInt(e.slice(24,36),16))/1099511627776&255,i[11]=t/4294967296&255,i[12]=t>>>24&255,i[13]=t>>>16&255,i[14]=t>>>8&255,i[15]=255&t,i}function b(e,n,a){function t(e,t,i,r){if("string"==typeof e&&(e=function(e){e=unescape(encodeURIComponent(e));for(var t=[],i=0;i<e.length;++i)t.push(e.charCodeAt(i));return t}(e)),16!==(t="string"==typeof t?f(t):t).length)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");var s=new Uint8Array(16+e.length);if(s.set(t),s.set(e,t.length),(s=a(s))[6]=15&s[6]|n,s[8]=63&s[8]|128,i){r=r||0;for(var o=0;o<16;++o)i[r+o]=s[o];return i}return g(s)}try{t.name=e}catch(e){}return t.DNS="6ba7b810-9dad-11d1-80b4-00c04fd430c8",t.URL="6ba7b811-9dad-11d1-80b4-00c04fd430c8",t}function w(e){return 14+(e+64>>>9<<4)+1}function y(e,t){var i=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(i>>16)<<16|65535&i}function M(e,t,i,r,s,o){return y((o=y(y(t,e),y(r,o)))<<s|o>>>32-s,i)}function C(e,t,i,r,s,o,n){return M(t&i|~t&r,e,t,s,o,n)}function S(e,t,i,r,s,o,n){return M(t&r|i&~r,e,t,s,o,n)}function L(e,t,i,r,s,o,n){return M(t^i^r,e,t,s,o,n)}function T(e,t,i,r,s,o,n){return M(i^(t|~r),e,t,s,o,n)}var H=b("v3",48,function(e){if("string"==typeof e){var t=unescape(encodeURIComponent(e));e=new Uint8Array(t.length);for(var i=0;i<t.length;++i)e[i]=t.charCodeAt(i)}return function(e){for(var t=[],i=32*e.length,r="0123456789abcdef",s=0;s<i;s+=8){var o=e[s>>5]>>>s%32&255,o=parseInt(r.charAt(o>>>4&15)+r.charAt(15&o),16);t.push(o)}return t}(function(e,t){e[t>>5]|=128<<t%32,e[w(t)-1]=t;for(var i=1732584193,r=-271733879,s=-1732584194,o=271733878,n=0;n<e.length;n+=16){var a=i,l=r,h=s,c=o;i=C(i,r,s,o,e[n],7,-680876936),o=C(o,i,r,s,e[n+1],12,-389564586),s=C(s,o,i,r,e[n+2],17,606105819),r=C(r,s,o,i,e[n+3],22,-1044525330),i=C(i,r,s,o,e[n+4],7,-176418897),o=C(o,i,r,s,e[n+5],12,1200080426),s=C(s,o,i,r,e[n+6],17,-1473231341),r=C(r,s,o,i,e[n+7],22,-45705983),i=C(i,r,s,o,e[n+8],7,1770035416),o=C(o,i,r,s,e[n+9],12,-1958414417),s=C(s,o,i,r,e[n+10],17,-42063),r=C(r,s,o,i,e[n+11],22,-1990404162),i=C(i,r,s,o,e[n+12],7,1804603682),o=C(o,i,r,s,e[n+13],12,-40341101),s=C(s,o,i,r,e[n+14],17,-1502002290),r=C(r,s,o,i,e[n+15],22,1236535329),i=S(i,r,s,o,e[n+1],5,-165796510),o=S(o,i,r,s,e[n+6],9,-1069501632),s=S(s,o,i,r,e[n+11],14,643717713),r=S(r,s,o,i,e[n],20,-373897302),i=S(i,r,s,o,e[n+5],5,-701558691),o=S(o,i,r,s,e[n+10],9,38016083),s=S(s,o,i,r,e[n+15],14,-660478335),r=S(r,s,o,i,e[n+4],20,-405537848),i=S(i,r,s,o,e[n+9],5,568446438),o=S(o,i,r,s,e[n+14],9,-1019803690),s=S(s,o,i,r,e[n+3],14,-187363961),r=S(r,s,o,i,e[n+8],20,1163531501),i=S(i,r,s,o,e[n+13],5,-1444681467),o=S(o,i,r,s,e[n+2],9,-51403784),s=S(s,o,i,r,e[n+7],14,1735328473),r=S(r,s,o,i,e[n+12],20,-1926607734),i=L(i,r,s,o,e[n+5],4,-378558),o=L(o,i,r,s,e[n+8],11,-2022574463),s=L(s,o,i,r,e[n+11],16,1839030562),r=L(r,s,o,i,e[n+14],23,-35309556),i=L(i,r,s,o,e[n+1],4,-1530992060),o=L(o,i,r,s,e[n+4],11,1272893353),s=L(s,o,i,r,e[n+7],16,-155497632),r=L(r,s,o,i,e[n+10],23,-1094730640),i=L(i,r,s,o,e[n+13],4,681279174),o=L(o,i,r,s,e[n],11,-358537222),s=L(s,o,i,r,e[n+3],16,-722521979),r=L(r,s,o,i,e[n+6],23,76029189),i=L(i,r,s,o,e[n+9],4,-640364487),o=L(o,i,r,s,e[n+12],11,-421815835),s=L(s,o,i,r,e[n+15],16,530742520),r=L(r,s,o,i,e[n+2],23,-995338651),i=T(i,r,s,o,e[n],6,-198630844),o=T(o,i,r,s,e[n+7],10,1126891415),s=T(s,o,i,r,e[n+14],15,-1416354905),r=T(r,s,o,i,e[n+5],21,-57434055),i=T(i,r,s,o,e[n+12],6,1700485571),o=T(o,i,r,s,e[n+3],10,-1894986606),s=T(s,o,i,r,e[n+10],15,-1051523),r=T(r,s,o,i,e[n+1],21,-2054922799),i=T(i,r,s,o,e[n+8],6,1873313359),o=T(o,i,r,s,e[n+15],10,-30611744),s=T(s,o,i,r,e[n+6],15,-1560198380),r=T(r,s,o,i,e[n+13],21,1309151649),i=T(i,r,s,o,e[n+4],6,-145523070),o=T(o,i,r,s,e[n+11],10,-1120210379),s=T(s,o,i,r,e[n+2],15,718787259),r=T(r,s,o,i,e[n+9],21,-343485551),i=y(i,a),r=y(r,l),s=y(s,h),o=y(o,c)}return[i,r,s,o]}(function(e){if(0===e.length)return[];for(var t=8*e.length,i=new Uint32Array(w(t)),r=0;r<t;r+=8)i[r>>5]|=(255&e[r/8])<<r%32;return i}(e),8*e.length))});function x(e,t,i){var r=(e=e||{}).random||(e.rng||c)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t){i=i||0;for(var s=0;s<16;++s)t[i+s]=r[s];return t}return g(r)}function O(e,t){return e<<t|e>>>32-t}var E=b("v5",80,function(e){var t=[1518500249,1859775393,2400959708,3395469782],i=[1732584193,4023233417,2562383102,271733878,3285377520];if("string"==typeof e){var r=unescape(encodeURIComponent(e));e=[];for(var s=0;s<r.length;++s)e.push(r.charCodeAt(s))}else Array.isArray(e)||(e=Array.prototype.slice.call(e));e.push(128);for(var o=e.length/4+2,n=Math.ceil(o/16),a=new Array(n),l=0;l<n;++l){for(var h=new Uint32Array(16),c=0;c<16;++c)h[c]=e[64*l+4*c]<<24|e[64*l+4*c+1]<<16|e[64*l+4*c+2]<<8|e[64*l+4*c+3];a[l]=h}a[n-1][14]=8*(e.length-1)/Math.pow(2,32),a[n-1][14]=Math.floor(a[n-1][14]),a[n-1][15]=8*(e.length-1)&4294967295;for(var d=0;d<n;++d){for(var u=new Uint32Array(80),p=0;p<16;++p)u[p]=a[d][p];for(var g=16;g<80;++g)u[g]=O(u[g-3]^u[g-8]^u[g-14]^u[g-16],1);for(var m=i[0],v=i[1],f=i[2],b=i[3],w=i[4],y=0;y<80;++y)var M=Math.floor(y/20),M=O(m,5)+function(e,t,i,r){switch(e){case 0:return t&i^~t&r;case 1:return t^i^r;case 2:return t&i^t&r^i&r;case 3:return t^i^r}}(M,v,f,b)+w+t[M]+u[y]>>>0,w=b,b=f,f=O(v,30)>>>0,v=m,m=M;i[0]=i[0]+m>>>0,i[1]=i[1]+v>>>0,i[2]=i[2]+f>>>0,i[3]=i[3]+b>>>0,i[4]=i[4]+w>>>0}return[i[0]>>24&255,i[0]>>16&255,i[0]>>8&255,255&i[0],i[1]>>24&255,i[1]>>16&255,i[1]>>8&255,255&i[1],i[2]>>24&255,i[2]>>16&255,i[2]>>8&255,255&i[2],i[3]>>24&255,i[3]>>16&255,i[3]>>8&255,255&i[3],i[4]>>24&255,i[4]>>16&255,i[4]>>8&255,255&i[4]]});var _=s(Object.freeze({__proto__:null,v1:function(e,t,i){var r=t&&i||0,s=t||new Array(16),o=(e=e||{}).node||d,n=void 0!==e.clockseq?e.clockseq:u;null!=o&&null!=n||(l=e.random||(e.rng||c)(),null==o&&(o=d=[1|l[0],l[1],l[2],l[3],l[4],l[5]]),null==n&&(n=u=16383&(l[6]<<8|l[7])));var a=void 0!==e.msecs?e.msecs:Date.now(),i=void 0!==e.nsecs?e.nsecs:v+1,l=a-m+(i-v)/1e4;if(l<0&&void 0===e.clockseq&&(n=n+1&16383),1e4<=(i=(l<0||m<a)&&void 0===e.nsecs?0:i))throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");m=a,u=n,i=(1e4*(268435455&(a+=122192928e5))+(v=i))%4294967296,s[r++]=i>>>24&255,s[r++]=i>>>16&255,s[r++]=i>>>8&255,s[r++]=255&i,a=a/4294967296*1e4&268435455,s[r++]=a>>>8&255,s[r++]=255&a,s[r++]=a>>>24&15|16,s[r++]=a>>>16&255,s[r++]=n>>>8|128,s[r++]=255&n;for(var h=0;h<6;++h)s[r+h]=o[h];return t||g(s)},v3:H,v4:x,v5:E,NIL:"00000000-0000-0000-0000-000000000000",version:function(e){if(!l(e))throw TypeError("Invalid UUID");return parseInt(e.substr(14,1),16)},validate:l,stringify:g,parse:f})),B={},H={};Object.defineProperty(H,"__esModule",{value:!0});const k=[{TEXT:"BASIC",COLOR:"#19aa19",BACKGROUND:"#e8f6e8"},{TEXT:"ADVANCED",COLOR:"#f55000",BACKGROUND:"#feede5"},{TEXT:"EXPERT",COLOR:"#a00a50",BACKGROUND:"#F5E6ED"},{TEXT:"MASTER",COLOR:"#8200dc",BACKGROUND:"#f2e5fb"},{TEXT:"WORLD'S END",COLOR:"#000000",BACKGROUND:"#e5e5e5"}],j=["SONGID","TITLE","ARTIST","DESIGNER","DIFFICULTY","PLAYLEVEL","WAVE","WAVEOFFSET","JACKET","BACKGROUND","MOVIE","MOVIEOFFSET","BASEBPM"],I=["SONGID","TITLE","ARTIST","DESIGNER","DIFFICULTY","PLAYLEVEL"],N=["ARTIST","BACKGROUND","DESIGNER","JACKET","MOVIE","SONGID","TITLE","WAVE"],A=["BASEBPM","MOVIEOFFSET","WAVEOFFSET"];function P(e){return e.split("\n").filter(e=>"#"===e.slice(0,1)).map(e=>e.slice(1)).filter(e=>!e.match(/^\d{3}/)).reduce((e,t)=>{var i,r=t.slice(0,t.indexOf(" ")).trim().toUpperCase();return i=r,-1<j.indexOf(i)&&(t={key:r,value:t.slice(t.indexOf(" ")+1,t.length).trim()},e.push(t)),e},[]).map(e=>(e.value=e.value.match(/^".*"$/)?e.value.slice(1,e.value.length-1):e.value,e)).filter(e=>e.value).reduce((e,t)=>{if(-1<N.indexOf(t.key)&&(e[t.key]=t.value),-1<A.indexOf(t.key)&&Number(t.value)&&(e[t.key]=Number(t.value)),"DIFFICULTY"===t.key){var i=Number(t.value.slice(0,1));if(isNaN(i)||Number(i)<0||4<Number(i))return e;e.DIFFICULTY=Object.assign({},k[i],{LEVEL:Number(i),MARK:4===Number(i)?1!==t.value.length?`${t.value}:`.split(":")[1]:"":void 0})}if("PLAYLEVEL"===t.key){if(!Number(t.value)&&!Number(t.value.slice(0,-1)))return e;e.PLAYLEVEL={LEVEL:Number(t.value)||Number(t.value.slice(0,-1)),PLUS:/\+$/.test(t.value),TEXT:t.value}}return e},{})}H.getMeta=P,H.validate=function(e){const t=P(e),i=I.slice();return null!=t.WAVE&&i.push("WAVEOFFSET"),null!=t.MOVIE&&i.push("MOVIEOFFSET"),null!=t.DIFFICULTY&&4===t.DIFFICULTY.LEVEL&&i.splice(i.indexOf("PLAYLEVEL"),1),{MISSING_META:e=i.filter(e=>!t.hasOwnProperty(e)),VALIDITY:0===e.length}};var R,E={};Object.defineProperty(E,"__esModule",{value:!0});const D=H;function W(e,t,i,r){return e.filter(e=>e.match(t)).reduce((e,t)=>(e[Number(t.slice(i,r))]=Number(t.split(":")[1].trim()),e),[])}function Y(s,e){return[...Array(e)].reduce((e,t,i)=>{let r=i;for(;e[i]=s[r--],void 0===e[i];);return e},[])}function F(e,r){const s=[];return e.filter(e=>e.laneType===r).reduce((e,t)=>(e[t.measure]=e[t.measure]||[],e[t.measure][t.tick]=e[t.measure][t.tick]||[],e[t.measure][t.tick].push(t),e),[]).reduce((i,e)=>(e.forEach(e=>{e.filter(e=>2===e.noteType).forEach(e=>{var t=2===r?e.lane:0;e.channel&&s[t]&&s[t][e.channel]&&(s[t][e.channel].push(e),i.push(s[t][e.channel]),delete s[t][e.channel])}),e.filter(e=>1===e.noteType).forEach(e=>{var t=2===r?e.lane:0;e.channel&&(s[t]=s[t]||[],s[t][e.channel]=[],s[t][e.channel].push(e))}),e.filter(e=>-1<[3,4,5].indexOf(e.noteType)).forEach(e=>{var t=2===r?e.lane:0;e.channel&&s[t]&&s[t][e.channel]&&s[t][e.channel].push(e)})}),i),[])}function X(e){for(var t in e)R.hasOwnProperty(t)||(R[t]=e[t])}E.getScore=function(e,t=192){const i=e.split("\n").filter(e=>"#"===e.slice(0,1)).map(e=>e.slice(1));var r,n,a,s=i.filter(e=>e.match(/^\d{3}[1-5][0-9a-fA-F][0-9a-zA-Z]?:/)).map(e=>Number(e.slice(0,3))).reduce((e,t)=>t<e?e:t,0)+1,o=function(e,t){const i=W(e,/^\d{3}02:/,0,3);return i[0]=Number.isFinite(i[0])?i[0]:4,Y(i,t)}(i,s);const l=(r=i,n=t,a=o,r.filter(e=>e.match(/^\d{3}[1-5][0-9a-fA-F][0-9a-zA-Z]?:(\s*[0-9a-zA-Z][0-9a-gA-G])+\s*$/)).map(e=>e.split(":",2)).reduce((t,r)=>{const s=r[1].trim().replace(/ /g,""),o=Number(r[0].slice(0,3));return[...Array(s.length/2)].map((e,t)=>{const i={lane:parseInt(r[0].slice(4,5),16),laneType:Number(r[0].slice(3,4)),measure:o,noteType:parseInt(s[2*t],36),tick:Math.round(n*a[o]/(s.length/2)*t),width:parseInt(s[2*t+1],17)};return 6===r[0].length&&(i.channel=r[0].slice(5,6).toUpperCase().charCodeAt(0)),i}).filter(e=>0!==e.width).forEach(e=>t.push(e)),t},[]));return{BEATs:o,BPMs:function(e,t,i=120){const r=W(e,/^BPM\d{2}:/,3,5),s=W(e,/^\d{3}08:/,0,3).map(e=>{if(r[e])return r[e]});return s[0]=Number(s[0])?s[0]:i,Y(s,t)}(i,s,D.getMeta(e).BASEBPM),airActionNotes:F(l,4),airNotes:l.filter(e=>5===e.laneType),holdNotes:F(l,2),measure:s,shortNotes:l.filter(e=>1===e.laneType),slideNotes:F(l,3)}},R=B,Object.defineProperty(R,"__esModule",{value:!0}),X(H),X(E);var U={};H=U,Object.defineProperty(H,"__esModule",{value:!0}),H.FlickDirection=H.CurveType=H.NoteType=void 0,(E=H.NoteType||(H.NoteType={}))[E.Tap=0]="Tap",E[E.Flick=1]="Flick",E[E.SlideStart=2]="SlideStart",E[E.SlideInvisible=3]="SlideInvisible",E[E.SlideVisible=4]="SlideVisible",E[E.SlideEndDefault=5]="SlideEndDefault",E[E.SlideEndFlick=6]="SlideEndFlick",(E=H.CurveType||(H.CurveType={}))[E.None=0]="None",E[E.Linear=1]="Linear",E[E.EaseIn=2]="EaseIn",E[E.EaseOut=3]="EaseOut",E[E.EaseInOut=4]="EaseInOut",E[E.CubicBezier=5]="CubicBezier",(H=H.FlickDirection||(H.FlickDirection={}))[H.Up=0]="Up",H[H.Left=1]="Left",H[H.Right=2]="Right";const z=_["v4"],$=B,{NoteType:V,CurveType:G,FlickDirection:q}=U;function K(e,t){return $.getScore(e,t)}function Z(e,t){return e.measure===t.measure&&e.tick===t.tick&&e.lane===t.lane&&e.width===t.width}function J(e,t,i){var r=function(e,t){if(0===e||0===t)return Math.max(e,t,1);for(;0!==t;){var i=t;t=e%t,e=i}return e}(t%i,i);return[4*e+Math.floor(t/i),t%i/r,t?i/r:1]}var H={convertor:function(e){const a=K(e,480),r=z(),s={timelines:[{id:r,name:"Timeline 1"}],bpms:[{id:z(),timeline:r,beat:[0,0,1],bpm:a.BPMs[0]}],notes:[],slides:[]};return a.slideNotes.forEach(e=>{const n={id:z(),timeline:r,notes:[]};e.forEach((t,e)=>{var i=a.airNotes.findIndex(e=>Z(t,e)),r=a.shortNotes.findIndex(e=>3===e.noteType&&Z(t,e)),s=a.shortNotes.findIndex(e=>Z(t,e));const o={id:z(),type:{1:V.SlideStart,2:V.SlideEndDefault,3:V.SlideVisible,5:V.SlideInvisible}[t.noteType],beat:J(t.measure,t.tick,480),lane:t.lane-2,width:t.width,curve:G.Linear};0===e&&-1!==s&&2===a.shortNotes[s].noteType?(a.shortNotes.splice(s,1),n.critical=!0):o.type===V.SlideEndDefault&&-1!==i?([e]=a.airNotes.splice(i,1),o.type=V.SlideEndFlick,o.direction=3===e.noteType?q.Left:4===e.noteType?q.Right:q.Up,-1!==s&&([e]=a.shortNotes.splice(s,1),2===e.noteType&&(o.critical=!0))):-1!==i&&-1!==s&&(a.shortNotes.splice(s,1),[i]=a.airNotes.splice(i,1),o.curve={2:G.EaseIn,5:G.EaseOut,6:G.EaseOut}[i.noteType]),-1!==r&&o.type===V.SlideVisible&&(a.shortNotes.splice(r,1),delete o.width,delete o.lane,delete o.curve),n.notes.push(o)}),s.slides.push(n)}),a.shortNotes.forEach(t=>{if(!(t.lane<2||13<t.lane)){var e=a.airNotes.find(e=>Z(e,t));const i={id:z(),timeline:r,type:e?V.Flick:V.Tap,beat:J(t.measure,t.tick,480),lane:t.lane-2,width:t.width};2===t.noteType&&(i.critical=!0),e&&(i.direction=3===e.noteType?q.Left:4===e.noteType?q.Right:q.Up),s.notes.push(i)}}),s}}["convertor"],Q=H;var ee,te,ie,re,se;ee="* {\n\tmargin: 0;\n}\n\nhtml, body {\n\twidth: 100%;\n\theight: 100%;\n}\n\nbody {\n\tuser-select: none;\n}\n\n#selector {\n\theight: 100px;\n\tposition: relative;\n}\n\n#app {\n\theight: calc(100% - 105px);\n\t max-width: 600px;\n}\n",re=(te=void 0===te?{}:te).insertAt,ee&&"undefined"!=typeof document&&(ie=document.head||document.getElementsByTagName("head")[0],(te=document.createElement("style")).type="text/css","top"===re&&ie.firstChild?ie.insertBefore(te,ie.firstChild):ie.appendChild(te),te.styleSheet?te.styleSheet.cssText=ee:te.appendChild(document.createTextNode(ee)));class oe{constructor(e){this.editor=e,this._totalTime=10,this._follow=!1,this._playing=!1,this.playTicker=new a.Ticker,this.playTicker.autoStart=!1}async getBuffer(e){const t=await fetch(e);e=await t.arrayBuffer();return this.audioContext.decodeAudioData(e)}loadAudio(e){this.audio=new Audio,this.audioContext=new AudioContext,this.audio.addEventListener("loadeddata",()=>{this.editor.renderer.parseAndRender()}),this.audio.addEventListener("ended",()=>{this._playing=!1}),this.audio.src=URL.createObjectURL(e),this.audioSource=this.audioContext.createMediaElementSource(this.audio),this.audioSource.connect(this.audioContext.destination)}async play(){this.audio&&!this.playing&&(await this.audio.play(),this._playing=!0,this.playTicker.start())}stop(){this.pause(),this.currentTime=0,this.editor.renderer.updateCurrentTimeLine()}pause(){this.playing&&this.audioSource&&(this.audio.pause(),this._playing=!1,this.playTicker.stop())}get currentTime(){return this.audio?.currentTime||0}set currentTime(e){this.audio&&(this.audio.currentTime=e)}get totalTime(){return this.audio?.duration||this._totalTime}set totalTime(e){this._totalTime=e,this.editor.renderer.parseAndRender()}get follow(){return this._follow}set follow(e){this._follow=e,this.editor.renderer.render()}get playing(){return this._playing}}class ne{constructor(e){this.editor=e}getTimeByBeat(t,i){let r=0;var s=this.map.bpms.filter(e=>e.timeline===i);for(let e=0;e<s.length;e++){var o=s[e],n=this.editor.fraction(o.beat);if(t.le(n))break;var a=s[e+1];const l=a?this.editor.fraction(a.beat):null;r+=(a&&t.gt(l)?l:t).minus(n).decimal/o.bpm*60}return r}getHeightByBeat(e,t){return this.editor.const.spaceY+this.getTimeByBeat(e,t)*this.editor.const.heightPerSecond}getHeightByTime(e){return this.editor.const.spaceY+e*this.editor.const.heightPerSecond}getYInCanvas(e){return this.editor.const.height-(e-this.editor.scrollController.scrollBottom)}getLaneX(e){return this.editor.const.width*(6*e+14)/100}getLaneWidth(e){return this.editor.const.width*(6*e)/100}get map(){return this.editor.map}}const ae={background:16777215,primeLane:0,primeLaneAlpha:1,secondaryLane:0,secondaryLaneAlpha:.2,bpmLine:65535,timeText:0,currentTimeLine:16711680,beatLineWhole:0,beatLineWholeAlpha:1,beatLineHalf:0,beatLineHalfAlpha:.2,beatLineThird:16711680,beatLineThirdAlpha:.4,beatLineQuarter:255,beatLineQuarterAlpha:.4,slideCurve:14285551,slideCurveAlpha:.8,slideInvisibleNode:3204520,slideCriticalCurve:16579021,slideCriticalCurveAlpha:.8,slideCriticalInvisibleNode:15852573,selectionBox:233724,selectionBoxAlpha:.2,selectionRect:233724,warningRect:16746496,cursor:0};class le{constructor(e){this.editor=e,this._resolution=window.devicePixelRatio,this._fontSize=18,this._paddingX=4,this._paddingY=2,this._spaceY=200,this._heightPerSecond=500,this._lineWidth=1,this._invisibleLineWidth=3,this._cursorLineWidth=4,this._noteHeight=32,this._arrowHeight=32,this._curveRenderStep=8;var{width:t,height:e}=this.editor.container.getBoundingClientRect();this._width=t,this._height=e}get width(){return this._width}set width(e){this._width=e}get height(){return this._height}set height(e){this._height=e}get maxHeight(){return this.heightPerSecond*this.editor.audioManager.totalTime+2*this.spaceY}get resolution(){return this._resolution}set resolution(e){this._resolution=e}get fontSizeRaw(){return this._fontSize}set fontSizeRaw(e){this._fontSize=e}get fontSize(){return this._fontSize/this.resolution}get paddingXRaw(){return this._paddingX}set paddingXRaw(e){this._paddingX=e}get paddingX(){return this._paddingX/this.resolution}get paddingYRaw(){return this._paddingY}set paddingYRaw(e){this._paddingY=e}get paddingY(){return this._paddingY/this.resolution}get heightPerSecondRaw(){return this._heightPerSecond}set heightPerSecondRaw(e){var t;e<100||2e3<e||(t=(this.editor.scrollController.scrollBottom-this.spaceY)/this._heightPerSecond,this._heightPerSecond=e,this.editor.scrollController.scrollBottom=t*this._heightPerSecond+this.spaceY,this.editor.renderer.parseAndRender())}get heightPerSecond(){return this._heightPerSecond/this.resolution}get spaceYRaw(){return this._spaceY}set spaceYRaw(e){this._spaceY=e}get spaceY(){return this._spaceY/this.resolution}get lineWidthRaw(){return this._lineWidth}set lineWidthRaw(e){this._lineWidth=e}get lineWidth(){return this._lineWidth/this.resolution}get invisibleLineWidthRaw(){return this._invisibleLineWidth}set invisibleLineWidthRaw(e){this._invisibleLineWidth=e}get invisibleLineWidth(){return this._invisibleLineWidth/this.resolution}get cursorLineWidthRaw(){return this._cursorLineWidth}set cursorLineWidthRaw(e){this._cursorLineWidth=e}get cursorLineWidth(){return this._cursorLineWidth/this.resolution}get noteHeightRaw(){return this._noteHeight}set noteHeightRaw(e){this._noteHeight=e}get noteHeight(){return this._noteHeight/this.resolution}get arrowHeightRaw(){return this._arrowHeight}set arrowHeightRaw(e){this._arrowHeight=e}get arrowHeight(){return this._arrowHeight/this.resolution}get curveRenderStepRaw(){return this._curveRenderStep}set curveRenderStepRaw(e){this._curveRenderStep=e}get curveRenderStep(){return this._curveRenderStep/this.resolution}}class he{constructor(e){this.editor=e,this._critical=!1,this._width=3,this._direction=U.FlickDirection.Up,this._type=se.Default,this._curve=U.CurveType.Linear,this._slideHeadPlaced=!1,this._slideCritical=!1,this._flickEnd=!1,this.bpm=120,this.noteObject={id:"CursorNote",name:"CursorNote",x:0,scrollHeight:0,width:0,texture:"tap",alpha:0,rawWidth:0,rawLane:0},this.slideHeadObject={id:"CursorNote",name:"CursorNoteSlideHead",x:0,scrollHeight:0,width:0,texture:"slide",alpha:0,rawWidth:0,rawLane:0},this.arrowObject={id:"CursorNote",name:"CursorNoteArrow",x:0,scrollHeight:0,width:0,alpha:1,texture:"flick_arrow_01"},this.curveObject={id:"CursorNote",slideId:"CursorNoteSlide",name:"CursorNoteCurve",startScrollHeight:0,endScrollHeight:0,alpha:0,color:0,points:[]}}calculateCursorPosition(){var t=this.editor.scrollController.scrollBottom+this.editor.const.height-this.editor.handler.lastMousePosition.y;let i=0,r=this.editor.fraction([0,0,1]);var s=this.editor.beatSlice;for(let e=0;;e++){var o=this.editor.fraction([Math.floor(e/s),e%s,s]),n=this.editor.calculator.getHeightByBeat(o,this.editor.timeLineManager.prime);if(n<t)i=t-n,r=o;else if(t<=n){var a=n-t,n=this.editor.handler.lastMousePosition.x-this.editor.calculator.getLaneX(0),n=Math.floor(n/(.06*this.editor.const.width));const l=a<i?o:r;return void(n==this.positionX&&l.eq(this.positionY)||(this.positionX=n,this.positionY=l,this.editor.event.dispatchCursorMoveEvent()))}}}updateObject(){this.noteObject.alpha=0,this.arrowObject.alpha=0,this.curveObject.alpha=0;var e=this.visible&&![se.Default,se.BPM].includes(this.type);if(this.noteObject.alpha=e?.8:0,this.noteObject.scrollHeight=this.editor.calculator.getHeightByBeat(this.positionY,this.editor.timeLineManager.prime),this.noteObject.texture=this.critical?"critical":{[se.Tap]:"tap",[se.Flick]:"flick",[se.Slide]:"slide"}[this.type]||"tap",this.noteObject.x=this.editor.calculator.getLaneX(this.lane-.1),this.noteObject.width=this.editor.calculator.getLaneWidth(this.width+.2),this.noteObject.rawWidth=this.width,this.noteObject.rawLane=this.lane,this.type===se.Flick||this.type===se.Slide&&this.slideHeadPlaced&&this.flickEnd){const i=Math.min(6,this.width);var t=Math.max(.8,Math.min(4,.6*i));this.arrowObject.x=this.editor.calculator.getLaneX(this.lane+(this.width-t)/2),this.arrowObject.scrollHeight=this.noteObject.scrollHeight,this.arrowObject.width=this.editor.calculator.getLaneWidth(t),this.arrowObject.alpha=e?.8:0,this.arrowObject.texture=`flick_arrow_${this.critical||this.slideHeadPlaced&&this.slideCritical?"critical_":""}${i.toString().padStart(2,"0")}${{0:"",1:"_left",2:"_right"}[this.direction]}`}this.type===se.Slide&&(this.noteObject.texture=this.slideCritical||this.critical&&this.flickEnd?"critical":this.slideHeadPlaced&&this.flickEnd?"flick":"slide",this.slideHeadPlaced&&(t=this.slideHeadObject.scrollHeight>this.noteObject.scrollHeight?this.noteObject:this.slideHeadObject,e=this.slideHeadObject.scrollHeight>this.noteObject.scrollHeight?this.slideHeadObject:this.noteObject,this.curveObject.startScrollHeight=t.scrollHeight,this.curveObject.endScrollHeight=e.scrollHeight,this.curveObject.alpha=.8*(this.slideCritical?this.editor.color.slideCriticalCurveAlpha:this.editor.color.slideCurveAlpha),this.curveObject.color=this.slideCritical?this.editor.color.slideCriticalCurve:this.editor.color.slideCurve,this.curveObject.points=[...this.editor.parser.getCurvePoints(this.editor.calculator.getLaneX(t.rawLane+.1),t.scrollHeight,this.editor.calculator.getLaneX(e.rawLane+.1),e.scrollHeight,this.editor.parser.bezier[this.curve]),...this.editor.parser.getCurvePoints(this.editor.calculator.getLaneX(t.rawLane+t.rawWidth-.1),t.scrollHeight,this.editor.calculator.getLaneX(e.rawLane+e.rawWidth-.1),e.scrollHeight,this.editor.parser.bezier[this.curve]).reverse()])),this.editor.renderer.render()}placeSlideHead(){this.type===se.Slide&&(this.slideHeadObject.x=this.editor.calculator.getLaneX(this.lane-.1),this.slideHeadObject.scrollHeight=this.editor.calculator.getHeightByBeat(this.positionY,this.editor.timeLineManager.prime),this.slideHeadObject.width=this.editor.calculator.getLaneWidth(this.width+.2),this.slideHeadObject.texture=this.critical?"critical":"slide",this.slideHeadObject.alpha=1,this.slideHeadObject.rawWidth=this.width,this.slideHeadObject.rawLane=this.lane,this._slideCritical=this.critical,this._slideHeadPlaced=!0,this.slideHeadBeat=[this.positionY.integer,this.positionY.numerator,this.positionY.denominator])}endSlidePlacement(){this.type!==se.Slide&&!this.slideHeadPlaced||(this._slideHeadPlaced=!1,this.critical=this.slideCritical,this._slideCritical=!1,this.slideHeadObject.alpha=0,this.updateObject())}get type(){return this._type}set type(e){this._type=e,this.type===se.Default&&e!==this._type&&this.editor.selectionManager.emptySelection(),this.endSlidePlacement(),this.editor.renderer.cursor.lineColor=this.type===se.BPM?this.editor.color.bpmLine:this.editor.color.cursor,this.updateObject()}get width(){return this._width}set width(e){this._width=Math.max(1,Math.min(12,e)),this.updateObject()}get critical(){return this._critical}set critical(e){this._critical=e,this.updateObject()}get direction(){return this._direction}set direction(e){this._direction=e,this.updateObject()}get curve(){return this._curve}set curve(e){this._curve=e,this.updateObject()}get flickEnd(){return this._flickEnd}set flickEnd(e){this._flickEnd=e,this.updateObject()}get slideHeadPlaced(){return this._slideHeadPlaced}get slideCritical(){return this._slideCritical}get lane(){return Math.min(12-this.width,Math.max(0,this.positionX-Math.floor(this.width/2)))}get visible(){return 0<=this.positionX&&this.positionX<=11}}(_=se=se||{})[_.Default=0]="Default",_[_.Tap=1]="Tap",_[_.Flick=2]="Flick",_[_.Slide=3]="Slide",_[_.BPM=4]="BPM";var ce={},B={},H={};Object.defineProperty(H,"__esModule",{value:!0}),H.DenominatorZeroError=void 0;class de extends Error{constructor(e){super(),this.name="DenominatorZeroError",this.message=`Denominator cannot be zero: [${e.toString()}]`}}H.DenominatorZeroError=de,Object.defineProperty(B,"__esModule",{value:!0}),B.Fraction=void 0;const ue=ce,pe=H;B.Fraction=class De{constructor(e){if(0===e[3])throw new pe.DenominatorZeroError(e);this.frac=e}static fromInteger(e){return new De([e/Math.abs(e),Math.abs(e),0,1])}eq(e){var t=this.simplified,e=e.simplified;return t.sign===e.sign&&t.integer===e.integer&&t.numerator===e.numerator&&t.denominator===e.denominator}gt(e){return 0<this.sign&&e.sign<0||(0<this.sign&&0<e.sign?this.integer>e.integer||this.integer===e.integer&&(this.denominator===e.denominator?this.numerator>e.numerator:this.reduceToCommonDenominator(e).numerator>e.reduceToCommonDenominator(this).numerator):!this.opposite.gt(e.opposite))}ge(e){return this.gt(e)||this.eq(e)}lt(e){return!this.ge(e)}le(e){return!this.gt(e)}add(e){if(this.sign!==e.sign)return this.sign<0?e.minus(this.opposite):this.minus(e.opposite);var t=this.reduceToCommonDenominator(e),e=e.reduceToCommonDenominator(this);return new De([this.sign,t.integer+e.integer,t.numerator+e.numerator,this.denominator])}minus(e){if(this.sign===-e.sign)return this.add(e.opposite);if(0<this.sign){if(this.ge(e)){var t=this.reduceToCommonDenominator(e).improper,i=e.reduceToCommonDenominator(this).improper;return new De([this.sign,0,t.numerator-i.numerator,t.denominator]).simplified}return e.minus(this).opposite}return this.opposite.minus(e.opposite).opposite}reduceToCommonDenominator(e){if(this.denominator===e.denominator)return this.copy;var t=this.simplified,e=e.simplified,e=ue.MathUtils.lcm(t.denominator,e.denominator);return new De([t.sign,t.integer,t.numerator*(e/t.denominator),e])}get improper(){const e=this.copy;return e.numerator+=e.integer*e.denominator,e.integer=0,e}get simplified(){const e=this.copy;var t;return e.integer<0&&(e.integer=-e.integer,e.sign=-e.sign),e.numerator<0&&(e.numerator=-e.numerator,e.sign=-e.sign),e.denominator<0&&(e.denominator=-e.denominator,e.sign=-e.sign),1!==(t=ue.MathUtils.gcd(e.numerator,e.denominator))&&(e.numerator=e.numerator/t,e.denominator=e.denominator/t),e.numerator>=e.denominator&&(t=Math.floor(e.numerator/e.denominator),e.numerator-=t*e.denominator,e.integer+=t),e}get decimal(){return this.sign*(this.integer+this.numerator/this.denominator)}get fraction(){return[...this.frac]}set fraction(e){this.frac=e}get opposite(){return new De([-this.sign,this.integer,this.numerator,this.denominator])}get abs(){return new De([1,this.integer,this.numerator,this.denominator])}get copy(){return new De([this.sign,this.integer,this.numerator,this.denominator])}get sign(){return this.frac[0]}set sign(e){this.frac[0]=e}get integer(){return this.frac[1]}set integer(e){this.frac[1]=e}get numerator(){return this.frac[2]}set numerator(e){this.frac[2]=e}get denominator(){return this.frac[3]}set denominator(e){this.frac[3]=e}};var ge,me,_={};Object.defineProperty(_,"__esModule",{value:!0}),_.MathUtils=void 0;class ve{static gcd(e,t){if(0===e||0===t)return Math.max(e+t,1);for(;0!==t;){var i=t;t=e%t,e=i}return e}static lcm(e,t){return Math.abs(e*t)/ve.gcd(e,t)}}_.MathUtils=ve,H=ce,ge=r&&r.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){e[r=void 0===r?i:r]=t[i]}),r=r&&r.__exportStar||function(e,t){for(var i in e)"default"===i||Object.prototype.hasOwnProperty.call(t,i)||ge(t,e,i)},Object.defineProperty(H,"__esModule",{value:!0}),r(B,H),r(_,H);class fe extends a.utils.EventEmitter{constructor(e){super(),this.editor=e}dispatchScrollEvent(e,t){this.emit(me.Scroll,{oldScrollBottom:e,newScrollBottom:t})}dispatchSelectEvent(){var e=JSON.parse(JSON.stringify(this.editor.selectionManager.selection));this.editor.selectionManager.isSelectionEqual(this.editor.selectionManager.oldSelection,e)||(this.editor.event.emit(me.Select,{oldSelection:this.editor.selectionManager.oldSelection,newSelection:e}),this.editor.selectionManager.oldSelection=JSON.parse(JSON.stringify(e)))}dispatchAudioTimeUpdateEvent(){this.emit(me.AudioTimeUpdate,{currentTime:this.editor.audioManager.currentTime})}dispatchCursorMoveEvent(){this.emit(me.CursorMove,{positionX:this.editor.cursorManager.positionX,positionY:this.editor.cursorManager.positionY})}dispatchDestroyEvent(){this.emit(me.Destroy)}}(H=me=me||{}).Scroll="scroll",H.Destroy="destroy",H.Select="select",H.AudioTimeUpdate="audioTimeUpdate",H.CursorMove="cursorMove";class be{constructor(e){this.editor=e,this.cursorMoved=!1,this.lastMousePosition={x:0,y:0},this.windowMouseUpHandler=this._windowMouseUpHandler.bind(this),this.stageMouseMoveWhenMouseDownHandler=this._stageMouseMoveWhenMouseDownHandler.bind(this)}listen(){this.editor.renderer.app.view.addEventListener("wheel",this.mouseWheelHandler.bind(this)),this.editor.renderer.app.stage.on("mousedown",this.stageMouseDownHandler.bind(this)),this.editor.renderer.app.stage.on("mousemove",this.stageMouseMoveHandler.bind(this)),this.editor.renderer.app.stage.on("click",this.stageClickHandler.bind(this)),this.scrollController.scrollTicker.add(this.scrollTickerHandler.bind(this)),this.editor.audioManager.playTicker.add(this.audioPlayTickerHandler.bind(this)),this.editor.event.on(me.Scroll,()=>{this.editor.cursorManager.calculateCursorPosition();var e=this.editor.cursorManager.positionY,t=this.editor.cursorManager.positionX;this.editor.renderer.updateCursorPosition(e,t)}),this.editor.event.on(me.CursorMove,()=>{this.editor.cursorManager.updateObject()})}mouseWheelHandler(e){e=Math.min(this.editor.const.maxHeight-this.editor.const.height,Math.max(0,this.editor.scrollController.scrollBottom-e.deltaY/this.editor.const.resolution));this.editor.scrollController.scrollTo(e)}stageMouseDownHandler(e){var t;0===e.data.button&&this.editor.cursorManager.type===se.Default&&(e.data.originalEvent.ctrlKey||this.editor.selectionManager.emptySelection(),e=(t=e.data.global).x,t=this.editor.scrollController.scrollBottom+(this.editor.const.height-t.y),this.editor.selectionManager.selectionBox=[e,t,e,t],this.editor.renderer.app.stage.on("mousemove",this.stageMouseMoveWhenMouseDownHandler),this.editor.event.on(me.Scroll,this.stageMouseMoveWhenMouseDownHandler),this.editor.renderer.render(),window.addEventListener("mouseup",this.windowMouseUpHandler))}_stageMouseMoveWhenMouseDownHandler(){var e=this.lastMousePosition;this.selectionManager.selectionBox[2]=e.x,this.selectionManager.selectionBox[3]=this.scrollController.scrollBottom+(this.editor.const.height-e.y),(this.selectionManager.selectionBox[2]-this.selectionManager.selectionBox[0]||this.selectionManager.selectionBox[3]-this.selectionManager.selectionBox[1])&&(this.cursorMoved=!0);var t=this.editor.const.height/20,i=this.editor.const.height-t;e.y<t||e.y>i?(this.scrollController.scrollTicker.started||this.scrollController.scrollTicker.start(),this.scrollController.autoScrollDelta=((e.y<t?t:i)-e.y)/(t/10)):(this.scrollController.autoScrollDelta=0,this.scrollController.scrollTicker.stop()),this.editor.selectionManager.findSelectedNote(),this.editor.renderer.render()}_windowMouseUpHandler(){this.cursorMoved=!1,window.removeEventListener("mouseup",this.windowMouseUpHandler),this.selectionManager.selectionBox=[0,0,0,0],this.editor.renderer.app.stage.off("mousemove",this.stageMouseMoveWhenMouseDownHandler),this.editor.event.off(me.Scroll,this.stageMouseMoveWhenMouseDownHandler),this.scrollController.autoScrollDelta=0,this.scrollController.scrollTicker.stop(),this.selectionManager.mergeTempSelection(),this.editor.event.dispatchSelectEvent(),this.editor.renderer.render()}stageMouseMoveHandler(e){var t;this.lastMousePosition.x=e.data.global.x,this.lastMousePosition.y=e.data.global.y,this.editor.map&&(this.editor.cursorManager.calculateCursorPosition(),t=this.editor.cursorManager.positionY,e=this.editor.cursorManager.positionX,this.editor.renderer.updateCursorPosition(t,e))}stageClickHandler(){if(!this.cursorMoved&&this.editor.cursorManager.visible){if(this.editor.cursorManager.type!==se.Default){const s={id:x(),beat:[this.editor.cursorManager.positionY.integer,this.editor.cursorManager.positionY.numerator,this.editor.cursorManager.positionY.denominator],lane:this.editor.cursorManager.lane,timeline:this.editor.timeLineManager.prime,width:this.editor.cursorManager.width};switch(this.editor.cursorManager.type){case se.Tap:this.editor.map.notes.push({...s,type:U.NoteType.Tap,critical:this.editor.cursorManager.critical});break;case se.Flick:this.editor.map.notes.push({...s,type:U.NoteType.Flick,direction:this.editor.cursorManager.direction,critical:this.editor.cursorManager.critical});break;case se.Slide:if(this.editor.cursorManager.slideHeadPlaced){let e=this.editor.cursorManager.slideHeadObject,t=this.editor.cursorManager.noteObject,i=this.editor.cursorManager.slideHeadBeat,r=[this.editor.cursorManager.positionY.integer,this.editor.cursorManager.positionY.numerator,this.editor.cursorManager.positionY.denominator];if(e.scrollHeight===t.scrollHeight)return;e.scrollHeight>t.scrollHeight&&([e,t]=[t,e],[i,r]=[r,i]);const o={id:x(),type:this.editor.cursorManager.flickEnd?U.NoteType.SlideEndFlick:U.NoteType.SlideEndDefault,beat:r,lane:t.rawLane,width:t.rawWidth,curve:U.CurveType.None};this.editor.cursorManager.flickEnd&&(o.direction=this.editor.cursorManager.direction,this.editor.cursorManager.critical&&(o.critical=!0));const n={id:s.id,timeline:this.editor.timeLineManager.prime,notes:[{id:x(),type:U.NoteType.SlideStart,beat:i,lane:e.rawLane,width:e.rawWidth,curve:this.editor.cursorManager.curve},o]};this.editor.cursorManager.slideCritical&&(n.critical=!0),this.editor.map.slides.push(n),this.editor.cursorManager.endSlidePlacement()}else this.editor.cursorManager.placeSlideHead();break;case se.BPM:var e=this.editor.map.bpms.findIndex(e=>e.timeline===s.timeline&&this.editor.fraction(e.beat).eq(this.editor.fraction(s.beat))),t={id:s.id,timeline:s.timeline,beat:s.beat,bpm:this.editor.cursorManager.bpm};-1!==e?this.editor.map.bpms[e]=t:this.editor.map.bpms.push(t),this.editor.sortMap()}}this.editor.renderer.parseAndRender()}}scrollTickerHandler(){this.editor.scrollController.scrollTo(this.editor.scrollController.scrollBottom+this.editor.scrollController.autoScrollDelta)}audioPlayTickerHandler(){var e;this.editor.event.dispatchAudioTimeUpdateEvent(),this.editor.audioManager.follow?(e=this.editor.calculator.getHeightByTime(this.editor.audioManager.currentTime),this.editor.scrollController.scrollBottom=e-this.editor.const.spaceY):this.editor.renderer.updateCurrentTimeLine()}get selectionManager(){return this.editor.selectionManager}get scrollController(){return this.editor.scrollController}}var we=4,ye=1e-7,Me=10,Ce="function"==typeof Float32Array;function Se(e,t){return 1-3*t+3*e}function Le(e,t,i){return((Se(t,i)*e+(3*i-6*t))*e+3*t)*e}function Te(e,t,i){return 3*Se(t,i)*e*e+2*(3*i-6*t)*e+3*t}function He(e){return e}function xe(o,t,n,i){if(!(0<=o&&o<=1&&0<=n&&n<=1))throw new Error("bezier x values must be in [0, 1] range");if(o===t&&n===i)return He;for(var a=new(Ce?Float32Array:Array)(11),e=0;e<11;++e)a[e]=Le(.1*e,o,n);function r(e){for(var t=0,i=1;10!==i&&a[i]<=e;++i)t+=.1;var r=t+.1*((e-a[--i])/(a[i+1]-a[i])),s=Te(r,o,n);return.001<=s?function(e,t,i,r){for(var s=0;s<we;++s){var o=Te(t,i,r);if(0===o)return t;t-=(Le(t,i,r)-e)/o}return t}(e,r,o,n):0===s?r:function(e,t,i,r,s){for(var o,n,a=0;0<(o=Le(n=t+(i-t)/2,r,s)-e)?i=n:t=n,Math.abs(o)>ye&&++a<Me;);return n}(e,t,t+.1,o,n)}return function(e){return 0===e?0:1===e?1:Le(r(e),t,i)}}class Oe{constructor(e){this.editor=e,this.bezier=[!1,[0,0,1,1],[.11,0,.5,0],[.5,1,.89,1],[.45,0,.55,1]],this.initRenderObjects()}initRenderObjects(){this.renderObjects={lanes:[],beatLines:[],texts:[],notes:[],curves:[],arrows:[],visibleNodes:[],invisibleNodes:[]}}parse(){0!==this.map?.bpms.length&&(this.initRenderObjects(),this.addLanes(),0<this.map?.timelines.length&&0<this.map?.bpms.length&&(this.parseCursor(),this.parseBeatLines(),this.parseBPMLines(),this.addTimeText(),this.parseNotes(),this.parseSlide()))}parseCursor(){this.renderObjects.notes.push(this.editor.cursorManager.noteObject),this.renderObjects.notes.push(this.editor.cursorManager.slideHeadObject),this.renderObjects.arrows.push(this.editor.cursorManager.arrowObject),this.renderObjects.curves.push(this.editor.cursorManager.curveObject)}addLanes(){for(let e=0;e<=12;e++)this.renderObjects.lanes.push({name:`Lane-${e}`,x:this.editor.const.width*((6*e+14)/100),color:e%2?this.editor.color.secondaryLane:this.editor.color.primeLane,alpha:e%2?this.editor.color.secondaryLaneAlpha:this.editor.color.primeLaneAlpha})}parseBeatLines(){var t=this.editor.beatSlice;for(let e=0;;e++){var i=this.editor.fraction([Math.floor(e/t),e%t,t]),r=this.editor.calculator.getTimeByBeat(i,this.editor.timeLineManager.prime),r=this.editor.calculator.getHeightByTime(r);if(r>this.editor.const.maxHeight-this.editor.const.spaceY)break;const s={name:`BeatLine-${i.decimal}`,x:this.editor.calculator.getLaneX(0),width:this.editor.calculator.getLaneWidth(12),scrollHeight:r,color:0,alpha:0};if(e%t==0)s.color=this.editor.color.beatLineWhole,s.alpha=this.editor.color.beatLineWholeAlpha,s.width=this.editor.const.width-this.editor.calculator.getLaneX(0),this.renderObjects.texts.push({name:`BeatLineText-${i.decimal}`,x:this.editor.const.width-this.editor.const.paddingX,fontSize:this.editor.const.fontSize,scrollHeight:r+this.editor.const.paddingY,alignX:"right",alignY:"bottom",color:this.editor.color.beatLineWhole,alpha:this.editor.color.beatLineWholeAlpha,text:`${Math.floor(i.integer/4)+1}:${i.integer%4+1}`});else if(e%(t/2)==0)s.color=this.editor.color.beatLineHalf,s.alpha=this.editor.color.beatLineHalfAlpha;else if(e%(t/3)==0)s.color=this.editor.color.beatLineThird,s.alpha=this.editor.color.beatLineThirdAlpha;else{if(e%(t/4)!=0)continue;s.color=this.editor.color.beatLineQuarter,s.alpha=this.editor.color.beatLineQuarterAlpha}this.renderObjects.beatLines.push(s)}}formatTime(e){return`${Math.floor(e/60).toString().padStart(2,"0")}:${(e%60).toFixed(3).padStart(6,"0")}`}parseBPMLines(){var t=this.map.bpms.filter(e=>e.timeline===this.editor.timeLineManager.prime);for(let e=0;e<t.length;e++){const s=t[e];var i=this.editor.calculator.getTimeByBeat(this.editor.fraction(s.beat),this.editor.timeLineManager.prime),r=this.editor.calculator.getHeightByTime(i);this.renderObjects.beatLines.push({name:`BPM-${s.id}-line`,x:0,width:this.editor.const.width,scrollHeight:r,color:this.editor.color.bpmLine,alpha:1}),this.renderObjects.texts.push({name:`BPM-${s.id}-time`,x:this.editor.const.paddingX,scrollHeight:r+this.editor.const.paddingY,alignY:"bottom",fontSize:this.editor.const.fontSize,color:this.editor.color.bpmLine,alpha:1,text:this.formatTime(i)}),this.renderObjects.texts.push({name:`BPM-${s.id}-value`,x:this.editor.calculator.getLaneX(12)+this.editor.const.paddingX,scrollHeight:r+this.editor.const.paddingY,alignY:"bottom",fontSize:this.editor.const.fontSize,color:this.editor.color.bpmLine,alpha:1,text:s.bpm.toString()})}}addTimeText(){for(let e=0;e<=this.editor.audioManager.totalTime;e++){var t=this.editor.calculator.getHeightByTime(e);const i=this.formatTime(e);this.renderObjects.texts.some(e=>e.text===i)||this.renderObjects.texts.push({name:`Time-${e}`,x:this.editor.calculator.getLaneX(0)-this.editor.const.paddingX,scrollHeight:t,alignX:"right",alignY:"middle",fontSize:this.editor.const.fontSize,color:this.editor.color.timeText,alpha:1,text:i})}}pushFlickObject(e,t,i=!1){const r=Math.min(6,e.width);var s=Math.max(.8,Math.min(4,.6*r));this.renderObjects.arrows.push({name:`Arrow-${e.id}`,x:this.editor.calculator.getLaneX(e.lane+(e.width-s)/2),width:this.editor.calculator.getLaneWidth(s),scrollHeight:t,texture:`flick_arrow_${e.critical||i?"critical_":""}${r.toString().padStart(2,"0")}${{0:"",1:"_left",2:"_right"}[e.direction]}`,alpha:1,id:e.id})}parseNotes(){var t=this.map.notes.filter(e=>this.editor.timeLineManager.visible.includes(e.timeline));for(let e=0;e<t.length;e++){var i=t[e],r=this.editor.calculator.getHeightByBeat(this.editor.fraction(i.beat),i.timeline);i.type===U.NoteType.Flick&&this.pushFlickObject(i,r),this.renderObjects.notes.push({name:`Note-${i.id}`,x:this.editor.calculator.getLaneX(i.lane-.1),width:this.editor.calculator.getLaneWidth(i.width+.2),scrollHeight:r,texture:i.critical?"critical":i.type?"flick":"tap",id:i.id,alpha:1,rawLane:i.lane,rawWidth:i.width})}}parseUnPositionedNote(t,i,r){var s=t.notes[i],o=t.notes[r],n=this.editor.calculator.getHeightByBeat(this.editor.fraction(s.beat),t.timeline),a=this.editor.calculator.getHeightByBeat(this.editor.fraction(o.beat),t.timeline),l=[...this.bezier,s.bezier][s.curve];const h=l&&xe(l[0],l[1],l[2],l[3]);for(let e=i+1;e<r;e++){var c=t.notes[e],d=this.editor.calculator.getHeightByBeat(this.editor.fraction(t.notes[e].beat),t.timeline),u=(d-n)/(a-n),p=l?s.lane+(o.lane-s.lane)*h(u):s.lane,u=l?s.width+(o.width-s.width)*h(u):s.width;this.renderObjects.visibleNodes.push({name:`Visible-${c.id}`,x:this.editor.calculator.getLaneX(p),width:this.editor.calculator.getLaneWidth(u),scrollHeight:d,texture:`slide_node${t.critical?"_critical":""}`,id:c.id,slideId:t.id})}}parseSlide(){var t=this.map.slides.filter(e=>this.editor.timeLineManager.visible.includes(e.timeline));for(let e=0;e<t.length;e++){const n=t[e];for(let i=0;i<n.notes.length;i++){var r,s=n.notes[i],o=this.editor.calculator.getHeightByBeat(this.editor.fraction(s.beat),n.timeline);[U.NoteType.SlideStart,U.NoteType.SlideEndDefault].includes(s.type)?this.renderObjects.notes.push({name:`SlideNote-${s.id}`,x:this.editor.calculator.getLaneX(s.lane-.1),width:this.editor.calculator.getLaneWidth(s.width+.2),scrollHeight:o,texture:n.critical?"critical":"slide",id:s.id,slideId:n.id,alpha:1,rawLane:s.lane,rawWidth:s.width}):s.type===U.NoteType.SlideEndFlick?(this.renderObjects.notes.push({name:`SlideEndFlick-${s.id}`,x:this.editor.calculator.getLaneX(s.lane-.1),width:this.editor.calculator.getLaneWidth(s.width+.2),scrollHeight:o,texture:s.critical||n.critical?"critical":"flick",id:s.id,slideId:n.id,alpha:1,rawLane:s.lane,rawWidth:s.width}),this.pushFlickObject(s,o,n.critical)):s.type===U.NoteType.SlideInvisible?this.renderObjects.invisibleNodes.push({name:`Invisible-${s.id}`,x:this.editor.calculator.getLaneX(s.lane+.1),width:this.editor.calculator.getLaneWidth(s.width-.2),scrollHeight:o,color:n.critical?this.editor.color.slideCriticalInvisibleNode:this.editor.color.slideInvisibleNode,id:s.id,slideId:n.id}):s.type===U.NoteType.SlideVisible&&this.renderObjects.visibleNodes.push({name:`Visible-${s.id}`,x:this.editor.calculator.getLaneX(s.lane),width:this.editor.calculator.getLaneWidth(s.width),scrollHeight:o,texture:`slide_node${n.critical?"_critical":""}`,id:s.id,slideId:n.id});let e=n.notes[i+1];if(void 0===e)break;void 0===e.lane&&(r=n.notes.findIndex((e,t)=>t>i&&void 0!==e.lane),e=n.notes[r],this.parseUnPositionedNote(n,i,r),i=r-1),this.renderObjects.curves.push({name:`Curve-${s.id}`,startScrollHeight:o,endScrollHeight:this.editor.calculator.getHeightByBeat(this.editor.fraction(e.beat),n.timeline),points:[...this.getCurvePoints(this.editor.calculator.getLaneX(s.lane+.1),o,this.editor.calculator.getLaneX(e.lane+.1),this.editor.calculator.getHeightByBeat(this.editor.fraction(e.beat),n.timeline),[...this.bezier,s.bezier][s.curve]),...this.getCurvePoints(this.editor.calculator.getLaneX(s.lane+s.width-.1),o,this.editor.calculator.getLaneX(e.lane+e.width-.1),this.editor.calculator.getHeightByBeat(this.editor.fraction(e.beat),n.timeline),[...this.bezier,s.bezier][s.curve]).reverse()],color:n.critical?this.editor.color.slideCriticalCurve:this.editor.color.slideCurve,alpha:n.critical?this.editor.color.slideCriticalCurveAlpha:this.editor.color.slideCurveAlpha,id:s.id,slideId:n.id})}}}getCurvePoints(i,r,e,s,t){if(!t)return[{x:i,scrollHeight:r},{x:i,scrollHeight:s}];const o=this.editor.const.curveRenderStep;var n=Math.ceil((s-r)/o);const a=xe(t[0],t[1],t[2],t[3]),l=e-i,h=s-r;return new Array(n+1).fill(0).map((e,t)=>{t=Math.min(1,t*o/(s-r));return{x:i+a(t)*l,scrollHeight:r+t*h}})}get map(){return this.editor.map}}class Ee extends e.NineSlicePlane{constructor(e,t,i){super(e,91,0,91,0),this.id=t,this.slideId=i,this.interactive=!0}}class _e extends e.Sprite{constructor(e,t,i){super(e),this.id=t,this.slideId=i,this.interactive=!0}}class Be extends e.NineSlicePlane{constructor(e,t){super(e,91,0,91,0),this.id=t,this.interactive=!0}}class ke extends e.Container{constructor(e,t,i,r){super(),this.lineWidth=e,this.cursorWidth=t,this._lineColor=i,this.textures=r,this.name="Cursor",this.drawCursor()}drawCursor(){this.cursorX=new e.Graphics,this.cursorX.lineStyle(this.lineWidth,this._lineColor),this.cursorX.moveTo(0,0),this.cursorX.lineTo(this.cursorWidth,0),this.addChild(this.cursorX),this.cursorY=new e.Graphics,this.cursorY.lineStyle(this.lineWidth,this._lineColor),this.cursorY.moveTo(0,0),this.cursorY.lineTo(0,this.cursorWidth),this.cursorY.x=this.cursorWidth/2,this.cursorY.y=-this.cursorWidth/2,this.addChild(this.cursorY)}set lineColor(e){this.removeChild(this.cursorX,this.cursorY),this.cursorX.destroy(!0),this.cursorY.destroy(!0),this._lineColor=e,this.drawCursor()}}class je{constructor(e){this.editor=e,this.textures=a.Loader.shared.resources["images/sprite.json"].textures;var{width:t,height:e}=this.editor.const;this.app=new a.Application({backgroundAlpha:0,width:t,height:e,antialias:!0,resolution:this.editor.const.resolution}),this.app.view.style.width=t+"px",this.app.view.style.height=e+"px",this.editor.container.appendChild(this.app.view),this.app.stage.sortableChildren=!0,this.app.stage.interactive=!0,this.cursor=new ke(this.editor.const.cursorLineWidth,this.editor.calculator.getLaneWidth(1.2),this.editor.color.cursor,this.textures),this.cursor.visible=!1,this.cursor.zIndex=15,this.app.stage.addChild(this.cursor),this.containers={lane:null,time:null,note:null,slide:null,arrow:null,selection:null},this.initContainers(),this.initLaneContainer()}initLaneContainer(){this.containers.lane=new a.Container,this.containers.lane.name="Lane",this.app.stage.addChild(this.containers.lane)}updateColorTheme(){}parseAndRender(){this.editor.parser.parse(),this.render()}render(){this.destroyContainers(),this.initContainers(),this.renderBeatLines(),this.renderTexts(),this.renderNotes(),this.renderArrows(),this.renderCurves(),this.renderVisibleNodes(),this.renderInvisibleNodes(),this.renderSelectionBox(),this.updateCurrentTimeLine()}renderOnce(){this.renderBackground(),this.renderLanes(),this.renderCurrentTimeLine()}renderBackground(){this.background=new a.Graphics,this.background.name="Background",this.background.zIndex=-1,this.background.interactive=!0,this.background.beginFill(this.editor.color.background,1),this.background.drawRect(0,0,this.editor.const.width,this.editor.const.height),this.background.endFill(),this.app.stage.addChild(this.background)}renderSelectionBox(){var e=this.editor.selectionManager.selectionBox;if(e[0]!==e[2]&&e[1]!==e[3]){const r=new a.Graphics;r.beginFill(this.editor.color.selectionBox,this.editor.color.selectionBoxAlpha),r.lineStyle(this.editor.const.lineWidth,this.editor.color.selectionBox);var t=this.editor.calculator.getYInCanvas(e[1]),i=this.editor.calculator.getYInCanvas(e[3])-t;r.drawRect(e[0],t,e[2]-e[0],i),r.endFill(),this.containers.selection.addChild(r)}}renderSelectionRect(e,t,i,r,s,o=this.editor.color.selectionRect){const n=new a.Graphics;n.name=e,n.lineStyle(4*this.editor.const.lineWidth,o),n.drawRect(t,i,r,s),this.containers.selection.addChild(n)}renderLanes(){for(let e=0;e<this.renderObjects.lanes.length;e++){var t=this.renderObjects.lanes[e];const i=new a.Graphics;i.name=t.name,i.lineStyle(this.editor.const.lineWidth,t.color,t.alpha),i.moveTo(0,0),i.lineTo(0,this.editor.const.height),i.x=t.x,this.containers.lane.addChild(i)}}renderBeatLines(){var t=this.renderObjects.beatLines.filter(e=>e.scrollHeight>=this.editor.scrollController.scrollBottom-this.editor.const.noteHeight&&e.scrollHeight<=this.editor.scrollController.scrollBottom+this.editor.const.height+this.editor.const.noteHeight);for(let e=0;e<t.length;e++){var i=t[e];const r=new a.Graphics;r.name=i.name,r.lineStyle(this.editor.const.lineWidth,i.color,i.alpha),r.moveTo(i.x,0),r.lineTo(i.x+i.width,0),r.y=this.editor.calculator.getYInCanvas(i.scrollHeight),this.containers.time.addChild(r)}}renderCurrentTimeLine(){this.currentTimeLine=new a.Graphics,this.currentTimeLine.name="CurrentTime-line",this.currentTimeLine.lineStyle(this.editor.const.lineWidth,this.editor.color.currentTimeLine,1),this.currentTimeLine.moveTo(0,0),this.currentTimeLine.lineTo(.8*this.editor.const.width,0),this.currentTimeLine.x=.1*this.editor.const.width,this.currentTimeLine.y=this.editor.calculator.getYInCanvas(0),this.currentTimeLine.zIndex=5,this.app.stage.addChild(this.currentTimeLine)}renderTexts(){var t=this.renderObjects.texts.filter(e=>e.scrollHeight>=this.editor.scrollController.scrollBottom&&e.scrollHeight<=this.editor.scrollController.scrollBottom+this.editor.const.height+this.editor.const.fontSize);for(let e=0;e<t.length;e++){var i=t[e];const r=new a.Text(i.text,{fontSize:i.fontSize,fill:i.color});r.name=i.name,r.x=i.x-{left:0,center:.5,right:1}[i.alignX||"left"]*r.width,r.y=this.editor.calculator.getYInCanvas(i.scrollHeight)-{top:0,middle:.5,bottom:1}[i.alignY||"bottom"]*r.height,this.containers.time.addChild(r)}}renderNotes(){const t=this.renderObjects.notes.filter(e=>e.scrollHeight>=this.editor.scrollController.scrollBottom-this.editor.const.noteHeight&&e.scrollHeight<=this.editor.scrollController.scrollBottom+this.editor.const.height+this.editor.const.noteHeight);for(let e=0;e<t.length;e++){const r=t[e],s=void 0===r.slideId?new Be(this.textures[r.texture],r.id):new Ee(this.textures[r.texture],r.id,r.slideId);s.name=r.name;var i=this.editor.const.noteHeight/s.height;s.scale.set(i),s.x=r.x,s.y=this.editor.calculator.getYInCanvas(r.scrollHeight)-this.editor.const.noteHeight/2,s.width=r.width/i,s.alpha=r.alpha,t.some(e=>e.id!==r.id&&"CursorNote"!==e.id&&"CursorNote"!==r.id&&e.rawLane<=r.rawLane&&e.rawWidth>=r.rawWidth&&e.rawLane+e.rawWidth>=r.rawLane+r.rawWidth&&e.scrollHeight===r.scrollHeight)&&this.renderSelectionRect(`WarningRect-${r.id}`,s.x,s.y,r.width,this.editor.const.noteHeight,this.editor.color.warningRect),"CursorNote"!==r.id&&(this.editor.selectionManager.selection.single.includes(r.id)||this.editor.selectionManager.tempSelection.single.includes(r.id)||this.editor.selectionManager.selection.slide[r.slideId]?.includes(r.id)||this.editor.selectionManager.tempSelection.slide[r.slideId]?.includes(r.id))&&this.renderSelectionRect(`SelectionRect-${r.id}`,s.x,s.y,r.width,this.editor.const.noteHeight),this.containers.note.addChild(s)}}renderArrows(){var t=this.renderObjects.arrows.filter(e=>e.scrollHeight>=this.editor.scrollController.scrollBottom-this.editor.const.arrowHeight&&e.scrollHeight<=this.editor.scrollController.scrollBottom+this.editor.const.height+this.editor.const.arrowHeight);for(let e=0;e<t.length;e++){var i=t[e];const o=new a.Sprite(this.textures[i.texture]);o.name=i.name;var r=i.width/o.width,s=o.height*r;o.alpha=i.alpha,o.scale.set(r),o.x=i.x,o.y=this.editor.calculator.getYInCanvas(i.scrollHeight)-s,this.containers.arrow.addChild(o)}}renderCurves(){var t=this.renderObjects.curves.filter(e=>e.startScrollHeight<=this.editor.scrollController.scrollBottom+this.editor.const.height&&e.endScrollHeight>=this.editor.scrollController.scrollBottom);for(let e=0;e<t.length;e++){var i=t[e];if(!(i.points.length<2)){const r=new a.Graphics;r.name=i.name,r.beginFill(i.color,i.alpha),r.moveTo(i.points[0].x,this.editor.calculator.getYInCanvas(i.points[0].scrollHeight));for(let e=1;e<i.points.length;e++)r.lineTo(i.points[e].x,this.editor.calculator.getYInCanvas(i.points[e].scrollHeight));r.endFill(),this.containers.slide.addChild(r)}}}renderVisibleNodes(){var t=this.renderObjects.visibleNodes.filter(e=>e.scrollHeight>=this.editor.scrollController.scrollBottom-this.editor.const.noteHeight&&e.scrollHeight<=this.editor.scrollController.scrollBottom+this.editor.const.height+this.editor.const.noteHeight);for(let e=0;e<t.length;e++){var i=t[e];const s=new _e(this.textures[i.texture],i.id,i.slideId);s.name=i.name;var r=this.editor.const.noteHeight/s.height;s.scale.set(r),s.x=i.x+(i.width-s.width)/2,s.y=this.editor.calculator.getYInCanvas(i.scrollHeight)-s.height/2,this.containers.slide.addChild(s),(this.editor.selectionManager.selection.slide[i.slideId]?.includes(i.id)||this.editor.selectionManager.tempSelection.slide[i.slideId]?.includes(i.id))&&(r=this.editor.calculator.getLaneWidth(.1),this.renderSelectionRect(`SelectionRect-${i.id}`,i.x-r,s.y,i.width+2*r,this.editor.const.noteHeight))}}renderInvisibleNodes(){var t=this.renderObjects.invisibleNodes.filter(e=>e.scrollHeight>=this.editor.scrollController.scrollBottom-this.editor.const.noteHeight&&e.scrollHeight<=this.editor.scrollController.scrollBottom+this.editor.const.height+this.editor.const.noteHeight);for(let e=0;e<t.length;e++){var i,r,s=t[e];const o=new a.Graphics;o.name=s.name,o.lineStyle(this.editor.const.invisibleLineWidth,s.color,1),o.moveTo(s.x,0),o.lineTo(s.x+s.width,0),o.y=this.editor.calculator.getYInCanvas(s.scrollHeight),this.containers.slide.addChild(o),(this.editor.selectionManager.selection.slide[s.slideId]?.includes(s.id)||this.editor.selectionManager.tempSelection.slide[s.slideId]?.includes(s.id))&&(i=this.editor.const.noteHeight,r=this.editor.calculator.getLaneWidth(.2),this.renderSelectionRect(`SelectionRect-${s.id}`,s.x-r,o.y-i/2,s.width+2*r,i))}}updateCursorPosition(e,t){e=this.editor.calculator.getHeightByBeat(e,this.editor.timeLineManager.prime);e>this.editor.const.maxHeight-this.editor.const.spaceY||t<0||11<t?this.cursor.visible=!1:(this.cursor.x=this.editor.calculator.getLaneX(t-.1),this.cursor.y=this.editor.calculator.getYInCanvas(e),this.cursor.visible=!0)}updateCurrentTimeLine(){var e,t;this.currentTimeLine&&(t=(e=this.editor.calculator.getHeightByTime(this.editor.audioManager.currentTime))>=this.editor.scrollController.scrollBottom&&e<=this.editor.scrollController.scrollBottom+this.editor.const.height,(this.currentTimeLine.visible=t)&&(this.currentTimeLine.y=this.editor.calculator.getYInCanvas(e)))}initContainers(){this.containers.time=new a.Container,this.containers.note=new a.Container,this.containers.slide=new a.Container,this.containers.arrow=new a.Container,this.containers.selection=new a.Container,this.containers.time.name="Time",this.containers.note.name="Note",this.containers.slide.name="Slide",this.containers.arrow.name="Arrow",this.containers.selection.name="Selection",this.containers.time.zIndex=1,this.containers.arrow.zIndex=2,this.containers.slide.zIndex=3,this.containers.note.zIndex=4,this.containers.selection.zIndex=6,this.app.stage.addChild(this.containers.time),this.app.stage.addChild(this.containers.note),this.app.stage.addChild(this.containers.slide),this.app.stage.addChild(this.containers.arrow),this.app.stage.addChild(this.containers.selection)}destroyContainers(){["time","note","slide","arrow","selection"].forEach(e=>{this.containers[e].destroy({children:!0})})}get renderObjects(){return this.editor.parser.renderObjects}}class Ie{constructor(e){this.editor=e,this._scrollBottom=0,this.scrollTicker=new a.Ticker,this.autoScrollDelta=0,this.scrollTicker.autoStart=!1}scrollTo(e){this.editor.audioManager.follow&&(this.editor.audioManager.currentTime=e/this.editor.const.heightPerSecond),this.scrollBottom=e}get scrollBottom(){return this._scrollBottom}set scrollBottom(e){var t=Math.min(this.editor.const.maxHeight-this.editor.const.height,Math.max(0,e));t!==this.scrollBottom&&(e=this._scrollBottom,this._scrollBottom=t,this.editor.event.dispatchScrollEvent(e,this._scrollBottom)),this.editor.renderer.render()}}class Ne{constructor(){this._prime="",this._visible=[]}get prime(){return this._prime}set prime(e){this._prime=e}get visible(){return this._visible}set visible(e){(1===(this._visible=e).length||1<e.length&&!e.includes(this.prime))&&(this.prime=e[0])}}class Ae{constructor(e){this.editor=e,this.selection={single:[],slide:{}},this.tempSelection={single:[],slide:{}},this.oldSelection={single:[],slide:{}},this.selectionBox=[0,0,0,0]}emptySelection(){this.selection.single=[],this.selection.slide={}}isUniqueArrayEqual(e,t){return e.length===t.length&&e.every(e=>t.includes(e))}isSelectionEqual(t,i){if(!this.isUniqueArrayEqual(t.single,i.single))return!1;const e=Object.keys(t.slide);var r=Object.keys(i.slide);return!!this.isUniqueArrayEqual(e,r)&&e.every(e=>this.isUniqueArrayEqual(t.slide[e],i.slide[e]))}mergeTempSelection(){this.selection.single.push(...this.tempSelection.single);for(const t in this.tempSelection.slide){var e;Object.prototype.hasOwnProperty.call(this.tempSelection.slide,t)&&(e=this.tempSelection.slide[t],this.selection.slide[t]||(this.selection.slide[t]=[]),this.selection.slide[t].push(...e))}this.tempSelection.single=[],this.tempSelection.slide={}}findSelectedNote(){const r=Math.min(this.selectionBox[1],this.selectionBox[3]),s=Math.max(this.selectionBox[1],this.selectionBox[3]),o=Math.min(this.selectionBox[0],this.selectionBox[2]),n=Math.max(this.selectionBox[0],this.selectionBox[2]);this.tempSelection.single=[],this.tempSelection.slide={};var e=t=>{for(let e=0;e<t.length;e++){var i=t[e];i.scrollHeight>=r&&i.scrollHeight<=s&&i.x>=o&&i.x+i.width<=n&&(void 0===i.slideId||this.selection.slide[i.slideId]?.includes(i.id)?this.selection.single.includes(i.id)||this.tempSelection.single.push(i.id):(this.tempSelection.slide[i.slideId]||(this.tempSelection.slide[i.slideId]=[]),this.tempSelection.slide[i.slideId].push(i.id)))}},t=this.editor.parser.renderObjects;e(t.notes),e(t.visibleNodes),e(t.invisibleNodes)}getNotesBySelection(i){return{single:i.single.map(t=>this.editor.map.notes.find(e=>e.id===t)),slide:Object.keys(i.slide).map(t=>{const e=this.editor.map.slides.find(e=>e.id===t);return{...e,notes:e.notes.filter(e=>i.slide[t].includes(e.id))}})}}}class Pe{constructor(e){this.container=e,this._beatSlice=1,this._color=ae,this.const=new le(this),this.event=new fe(this),this.handler=new be(this),this.parser=new Oe(this),this.calculator=new ne(this),this.scrollController=new Ie(this),this.audioManager=new oe(this),this.renderer=new je(this),this.timeLineManager=new Ne,this.selectionManager=new Ae(this),this.cursorManager=new he(this),this.start()}start(){this.handler.listen(),this.renderer.parseAndRender(),this.renderer.renderOnce()}destroy(){this.event.dispatchDestroyEvent(),this.renderer.destroyContainers(),this.renderer.app.destroy(!0,{children:!0})}static loadResource(i,r){return new Promise(e=>{const t=a.Loader.shared;t.add("images/sprite.json").load(()=>{console.log("load resources completed"),e()}),i&&t.onLoad.add(i),r&&t.onError.add(r)})}sortMap(){this.map&&this.map.bpms.sort((e,t)=>this.fraction(e.beat).minus(this.fraction(t.beat)).decimal)}set map(e){this._map=e,this.timeLineManager.visible.some(e=>this.map.timelines.map(e=>e.id).includes(e))||(this.timeLineManager.visible=[this.map.timelines[0].id]),this.renderer.parseAndRender()}get map(){return this._map}set beatSlice(e){this._beatSlice=e,this.renderer.parseAndRender()}get beatSlice(){return this._beatSlice}get color(){return this._color}set color(e){this._color=e,this.renderer.updateColorTheme(),this.renderer.parseAndRender()}fraction(e){return new ce.Fraction([1,...e])}}function Re(e){return document.querySelector(e)}document.addEventListener("DOMContentLoaded",async function(){console.log("ready"),await Pe.loadResource((e,t)=>{console.log(`${e.progress}% loading: ${t.url}`)});const i=new Pe(Re("#app"));console.log(i);const r=e=>{i.map=e,i.beatSlice=1,i.audioManager.totalTime=180,i.scrollController.scrollTo(0)},s=Re("#id"),o=Re("#diff");Re("#load").addEventListener("click",async()=>{const e=await fetch(`https://assets.pjsek.ai/file/pjsekai-assets/startapp/music/music_score/${s.value.padStart(4,"0")}_01/${o.value}`);var t=Q(await e.text());r(t)});const t=Re("#container"),n=Re("#text");Re("#input").addEventListener("click",()=>{t.style.display="none"===t.style.display?"block":"none"}),Re("#draw").addEventListener("click",()=>{var e;t.style.display="none",n.value&&(e=Q(n.value),r(e))});const e=e=>{i.const.heightPerSecondRaw*=e};Re("#add").addEventListener("click",()=>{e(1.5)}),Re("#minus").addEventListener("click",()=>{e(1/1.5)});const a=Re("#bottom");i.event.on(me.Scroll,e=>{a.value=e.newScrollBottom.toString()}),Re("#scroll").addEventListener("click",()=>{i.scrollController.scrollTo(parseInt(a.value))}),Re("#slice").addEventListener("change",function(){i.beatSlice=parseInt(this.value)}),Re("#music").addEventListener("input",function(){var e=this.files[0];i.audioManager.loadAudio(e)}),Re("#play").addEventListener("click",()=>{i.audioManager.play()}),Re("#pause").addEventListener("click",()=>{i.audioManager.pause()}),Re("#stop").addEventListener("click",()=>{i.audioManager.stop()}),Re("#follow").addEventListener("input",function(){i.audioManager.follow=this.checked}),Re("#delete").addEventListener("click",()=>{console.log(i.selectionManager.getNotesBySelection(i.selectionManager.selection))});var l=e=>()=>{i.cursorManager.type=e};Re("#note-default").addEventListener("click",l(se.Default)),Re("#note-tap").addEventListener("click",l(se.Tap)),Re("#note-flick").addEventListener("click",l(se.Flick)),Re("#note-slide").addEventListener("click",l(se.Slide)),Re("#note-bpm").addEventListener("click",l(se.BPM)),document.addEventListener("keydown",e=>{switch(e.key){case"1":i.cursorManager.type=se.Default;break;case"2":i.cursorManager.type=se.Tap;break;case"3":i.cursorManager.type=se.Flick;break;case"4":i.cursorManager.type=se.Slide;break;case"b":var t=parseInt(prompt("Please enter the BPM value:","120"));if(isNaN(t))return;i.cursorManager.bpm=t,i.cursorManager.type=se.BPM;break;case"q":i.cursorManager.width--;break;case"e":i.cursorManager.width++;break;case"c":i.cursorManager.critical=!i.cursorManager.critical;break;case"r":(i.cursorManager.type===se.Flick||i.cursorManager.type===se.Slide&&i.cursorManager.slideHeadPlaced&&i.cursorManager.flickEnd)&&(i.cursorManager.direction={[U.FlickDirection.Up]:U.FlickDirection.Right,[U.FlickDirection.Right]:U.FlickDirection.Left,[U.FlickDirection.Left]:U.FlickDirection.Up}[i.cursorManager.direction]);break;case"v":i.cursorManager.type===se.Slide&&i.cursorManager.slideHeadPlaced&&(i.cursorManager.curve={[U.CurveType.Linear]:U.CurveType.EaseIn,[U.CurveType.EaseIn]:U.CurveType.EaseOut,[U.CurveType.EaseOut]:U.CurveType.Linear}[i.cursorManager.curve]);break;case"f":i.cursorManager.type===se.Slide&&i.cursorManager.slideHeadPlaced&&(i.cursorManager.flickEnd=!i.cursorManager.flickEnd);break;case"Escape":i.cursorManager.type===se.Slide&&i.cursorManager.slideHeadPlaced&&i.cursorManager.endSlidePlacement()}});const h=await fetch("map/test.json"),c=await h.json();r(c)})}(PIXI);
