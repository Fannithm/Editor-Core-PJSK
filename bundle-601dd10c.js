!function(e){"use strict";function t(i){if(i&&i.__esModule)return i;var n=Object.create(null);return i&&Object.keys(i).forEach(function(e){var t;"default"!==e&&(t=Object.getOwnPropertyDescriptor(i,e),Object.defineProperty(n,e,t.get?t:{enumerable:!0,get:function(){return i[e]}}))}),n.default=i,Object.freeze(n)}var u,c=t(e);function i(i){if(i.__esModule)return i;var n=Object.defineProperty({},"__esModule",{value:!0});return Object.keys(i).forEach(function(e){var t=Object.getOwnPropertyDescriptor(i,e);Object.defineProperty(n,e,t.get?t:{enumerable:!0,get:function(){return i[e]}})}),n}(Y=$=$||{}).BLUE="blue",Y.GREEN="green",Y.YELLOW="yellow",Y.RED="red",Y.PURPLE="purple",Y.PINK="pink",($=u=u||{})[$.Tap=0]="Tap",$[$.Flick=1]="Flick",$[$.SlideStart=2]="SlideStart",$[$.SlideInvisible=3]="SlideInvisible",$[$.SlideVisible=4]="SlideVisible",$[$.SlideEndDefault=5]="SlideEndDefault",$[$.SlideEndFlick=6]="SlideEndFlick",(Y=U=U||{})[Y.None=0]="None",Y[Y.Linear=1]="Linear",Y[Y.EaseIn=2]="EaseIn",Y[Y.EaseOut=3]="EaseOut",Y[Y.EaseInOut=4]="EaseInOut",Y[Y.CubicBezier=5]="CubicBezier",($=X=X||{})[$.Up=0]="Up",$[$.Left=1]="Left",$[$.Right=2]="Right";var l=4,h=1e-7,d=10,s="function"==typeof Float32Array;function n(e,t){return 1-3*t+3*e}function r(e,t){return 3*t-6*e}function p(e,t,i){return((n(t,i)*e+r(t,i))*e+3*t)*e}function m(e,t,i){return 3*n(t,i)*e*e+2*r(t,i)*e+3*t}function g(e){return e}function f(r,t,a,i){if(!(0<=r&&r<=1&&0<=a&&a<=1))throw new Error("bezier x values must be in [0, 1] range");if(r===t&&a===i)return g;for(var o=new(s?Float32Array:Array)(11),e=0;e<11;++e)o[e]=p(.1*e,r,a);function n(e){for(var t=0,i=1;10!==i&&o[i]<=e;++i)t+=.1;var n=t+.1*((e-o[--i])/(o[i+1]-o[i])),s=m(n,r,a);return.001<=s?function(e,t,i,n){for(var s=0;s<l;++s){var r=m(t,i,n);if(0===r)return t;t-=(p(t,i,n)-e)/r}return t}(e,n,r,a):0===s?n:function(e,t,i,n,s){for(var r,a,o=0;0<(r=p(a=t+(i-t)/2,n,s)-e)?i=a:t=a,Math.abs(r)>h&&++o<d;);return a}(e,t,t+.1,r,a)}return function(e){return 0===e?0:1===e?1:p(n(e),t,i)}}var a,o;class v extends e.NineSlicePlane{constructor(e,t){super(e,91,0,91,0),this.interactive=!0,this.id=t.id}}class y{constructor(e,t,i){this.scrollBottom=0,this.colors={background:16777215,lane:0,bpm:65535,beat:{third:16711680,half:0,quarter:255},slide:14285551,slideNote:3204520,critical:16579021,criticalNote:15852573,selection:233724},this.beatLine={third:!1,half:!0,quarter:!0};var{width:n,height:s}=e.getBoundingClientRect(),r=window.devicePixelRatio;this.resolution=r,this.setMap(t),this.app=new c.Application({backgroundAlpha:0,width:n,height:s,antialias:!0,resolution:r}),this.const={resolution:r,fontSize:18/r,heightPerSecond:3200/r,spaceY:200/r,width:n,height:s,paddingX:4/r,paddingY:2/r,lineWidth:1/r,noteHeight:32/r,arrowHeight:32/r,maxHeight:0},this.const.maxHeight=this.const.heightPerSecond*i+2*this.const.spaceY,this.container={lane:new c.Container,time:new c.Container,note:new c.Container,slide:new c.Container,arrow:new c.Container,selection:new c.Container},this.scrollBottom/=r,this.app.view.style.width=n+"px",this.app.view.style.height=s+"px",e.appendChild(this.app.view),this.app.stage.addChild(this.container.lane),this.app.stage.sortableChildren=!0,this.app.stage.interactive=!0,this.container.lane.name="Lane",this.notes=c.Loader.shared.resources["images/sprite.json"].textures,this.event=new EventTarget,this.selection={single:[],slide:{}},this.selectionBox=[0,0,0,0],this.scrollTicker=new c.Ticker,this.scrollTicker.autoStart=!1,this.scrollTicker.add(this.scrollTickerHandler.bind(this)),this.start()}start(){const i=new c.Graphics;i.name="SelectArea",i.beginFill(this.colors.background,.5),i.drawRect(0,0,this.const.width,this.const.height),i.zIndex=-1,i.interactive=!0,i.endFill(),this.app.stage.addChild(i),this.drawLane(),this.reRender(),this.app.view.addEventListener("wheel",e=>{e=Math.min(this.const.maxHeight,Math.max(0,this.scrollBottom-e.deltaY/this.resolution));this.scrollTo(e)});const n=this.selectAreaMoveHandler.bind(this),s=this.selectAndScrollHandler.bind(this);i.on("mousedown",e=>{e.data.originalEvent.ctrlKey||(this.selection={single:[],slide:{}});var t=e.data.global,e=t.x,t=this.scrollBottom+(this.const.height-t.y);this.selectionBox=[e,t,e,t],i.on("mousemove",n),this.event.addEventListener(a.SCROLL,s),this.reRender()}),window.addEventListener("mouseup",()=>{this.selectionBox=[0,0,0,0],i.removeListener("mousemove",n),this.event.removeEventListener(a.SCROLL,s),this.autoScrollDelta=0,this.scrollTicker.stop(),this.reRender()})}selectAreaMoveHandler(e){var t=e.data.global;this.selectionBox[2]=t.x,this.selectionBox[3]=this.scrollBottom+(this.const.height-t.y);var i=this.const.height/20,e=this.const.height-i;t.y<i||t.y>e?(this.scrollTicker.started||this.scrollTicker.start(),this.autoScrollDelta=((t.y<i?i:e)-t.y)/(i/10)):(this.autoScrollDelta=0,this.scrollTicker.stop()),this.reRender()}selectAndScrollHandler(e){this.selectionBox[3]+=e.detail.scrollBottom-e.detail.oldScrollBottom}scrollTickerHandler(){this.scrollTo(this.scrollBottom+this.autoScrollDelta)}scrollTo(e){const t={oldScrollBottom:this.scrollBottom,scrollBottom:0};this.scrollBottom=Math.min(this.const.maxHeight,Math.max(0,e)),t.scrollBottom=this.scrollBottom,this.event.dispatchEvent(new CustomEvent("scroll",{detail:t})),this.reRender()}reRender(){this.container.time.destroy({children:!0}),this.container.note.destroy({children:!0}),this.container.slide.destroy({children:!0}),this.container.arrow.destroy({children:!0}),this.container.selection.destroy({children:!0}),this.container.time=new c.Container,this.container.note=new c.Container,this.container.slide=new c.Container,this.container.arrow=new c.Container,this.container.selection=new c.Container,this.container.time.name="Time",this.container.note.name="Note",this.container.slide.name="Slide",this.container.arrow.name="Arrow",this.container.selection.name="Selection",this.container.time.zIndex=5,this.container.arrow.zIndex=7,this.container.slide.zIndex=8,this.container.note.zIndex=9,this.container.selection.zIndex=10,this.app.stage.addChild(this.container.time),this.app.stage.addChild(this.container.note),this.app.stage.addChild(this.container.slide),this.app.stage.addChild(this.container.arrow),this.app.stage.addChild(this.container.selection),this.drawBeat(),this.drawBPM(),this.drawNote(),this.drawSlide(),this.drawSelectionBox()}destroy(){this.app.destroy(!0,{children:!0})}static loadResource(i,n){return new Promise(e=>{const t=c.Loader.shared;t.add("images/sprite.json").load(()=>{console.log("load resources completed"),e()}),i&&t.onLoad.add(i),n&&t.onError.add(n)})}minusBeat(e,t){return this.fractionToDecimal(e)-this.fractionToDecimal(t)}getTimeByBeat(t){let i=0;for(let e=0;e<this.map.bpms.length;e++){var n=this.map.bpms[e];if(this.minusBeat(t,n.beat)<=0)break;var s=this.map.bpms[e+1];i+=(s&&0<this.minusBeat(t,s.beat)?this.minusBeat(s.beat,n.beat):this.minusBeat(t,n.beat))/n.bpm*60}return i}getHeightByBeat(e){return this.const.spaceY+this.getTimeByBeat(e)*this.const.heightPerSecond}getHeightByTime(e){return this.const.spaceY+e*this.const.heightPerSecond}formatTime(e){return`${Math.floor(e/60)}:${(e%60).toFixed(3).padStart(6,"0")}`}getYInCanvas(e){return this.const.height-(e-this.scrollBottom)}getLaneX(e){return this.const.width*(6*e+14)/100}fractionToDecimal(e){return e[0]+e[1]/e[2]}drawSelectionBox(){var e=this.selectionBox;if(e[0]!==e[2]&&e[1]!==e[3]){const n=new c.Graphics;n.beginFill(this.colors.selection,.2),n.lineStyle(this.const.lineWidth,this.colors.selection);var t=this.getYInCanvas(e[1]),i=this.getYInCanvas(e[3])-t;n.drawRect(e[0],t,e[2]-e[0],i),n.endFill(),this.container.selection.addChild(n)}}drawBPM(){for(let e=0;e<this.map.bpms.length;e++){const n=this.map.bpms[e];var t=this.getTimeByBeat(n.beat),i=this.getHeightByTime(t);if(i>=this.scrollBottom&&i<=this.scrollBottom+this.const.height){const s=new c.Graphics;s.name=`BPM-${n.id}-line`,s.lineStyle(this.const.lineWidth,this.colors.bpm,1),s.moveTo(0,0),s.lineTo(this.const.width,0),s.y=this.getYInCanvas(i);const r=new c.Text(this.formatTime(t),{fontSize:this.const.fontSize,fill:this.colors.bpm,align:"left"});r.name=`BPM-${n.id}-time`,r.x=this.const.paddingX,r.y=this.getYInCanvas(i)-r.height-this.const.paddingY;const a=new c.Text(n.bpm.toString(),{fontSize:this.const.fontSize,fill:this.colors.bpm,align:"left"});a.name=`BPM-${n.id}-value`,a.x=this.getLaneX(12)+this.const.paddingX,a.y=this.getYInCanvas(i)-a.height-this.const.paddingY,this.container.time.addChild(s),this.container.time.addChild(r),this.container.time.addChild(a)}else if(i>this.scrollBottom+this.const.height)break}}drawBeatLine(e,t,i,n,s=!1){const r=new c.Graphics;var a=this.fractionToDecimal(e);if(r.name=`Beat-${a}-line`,r.lineStyle(this.const.lineWidth,t,i),r.moveTo(this.getLaneX(0),0),r.lineTo(s?this.const.width:this.getLaneX(12),0),r.y=this.getYInCanvas(n),s){const o=new c.Text(`${e[0]+1}:${e[1]/12+1}`,{fontSize:this.const.fontSize,fill:t,align:"left"});o.name=`Beat-${a}-beat`,o.x=this.const.width-o.width-this.const.paddingX,o.y=this.getYInCanvas(n)-o.height-this.const.paddingY,this.container.time.addChild(o)}this.container.time.addChild(r)}drawBeat(){this.container.time.destroy({children:!0}),this.container.time=new c.Container;for(let e=0;;e++){var t=[Math.floor(e/48),e%48,48],i=this.getTimeByBeat(t),i=this.getHeightByTime(i);if(i-this.const.height>this.const.maxHeight-this.const.spaceY)break;if(i>=this.scrollBottom&&i<=this.scrollBottom+this.const.height)e%12==0?this.drawBeatLine(t,this.colors.beat.half,1,i,!0):e%6==0&&this.beatLine.half?this.drawBeatLine(t,this.colors.beat.half,.2,i):e%4==0&&this.beatLine.third?this.drawBeatLine(t,this.colors.beat.third,.4,i):e%3==0&&this.beatLine.quarter&&this.drawBeatLine(t,this.colors.beat.quarter,.4,i);else if(i>this.scrollBottom+this.const.height)break}this.app.stage.addChild(this.container.time)}drawLane(){for(let e=0;e<=12;e++){const i=new c.Graphics;i.name=`Lane-${e}`;var t=this.const.width*((6*e+14)/100);i.lineStyle(this.const.lineWidth,this.colors.lane,e%2?.2:1),i.moveTo(0,0),i.lineTo(0,this.const.height),i.x=t,this.container.lane.addChild(i)}}nineSliceNote(e){return new c.NineSlicePlane(e,91,0,91,0)}drawBaseNote(e,t,i,n){const s=t?new v(this.notes[i],e):this.nineSliceNote(this.notes[i]);s.name=`Note-${i}-${e.id}`;i=this.const.noteHeight/s.height;s.scale.set(i),s.x=this.getLaneX(e.lane)-.006*this.const.width,s.y=this.getYInCanvas(n)-this.const.noteHeight/2,s.width=.06*(e.width+.2)*this.const.width/i,s.on("click",this.singleClickHandler.bind(this)),this.container.note.addChild(s)}singleClickHandler(e){var t=e.target.id;e.data.originalEvent.ctrlKey?-1===(e=this.selection.single.indexOf(t))?this.selection.single.push(t):this.selection.single.splice(e,1):this.selection.single=[t],this.reRender()}drawFlickArrow(e,t){const i=Math.min(6,e.width);var n=`flick_arrow_${e.critical?"critical_":""}${i.toString().padStart(2,"0")}${{0:"",1:"_left",2:"_right"}[e.direction]}`;const s=new c.Sprite(this.notes[n]);s.name=`Arrow-${e.id}`;var r=.8*i*.06*this.const.width/s.width,n=s.height*r;s.scale.set(r),s.x=this.getLaneX(e.lane+(e.width-i)/2+.1*i),s.y=this.getYInCanvas(t)-n,this.container.arrow.addChild(s)}drawCurve(e,t,i,n,s=!1){const r=new c.Graphics;r.name=`Curve-${e.id}`;var a,o,l=[!1,[0,0,1,1],[1,.5,1,1],[0,0,0,.5],[.42,0,.58,1],e.bezier][e.curve];l&&(o=[this.getLaneX(e.lane+.1),this.getYInCanvas(i)],a=[this.getLaneX(t.lane+.1),this.getYInCanvas(n)],r.beginFill(s?this.colors.critical:this.colors.slide,.8),r.moveTo(o[0],o[1]),r.bezierCurveTo(o[0]+l[0]*(a[0]-o[0]),o[1]+l[1]*(a[1]-o[1]),o[0]+l[2]*(a[0]-o[0]),o[1]+l[3]*(a[1]-o[1]),a[0],a[1]),r.lineTo(this.getLaneX(t.lane+t.width-.1),this.getYInCanvas(n)),a=[this.getLaneX(e.lane+e.width-.1),this.getYInCanvas(i)],o=[this.getLaneX(t.lane+t.width-.1),this.getYInCanvas(n)],[e,i,t,n]=l,l=[1-t,1-n,1-e,1-i],r.bezierCurveTo(o[0]+l[0]*(a[0]-o[0]),o[1]+l[1]*(a[1]-o[1]),o[0]+l[2]*(a[0]-o[0]),o[1]+l[3]*(a[1]-o[1]),a[0],a[1]),r.endFill()),this.container.slide.addChild(r)}drawInvisibleNote(e,t,i=!1){const n=new c.Graphics;n.name=`Invisible-${e.id}`,n.lineStyle(3*this.const.lineWidth,i?this.colors.criticalNote:this.colors.slideNote,1),n.moveTo(this.getLaneX(e.lane+.1),0),n.lineTo(this.getLaneX(e.lane+e.width-.1),0),n.y=this.getYInCanvas(t),this.container.slide.addChild(n)}drawVisibleNote(e,t,i=!1){const n=new c.Sprite(this.notes[`slide_node${i?"_critical":""}`]);n.name=`Visible-${e.id}`,void 0!==e.lane&&(i=this.const.noteHeight/n.height,n.scale.set(i),n.x=this.getLaneX(e.lane+e.width/2)-n.width/2,n.y=this.getYInCanvas(t)-n.height/2,this.container.slide.addChild(n))}drawSkippedVisibleNote(t,i,n,s){var r=this.getHeightByBeat(i.beat),a=t.notes[s],o=this.getHeightByBeat(a.beat),e=[!1,[0,0,1,1],[0,0,0,.5],[1,.5,1,1],[1,.5,0,.5],i.bezier][i.curve];const l=e&&f(e[0],e[1],e[2],e[3]);for(let e=n;e<s;e++){var c=t.notes[e],h=this.getHeightByBeat(c.beat);if(h>=this.scrollBottom-this.const.noteHeight&&h<=this.scrollBottom+this.const.height+this.const.noteHeight){var d=(h-r)/(o-r);this.drawVisibleNote({id:c.id,type:u.SlideVisible,beat:c.beat,width:i.width+(a.width-i.width)*l(d),lane:i.lane+(a.lane-i.lane)*l(d)},h,t.critical)}else if(h>this.scrollBottom+this.const.height+this.const.noteHeight)break}}drawSlide(){for(let e=0;e<this.map.slides.length;e++){const o=this.map.slides[e];if(this.getHeightByBeat(o.notes[0].beat)>this.scrollBottom+this.const.height+this.const.noteHeight)return;for(let i=0;i<o.notes.length;i++){var n,s=o.notes[i],r=o.notes[i+1],a=this.getHeightByBeat(s.beat);let e=r,t=i;r&&void 0===r.lane&&(t=i+1+o.notes.slice(i+1).findIndex(e=>void 0!==e.lane),e=o.notes[t]),void 0!==s.lane&&e&&this.getHeightByBeat(s.beat)<this.scrollBottom+this.const.height+this.const.noteHeight&&this.getHeightByBeat(e.beat)>this.scrollBottom-this.const.noteHeight&&(n=this.getHeightByBeat(e.beat),this.drawCurve(s,e,a,n,o.critical),void 0===r.lane&&this.drawSkippedVisibleNote(o,s,i+1,t)),a>=this.scrollBottom-this.const.noteHeight&&a<=this.scrollBottom+this.const.height+this.const.noteHeight&&([u.SlideStart,u.SlideEndDefault].includes(s.type)?this.drawBaseNote(s,!1,o.critical?"critical":"slide",a):s.type===u.SlideEndFlick?(this.drawBaseNote(s,!1,s.critical||o.critical?"critical":"flick",a),this.drawFlickArrow({...s,critical:s?.critical||o.critical},a)):s.type===u.SlideInvisible?this.drawInvisibleNote(s,a,o.critical):s.type===u.SlideVisible&&this.drawVisibleNote(s,a,o.critical))}}}drawSingleSelection(e,t){const i=new c.Graphics;i.lineStyle(4*this.const.lineWidth,this.colors.selection),i.drawRect(this.getLaneX(e.lane)-this.const.paddingX,this.getYInCanvas(t)-this.const.noteHeight/2,.06*this.const.width*e.width+2*this.const.paddingX,this.const.noteHeight),this.container.note.addChild(i)}drawNote(){for(let e=0;e<this.map.notes.length;e++){var t=this.map.notes[e],i=this.getHeightByBeat(t.beat);if(i>=this.scrollBottom-this.const.noteHeight&&i<=this.scrollBottom+this.const.height+this.const.noteHeight&&(t.type===u.Flick&&this.drawFlickArrow(t,i),this.drawBaseNote(t,!0,t.critical?"critical":t.type?"flick":"tap",i),this.selection.single.includes(t.id)&&this.drawSingleSelection(t,i)),i>this.scrollBottom+this.const.height+this.const.noteHeight)break}}setMap(e){this.map=e,this.map.bpms=this.map.bpms.sort((e,t)=>this.minusBeat(e.beat,t.beat)),this.map.notes=this.map.notes.sort((e,t)=>this.minusBeat(e.beat,t.beat)),this.map.slides=this.map.slides.map(e=>({...e,notes:e.notes.sort((e,t)=>this.minusBeat(e.beat,t.beat))})).sort((e,t)=>this.minusBeat(e.notes[0].beat,t.notes[0].beat)),console.log(this.map)}}(a=a||{}).SCROLL="scroll";var w=new Uint8Array(16);function b(){if(!o&&!(o="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return o(w)}var E=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function B(e){return"string"==typeof e&&E.test(e)}for(var T,S,I=[],C=0;C<256;++C)I.push((C+256).toString(16).substr(1));function L(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,t=(I[e[t+0]]+I[e[t+1]]+I[e[t+2]]+I[e[t+3]]+"-"+I[e[t+4]]+I[e[t+5]]+"-"+I[e[t+6]]+I[e[t+7]]+"-"+I[e[t+8]]+I[e[t+9]]+"-"+I[e[t+10]]+I[e[t+11]]+I[e[t+12]]+I[e[t+13]]+I[e[t+14]]+I[e[t+15]]).toLowerCase();if(!B(t))throw TypeError("Stringified UUID is invalid");return t}var N=0,k=0;function A(e){if(!B(e))throw TypeError("Invalid UUID");var t,i=new Uint8Array(16);return i[0]=(t=parseInt(e.slice(0,8),16))>>>24,i[1]=t>>>16&255,i[2]=t>>>8&255,i[3]=255&t,i[4]=(t=parseInt(e.slice(9,13),16))>>>8,i[5]=255&t,i[6]=(t=parseInt(e.slice(14,18),16))>>>8,i[7]=255&t,i[8]=(t=parseInt(e.slice(19,23),16))>>>8,i[9]=255&t,i[10]=(t=parseInt(e.slice(24,36),16))/1099511627776&255,i[11]=t/4294967296&255,i[12]=t>>>24&255,i[13]=t>>>16&255,i[14]=t>>>8&255,i[15]=255&t,i}function O(e,a,o){function t(e,t,i,n){if("string"==typeof e&&(e=function(e){e=unescape(encodeURIComponent(e));for(var t=[],i=0;i<e.length;++i)t.push(e.charCodeAt(i));return t}(e)),16!==(t="string"==typeof t?A(t):t).length)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");var s=new Uint8Array(16+e.length);if(s.set(t),s.set(e,t.length),(s=o(s))[6]=15&s[6]|a,s[8]=63&s[8]|128,i){n=n||0;for(var r=0;r<16;++r)i[n+r]=s[r];return i}return L(s)}try{t.name=e}catch(e){}return t.DNS="6ba7b810-9dad-11d1-80b4-00c04fd430c8",t.URL="6ba7b811-9dad-11d1-80b4-00c04fd430c8",t}function x(e){return 14+(e+64>>>9<<4)+1}function R(e,t){var i=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(i>>16)<<16|65535&i}function F(e,t,i,n,s,r){return R((r=R(R(t,e),R(n,r)))<<s|r>>>32-s,i)}function D(e,t,i,n,s,r,a){return F(t&i|~t&n,e,t,s,r,a)}function M(e,t,i,n,s,r,a){return F(t&n|i&~n,e,t,s,r,a)}function H(e,t,i,n,s,r,a){return F(t^i^n,e,t,s,r,a)}function P(e,t,i,n,s,r,a){return F(i^(t|~n),e,t,s,r,a)}var U=O("v3",48,function(e){if("string"==typeof e){var t=unescape(encodeURIComponent(e));e=new Uint8Array(t.length);for(var i=0;i<t.length;++i)e[i]=t.charCodeAt(i)}return function(e){for(var t=[],i=32*e.length,n="0123456789abcdef",s=0;s<i;s+=8){var r=e[s>>5]>>>s%32&255,r=parseInt(n.charAt(r>>>4&15)+n.charAt(15&r),16);t.push(r)}return t}(function(e,t){e[t>>5]|=128<<t%32,e[x(t)-1]=t;for(var i=1732584193,n=-271733879,s=-1732584194,r=271733878,a=0;a<e.length;a+=16){var o=i,l=n,c=s,h=r;i=D(i,n,s,r,e[a],7,-680876936),r=D(r,i,n,s,e[a+1],12,-389564586),s=D(s,r,i,n,e[a+2],17,606105819),n=D(n,s,r,i,e[a+3],22,-1044525330),i=D(i,n,s,r,e[a+4],7,-176418897),r=D(r,i,n,s,e[a+5],12,1200080426),s=D(s,r,i,n,e[a+6],17,-1473231341),n=D(n,s,r,i,e[a+7],22,-45705983),i=D(i,n,s,r,e[a+8],7,1770035416),r=D(r,i,n,s,e[a+9],12,-1958414417),s=D(s,r,i,n,e[a+10],17,-42063),n=D(n,s,r,i,e[a+11],22,-1990404162),i=D(i,n,s,r,e[a+12],7,1804603682),r=D(r,i,n,s,e[a+13],12,-40341101),s=D(s,r,i,n,e[a+14],17,-1502002290),n=D(n,s,r,i,e[a+15],22,1236535329),i=M(i,n,s,r,e[a+1],5,-165796510),r=M(r,i,n,s,e[a+6],9,-1069501632),s=M(s,r,i,n,e[a+11],14,643717713),n=M(n,s,r,i,e[a],20,-373897302),i=M(i,n,s,r,e[a+5],5,-701558691),r=M(r,i,n,s,e[a+10],9,38016083),s=M(s,r,i,n,e[a+15],14,-660478335),n=M(n,s,r,i,e[a+4],20,-405537848),i=M(i,n,s,r,e[a+9],5,568446438),r=M(r,i,n,s,e[a+14],9,-1019803690),s=M(s,r,i,n,e[a+3],14,-187363961),n=M(n,s,r,i,e[a+8],20,1163531501),i=M(i,n,s,r,e[a+13],5,-1444681467),r=M(r,i,n,s,e[a+2],9,-51403784),s=M(s,r,i,n,e[a+7],14,1735328473),n=M(n,s,r,i,e[a+12],20,-1926607734),i=H(i,n,s,r,e[a+5],4,-378558),r=H(r,i,n,s,e[a+8],11,-2022574463),s=H(s,r,i,n,e[a+11],16,1839030562),n=H(n,s,r,i,e[a+14],23,-35309556),i=H(i,n,s,r,e[a+1],4,-1530992060),r=H(r,i,n,s,e[a+4],11,1272893353),s=H(s,r,i,n,e[a+7],16,-155497632),n=H(n,s,r,i,e[a+10],23,-1094730640),i=H(i,n,s,r,e[a+13],4,681279174),r=H(r,i,n,s,e[a],11,-358537222),s=H(s,r,i,n,e[a+3],16,-722521979),n=H(n,s,r,i,e[a+6],23,76029189),i=H(i,n,s,r,e[a+9],4,-640364487),r=H(r,i,n,s,e[a+12],11,-421815835),s=H(s,r,i,n,e[a+15],16,530742520),n=H(n,s,r,i,e[a+2],23,-995338651),i=P(i,n,s,r,e[a],6,-198630844),r=P(r,i,n,s,e[a+7],10,1126891415),s=P(s,r,i,n,e[a+14],15,-1416354905),n=P(n,s,r,i,e[a+5],21,-57434055),i=P(i,n,s,r,e[a+12],6,1700485571),r=P(r,i,n,s,e[a+3],10,-1894986606),s=P(s,r,i,n,e[a+10],15,-1051523),n=P(n,s,r,i,e[a+1],21,-2054922799),i=P(i,n,s,r,e[a+8],6,1873313359),r=P(r,i,n,s,e[a+15],10,-30611744),s=P(s,r,i,n,e[a+6],15,-1560198380),n=P(n,s,r,i,e[a+13],21,1309151649),i=P(i,n,s,r,e[a+4],6,-145523070),r=P(r,i,n,s,e[a+11],10,-1120210379),s=P(s,r,i,n,e[a+2],15,718787259),n=P(n,s,r,i,e[a+9],21,-343485551),i=R(i,o),n=R(n,l),s=R(s,c),r=R(r,h)}return[i,n,s,r]}(function(e){if(0===e.length)return[];for(var t=8*e.length,i=new Uint32Array(x(t)),n=0;n<t;n+=8)i[n>>5]|=(255&e[n/8])<<n%32;return i}(e),8*e.length))});function V(e,t){return e<<t|e>>>32-t}var Y=O("v5",80,function(e){var t=[1518500249,1859775393,2400959708,3395469782],i=[1732584193,4023233417,2562383102,271733878,3285377520];if("string"==typeof e){var n=unescape(encodeURIComponent(e));e=[];for(var s=0;s<n.length;++s)e.push(n.charCodeAt(s))}else Array.isArray(e)||(e=Array.prototype.slice.call(e));e.push(128);for(var r=e.length/4+2,a=Math.ceil(r/16),o=new Array(a),l=0;l<a;++l){for(var c=new Uint32Array(16),h=0;h<16;++h)c[h]=e[64*l+4*h]<<24|e[64*l+4*h+1]<<16|e[64*l+4*h+2]<<8|e[64*l+4*h+3];o[l]=c}o[a-1][14]=8*(e.length-1)/Math.pow(2,32),o[a-1][14]=Math.floor(o[a-1][14]),o[a-1][15]=8*(e.length-1)&4294967295;for(var d=0;d<a;++d){for(var u=new Uint32Array(80),p=0;p<16;++p)u[p]=o[d][p];for(var m=16;m<80;++m)u[m]=V(u[m-3]^u[m-8]^u[m-14]^u[m-16],1);for(var g=i[0],f=i[1],v=i[2],y=i[3],w=i[4],b=0;b<80;++b)var E=Math.floor(b/20),E=V(g,5)+function(e,t,i,n){switch(e){case 0:return t&i^~t&n;case 1:return t^i^n;case 2:return t&i^t&n^i&n;case 3:return t^i^n}}(E,f,v,y)+w+t[E]+u[b]>>>0,w=y,y=v,v=V(f,30)>>>0,f=g,g=E;i[0]=i[0]+g>>>0,i[1]=i[1]+f>>>0,i[2]=i[2]+v>>>0,i[3]=i[3]+y>>>0,i[4]=i[4]+w>>>0}return[i[0]>>24&255,i[0]>>16&255,i[0]>>8&255,255&i[0],i[1]>>24&255,i[1]>>16&255,i[1]>>8&255,255&i[1],i[2]>>24&255,i[2]>>16&255,i[2]>>8&255,255&i[2],i[3]>>24&255,i[3]>>16&255,i[3]>>8&255,255&i[3],i[4]>>24&255,i[4]>>16&255,i[4]>>8&255,255&i[4]]});var X=i(Object.freeze({__proto__:null,v1:function(e,t,i){var n=t&&i||0,s=t||new Array(16),r=(e=e||{}).node||T,a=void 0!==e.clockseq?e.clockseq:S;null!=r&&null!=a||(l=e.random||(e.rng||b)(),null==r&&(r=T=[1|l[0],l[1],l[2],l[3],l[4],l[5]]),null==a&&(a=S=16383&(l[6]<<8|l[7])));var o=void 0!==e.msecs?e.msecs:Date.now(),i=void 0!==e.nsecs?e.nsecs:k+1,l=o-N+(i-k)/1e4;if(l<0&&void 0===e.clockseq&&(a=a+1&16383),1e4<=(i=(l<0||N<o)&&void 0===e.nsecs?0:i))throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");N=o,S=a,i=(1e4*(268435455&(o+=122192928e5))+(k=i))%4294967296,s[n++]=i>>>24&255,s[n++]=i>>>16&255,s[n++]=i>>>8&255,s[n++]=255&i,o=o/4294967296*1e4&268435455,s[n++]=o>>>8&255,s[n++]=255&o,s[n++]=o>>>24&15|16,s[n++]=o>>>16&255,s[n++]=a>>>8|128,s[n++]=255&a;for(var c=0;c<6;++c)s[n+c]=r[c];return t||L(s)},v3:U,v4:function(e,t,i){var n=(e=e||{}).random||(e.rng||b)();if(n[6]=15&n[6]|64,n[8]=63&n[8]|128,t){i=i||0;for(var s=0;s<16;++s)t[i+s]=n[s];return t}return L(n)},v5:Y,NIL:"00000000-0000-0000-0000-000000000000",version:function(e){if(!B(e))throw TypeError("Invalid UUID");return parseInt(e.substr(14,1),16)},validate:B,stringify:L,parse:A})),$={},e={};Object.defineProperty(e,"__esModule",{value:!0});const _=[{TEXT:"BASIC",COLOR:"#19aa19",BACKGROUND:"#e8f6e8"},{TEXT:"ADVANCED",COLOR:"#f55000",BACKGROUND:"#feede5"},{TEXT:"EXPERT",COLOR:"#a00a50",BACKGROUND:"#F5E6ED"},{TEXT:"MASTER",COLOR:"#8200dc",BACKGROUND:"#f2e5fb"},{TEXT:"WORLD'S END",COLOR:"#000000",BACKGROUND:"#e5e5e5"}],z=["SONGID","TITLE","ARTIST","DESIGNER","DIFFICULTY","PLAYLEVEL","WAVE","WAVEOFFSET","JACKET","BACKGROUND","MOVIE","MOVIEOFFSET","BASEBPM"],G=["SONGID","TITLE","ARTIST","DESIGNER","DIFFICULTY","PLAYLEVEL"],j=["ARTIST","BACKGROUND","DESIGNER","JACKET","MOVIE","SONGID","TITLE","WAVE"],W=["BASEBPM","MOVIEOFFSET","WAVEOFFSET"];function K(e){return e.split("\n").filter(e=>"#"===e.slice(0,1)).map(e=>e.slice(1)).filter(e=>!e.match(/^\d{3}/)).reduce((e,t)=>{var i,n=t.slice(0,t.indexOf(" ")).trim().toUpperCase();return i=n,-1<z.indexOf(i)&&(t={key:n,value:t.slice(t.indexOf(" ")+1,t.length).trim()},e.push(t)),e},[]).map(e=>(e.value=e.value.match(/^".*"$/)?e.value.slice(1,e.value.length-1):e.value,e)).filter(e=>e.value).reduce((e,t)=>{if(-1<j.indexOf(t.key)&&(e[t.key]=t.value),-1<W.indexOf(t.key)&&Number(t.value)&&(e[t.key]=Number(t.value)),"DIFFICULTY"===t.key){var i=Number(t.value.slice(0,1));if(isNaN(i)||Number(i)<0||4<Number(i))return e;e.DIFFICULTY=Object.assign({},_[i],{LEVEL:Number(i),MARK:4===Number(i)?1!==t.value.length?`${t.value}:`.split(":")[1]:"":void 0})}if("PLAYLEVEL"===t.key){if(!Number(t.value)&&!Number(t.value.slice(0,-1)))return e;e.PLAYLEVEL={LEVEL:Number(t.value)||Number(t.value.slice(0,-1)),PLUS:/\+$/.test(t.value),TEXT:t.value}}return e},{})}e.getMeta=K,e.validate=function(e){const t=K(e),i=G.slice();return null!=t.WAVE&&i.push("WAVEOFFSET"),null!=t.MOVIE&&i.push("MOVIEOFFSET"),null!=t.DIFFICULTY&&4===t.DIFFICULTY.LEVEL&&i.splice(i.indexOf("PLAYLEVEL"),1),{MISSING_META:e=i.filter(e=>!t.hasOwnProperty(e)),VALIDITY:0===e.length}};var q,U={};Object.defineProperty(U,"__esModule",{value:!0});const Z=e;function J(e,t,i,n){return e.filter(e=>e.match(t)).reduce((e,t)=>(e[Number(t.slice(i,n))]=Number(t.split(":")[1].trim()),e),[])}function Q(s,e){return[...Array(e)].reduce((e,t,i)=>{let n=i;for(;e[i]=s[n--],void 0===e[i];);return e},[])}function ee(e,n){const s=[];return e.filter(e=>e.laneType===n).reduce((e,t)=>(e[t.measure]=e[t.measure]||[],e[t.measure][t.tick]=e[t.measure][t.tick]||[],e[t.measure][t.tick].push(t),e),[]).reduce((i,e)=>(e.forEach(e=>{e.filter(e=>2===e.noteType).forEach(e=>{var t=2===n?e.lane:0;e.channel&&s[t]&&s[t][e.channel]&&(s[t][e.channel].push(e),i.push(s[t][e.channel]),delete s[t][e.channel])}),e.filter(e=>1===e.noteType).forEach(e=>{var t=2===n?e.lane:0;e.channel&&(s[t]=s[t]||[],s[t][e.channel]=[],s[t][e.channel].push(e))}),e.filter(e=>-1<[3,4,5].indexOf(e.noteType)).forEach(e=>{var t=2===n?e.lane:0;e.channel&&s[t]&&s[t][e.channel]&&s[t][e.channel].push(e)})}),i),[])}function te(e){for(var t in e)q.hasOwnProperty(t)||(q[t]=e[t])}U.getScore=function(e,t=192){const i=e.split("\n").filter(e=>"#"===e.slice(0,1)).map(e=>e.slice(1));var n,a,o,s=i.filter(e=>e.match(/^\d{3}[1-5][0-9a-fA-F][0-9a-zA-Z]?:/)).map(e=>Number(e.slice(0,3))).reduce((e,t)=>t<e?e:t,0)+1,r=function(e,t){const i=J(e,/^\d{3}02:/,0,3);return i[0]=Number.isFinite(i[0])?i[0]:4,Q(i,t)}(i,s);const l=(n=i,a=t,o=r,n.filter(e=>e.match(/^\d{3}[1-5][0-9a-fA-F][0-9a-zA-Z]?:(\s*[0-9a-zA-Z][0-9a-gA-G])+\s*$/)).map(e=>e.split(":",2)).reduce((t,n)=>{const s=n[1].trim().replace(/ /g,""),r=Number(n[0].slice(0,3));return[...Array(s.length/2)].map((e,t)=>{const i={lane:parseInt(n[0].slice(4,5),16),laneType:Number(n[0].slice(3,4)),measure:r,noteType:parseInt(s[2*t],36),tick:Math.round(a*o[r]/(s.length/2)*t),width:parseInt(s[2*t+1],17)};return 6===n[0].length&&(i.channel=n[0].slice(5,6).toUpperCase().charCodeAt(0)),i}).filter(e=>0!==e.width).forEach(e=>t.push(e)),t},[]));return{BEATs:r,BPMs:function(e,t,i=120){const n=J(e,/^BPM\d{2}:/,3,5),s=J(e,/^\d{3}08:/,0,3).map(e=>{if(n[e])return n[e]});return s[0]=Number(s[0])?s[0]:i,Q(s,t)}(i,s,Z.getMeta(e).BASEBPM),airActionNotes:ee(l,4),airNotes:l.filter(e=>5===e.laneType),holdNotes:ee(l,2),measure:s,shortNotes:l.filter(e=>1===e.laneType),slideNotes:ee(l,3)}},q=$,Object.defineProperty(q,"__esModule",{value:!0}),te(e),te(U);Y={};e=Y,Object.defineProperty(e,"__esModule",{value:!0}),e.FlickDirection=e.CurveType=e.NoteType=void 0,(U=e.NoteType||(e.NoteType={}))[U.Tap=0]="Tap",U[U.Flick=1]="Flick",U[U.SlideStart=2]="SlideStart",U[U.SlideInvisible=3]="SlideInvisible",U[U.SlideVisible=4]="SlideVisible",U[U.SlideEndDefault=5]="SlideEndDefault",U[U.SlideEndFlick=6]="SlideEndFlick",(U=e.CurveType||(e.CurveType={}))[U.None=0]="None",U[U.Linear=1]="Linear",U[U.EaseIn=2]="EaseIn",U[U.EaseOut=3]="EaseOut",U[U.EaseInOut=4]="EaseInOut",U[U.CubicBezier=5]="CubicBezier",(e=e.FlickDirection||(e.FlickDirection={}))[e.Up=0]="Up",e[e.Left=1]="Left",e[e.Right=2]="Right";const ie=X["v4"],ne=$,{NoteType:se,CurveType:re,FlickDirection:ae}=Y;function oe(e){const o=ne.getScore(e,480),s=ie(),r={timelines:[{id:s,name:"Timeline 1"}],bpms:[{id:ie(),timeline:s,beat:[0,0,1],bpm:o.BPMs[0]}],notes:[],slides:[]};return o.slideNotes.forEach(e=>{const a={id:ie(),timeline:s,notes:[]};e.forEach((t,e)=>{var i=o.airNotes.findIndex(e=>ce(t,e)),n=o.shortNotes.findIndex(e=>3===e.noteType&&ce(t,e)),s=o.shortNotes.findIndex(e=>ce(t,e));0===e&&-1!==s&&2===o.shortNotes[s].noteType&&(o.shortNotes.splice(s,1),a.critical=!0);e=le(t.tick,1920);const r={id:ie(),type:{1:se.SlideStart,2:se.SlideEndDefault,3:se.SlideVisible,5:se.SlideInvisible}[t.noteType],beat:[t.measure,t.tick/e,t.tick?1920/e:1],lane:t.lane-2,width:t.width,curve:re.Linear};r.type===se.SlideEndDefault&&-1!==i?([e]=o.airNotes.splice(i,1),r.type=se.SlideEndFlick,r.direction=3===e.noteType?ae.Left:4===e.noteType?ae.Right:ae.Up,-1!==s&&([e]=o.shortNotes.splice(s,1),2===e.noteType&&(r.critical=!0))):-1!==i&&-1!==s&&(o.shortNotes.splice(s,1),[i]=o.airNotes.splice(i,1),r.curve={2:re.EaseOut,5:re.EaseIn,6:re.EaseIn}[i.noteType]),-1!==n&&r.type===se.SlideVisible&&(o.shortNotes.splice(n,1),delete r.width,delete r.lane,delete r.curve),a.notes.push(r)}),r.slides.push(a)}),o.shortNotes.forEach(t=>{if(!(t.lane<2||13<t.lane)){var e=o.airNotes.find(e=>ce(e,t)),i=le(t.tick,1920);const n={id:ie(),timeline:s,type:e?se.Flick:se.Tap,beat:[t.measure,t.tick/i,t.tick?1920/i:1],lane:t.lane-2,width:t.width};2===t.noteType&&(n.critical=!0),e&&(n.direction=3===e.noteType?ae.Left:4===e.noteType?ae.Right:ae.Up),r.notes.push(n)}}),r}function le(e,t){if(0===e)return t;for(;0!==t;){var i=t;t=e%t,e=i}return e}function ce(e,t){return e.measure===t.measure&&e.tick===t.tick&&e.lane===t.lane&&e.width===t.width}var he,de,ue,pe;he="* {\n\tmargin: 0;\n\tpadding: 0;\n}\n\nhtml, body {\n\twidth: 100%;\n\theight: 100%;\n}\n\nbody {\n\tuser-select: none;\n}\n\n#selector {\n\theight: 40px;\n\tposition: relative;\n}\n\n#app {\n\theight: calc(100% - 40px);\n\tmax-width: 600px;\n}\n",pe=(de=void 0===de?{}:de).insertAt,he&&"undefined"!=typeof document&&(ue=document.head||document.getElementsByTagName("head")[0],(de=document.createElement("style")).type="text/css","top"===pe&&ue.firstChild?ue.insertBefore(de,ue.firstChild):ue.appendChild(de),de.styleSheet?de.styleSheet.cssText=he:de.appendChild(document.createTextNode(he))),function(){document.addEventListener("DOMContentLoaded",async function(){console.log("ready");const i=document.getElementById("id"),n=document.getElementById("diff"),e=document.getElementById("load"),s=document.getElementById("bottom"),t=document.getElementById("scroll"),r=document.getElementById("input"),a=document.getElementById("container"),o=document.getElementById("text"),l=document.getElementById("draw");r.addEventListener("click",()=>{a.style.display="none"===a.style.display?"block":"none"}),l.addEventListener("click",()=>{a.style.display="none";var e=oe(o.value);null!==c&&(c.destroy(),c=null),c=new y(document.getElementById("app"),e,180),c.event.addEventListener("scroll",e=>{s.value=e.detail.scrollBottom}),c.scrollTo(0)}),await y.loadResource((e,t)=>{console.log(`${e.progress}% loading: ${t.url}`)}),t.addEventListener("click",()=>{var e=parseInt(s.value);c&&c.scrollTo(e)}),e.addEventListener("click",async()=>{const e=await fetch(`https://assets.pjsek.ai/file/pjsekai-assets/startapp/music/music_score/${i.value.padStart(4,"0")}_01/${n.value}`);var t=oe(await e.text());null!==c&&(c.destroy(),c=null),c=new y(document.getElementById("app"),t,180),c.event.addEventListener("scroll",e=>{s.value=e.detail.scrollBottom}),c.scrollTo(0)}),i.value="135",e.click()});let c=null}()}(PIXI);
