!function(n){"use strict";function e(i){if(i&&i.__esModule)return i;var r=Object.create(null);return i&&Object.keys(i).forEach(function(e){var t;"default"!==e&&(t=Object.getOwnPropertyDescriptor(i,e),Object.defineProperty(r,e,t.get?t:{enumerable:!0,get:function(){return i[e]}}))}),r.default=i,Object.freeze(r)}var t,s=e(n),i="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function r(i){if(i.__esModule)return i;var r=Object.defineProperty({},"__esModule",{value:!0});return Object.keys(i).forEach(function(e){var t=Object.getOwnPropertyDescriptor(i,e);Object.defineProperty(r,e,t.get?t:{enumerable:!0,get:function(){return i[e]}})}),r}var o=new Uint8Array(16);function h(){if(!t&&!(t="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return t(o)}var l=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function a(e){return"string"==typeof e&&l.test(e)}for(var c,u,d=[],g=0;g<256;++g)d.push((g+256).toString(16).substr(1));function p(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,t=(d[e[t+0]]+d[e[t+1]]+d[e[t+2]]+d[e[t+3]]+"-"+d[e[t+4]]+d[e[t+5]]+"-"+d[e[t+6]]+d[e[t+7]]+"-"+d[e[t+8]]+d[e[t+9]]+"-"+d[e[t+10]]+d[e[t+11]]+d[e[t+12]]+d[e[t+13]]+d[e[t+14]]+d[e[t+15]]).toLowerCase();if(!a(t))throw TypeError("Stringified UUID is invalid");return t}var m=0,f=0;function v(e){if(!a(e))throw TypeError("Invalid UUID");var t,i=new Uint8Array(16);return i[0]=(t=parseInt(e.slice(0,8),16))>>>24,i[1]=t>>>16&255,i[2]=t>>>8&255,i[3]=255&t,i[4]=(t=parseInt(e.slice(9,13),16))>>>8,i[5]=255&t,i[6]=(t=parseInt(e.slice(14,18),16))>>>8,i[7]=255&t,i[8]=(t=parseInt(e.slice(19,23),16))>>>8,i[9]=255&t,i[10]=(t=parseInt(e.slice(24,36),16))/1099511627776&255,i[11]=t/4294967296&255,i[12]=t>>>24&255,i[13]=t>>>16&255,i[14]=t>>>8&255,i[15]=255&t,i}function y(e,s,l){function t(e,t,i,r){if("string"==typeof e&&(e=function(e){e=unescape(encodeURIComponent(e));for(var t=[],i=0;i<e.length;++i)t.push(e.charCodeAt(i));return t}(e)),16!==(t="string"==typeof t?v(t):t).length)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");var o=new Uint8Array(16+e.length);if(o.set(t),o.set(e,t.length),(o=l(o))[6]=15&o[6]|s,o[8]=63&o[8]|128,i){r=r||0;for(var n=0;n<16;++n)i[r+n]=o[n];return i}return p(o)}try{t.name=e}catch(e){}return t.DNS="6ba7b810-9dad-11d1-80b4-00c04fd430c8",t.URL="6ba7b811-9dad-11d1-80b4-00c04fd430c8",t}function b(e){return 14+(e+64>>>9<<4)+1}function w(e,t){var i=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(i>>16)<<16|65535&i}function S(e,t,i,r,o,n){return w((n=w(w(t,e),w(r,n)))<<o|n>>>32-o,i)}function T(e,t,i,r,o,n,s){return S(t&i|~t&r,e,t,o,n,s)}function L(e,t,i,r,o,n,s){return S(t&r|i&~r,e,t,o,n,s)}function C(e,t,i,r,o,n,s){return S(t^i^r,e,t,o,n,s)}function M(e,t,i,r,o,n,s){return S(i^(t|~r),e,t,o,n,s)}var E=y("v3",48,function(e){if("string"==typeof e){var t=unescape(encodeURIComponent(e));e=new Uint8Array(t.length);for(var i=0;i<t.length;++i)e[i]=t.charCodeAt(i)}return function(e){for(var t=[],i=32*e.length,r="0123456789abcdef",o=0;o<i;o+=8){var n=e[o>>5]>>>o%32&255,n=parseInt(r.charAt(n>>>4&15)+r.charAt(15&n),16);t.push(n)}return t}(function(e,t){e[t>>5]|=128<<t%32,e[b(t)-1]=t;for(var i=1732584193,r=-271733879,o=-1732584194,n=271733878,s=0;s<e.length;s+=16){var l=i,a=r,d=o,h=n;i=T(i,r,o,n,e[s],7,-680876936),n=T(n,i,r,o,e[s+1],12,-389564586),o=T(o,n,i,r,e[s+2],17,606105819),r=T(r,o,n,i,e[s+3],22,-1044525330),i=T(i,r,o,n,e[s+4],7,-176418897),n=T(n,i,r,o,e[s+5],12,1200080426),o=T(o,n,i,r,e[s+6],17,-1473231341),r=T(r,o,n,i,e[s+7],22,-45705983),i=T(i,r,o,n,e[s+8],7,1770035416),n=T(n,i,r,o,e[s+9],12,-1958414417),o=T(o,n,i,r,e[s+10],17,-42063),r=T(r,o,n,i,e[s+11],22,-1990404162),i=T(i,r,o,n,e[s+12],7,1804603682),n=T(n,i,r,o,e[s+13],12,-40341101),o=T(o,n,i,r,e[s+14],17,-1502002290),r=T(r,o,n,i,e[s+15],22,1236535329),i=L(i,r,o,n,e[s+1],5,-165796510),n=L(n,i,r,o,e[s+6],9,-1069501632),o=L(o,n,i,r,e[s+11],14,643717713),r=L(r,o,n,i,e[s],20,-373897302),i=L(i,r,o,n,e[s+5],5,-701558691),n=L(n,i,r,o,e[s+10],9,38016083),o=L(o,n,i,r,e[s+15],14,-660478335),r=L(r,o,n,i,e[s+4],20,-405537848),i=L(i,r,o,n,e[s+9],5,568446438),n=L(n,i,r,o,e[s+14],9,-1019803690),o=L(o,n,i,r,e[s+3],14,-187363961),r=L(r,o,n,i,e[s+8],20,1163531501),i=L(i,r,o,n,e[s+13],5,-1444681467),n=L(n,i,r,o,e[s+2],9,-51403784),o=L(o,n,i,r,e[s+7],14,1735328473),r=L(r,o,n,i,e[s+12],20,-1926607734),i=C(i,r,o,n,e[s+5],4,-378558),n=C(n,i,r,o,e[s+8],11,-2022574463),o=C(o,n,i,r,e[s+11],16,1839030562),r=C(r,o,n,i,e[s+14],23,-35309556),i=C(i,r,o,n,e[s+1],4,-1530992060),n=C(n,i,r,o,e[s+4],11,1272893353),o=C(o,n,i,r,e[s+7],16,-155497632),r=C(r,o,n,i,e[s+10],23,-1094730640),i=C(i,r,o,n,e[s+13],4,681279174),n=C(n,i,r,o,e[s],11,-358537222),o=C(o,n,i,r,e[s+3],16,-722521979),r=C(r,o,n,i,e[s+6],23,76029189),i=C(i,r,o,n,e[s+9],4,-640364487),n=C(n,i,r,o,e[s+12],11,-421815835),o=C(o,n,i,r,e[s+15],16,530742520),r=C(r,o,n,i,e[s+2],23,-995338651),i=M(i,r,o,n,e[s],6,-198630844),n=M(n,i,r,o,e[s+7],10,1126891415),o=M(o,n,i,r,e[s+14],15,-1416354905),r=M(r,o,n,i,e[s+5],21,-57434055),i=M(i,r,o,n,e[s+12],6,1700485571),n=M(n,i,r,o,e[s+3],10,-1894986606),o=M(o,n,i,r,e[s+10],15,-1051523),r=M(r,o,n,i,e[s+1],21,-2054922799),i=M(i,r,o,n,e[s+8],6,1873313359),n=M(n,i,r,o,e[s+15],10,-30611744),o=M(o,n,i,r,e[s+6],15,-1560198380),r=M(r,o,n,i,e[s+13],21,1309151649),i=M(i,r,o,n,e[s+4],6,-145523070),n=M(n,i,r,o,e[s+11],10,-1120210379),o=M(o,n,i,r,e[s+2],15,718787259),r=M(r,o,n,i,e[s+9],21,-343485551),i=w(i,l),r=w(r,a),o=w(o,d),n=w(n,h)}return[i,r,o,n]}(function(e){if(0===e.length)return[];for(var t=8*e.length,i=new Uint32Array(b(t)),r=0;r<t;r+=8)i[r>>5]|=(255&e[r/8])<<r%32;return i}(e),8*e.length))});function x(e,t){return e<<t|e>>>32-t}var B=y("v5",80,function(e){var t=[1518500249,1859775393,2400959708,3395469782],i=[1732584193,4023233417,2562383102,271733878,3285377520];if("string"==typeof e){var r=unescape(encodeURIComponent(e));e=[];for(var o=0;o<r.length;++o)e.push(r.charCodeAt(o))}else Array.isArray(e)||(e=Array.prototype.slice.call(e));e.push(128);for(var n=e.length/4+2,s=Math.ceil(n/16),l=new Array(s),a=0;a<s;++a){for(var d=new Uint32Array(16),h=0;h<16;++h)d[h]=e[64*a+4*h]<<24|e[64*a+4*h+1]<<16|e[64*a+4*h+2]<<8|e[64*a+4*h+3];l[a]=d}l[s-1][14]=8*(e.length-1)/Math.pow(2,32),l[s-1][14]=Math.floor(l[s-1][14]),l[s-1][15]=8*(e.length-1)&4294967295;for(var c=0;c<s;++c){for(var u=new Uint32Array(80),g=0;g<16;++g)u[g]=l[c][g];for(var p=16;p<80;++p)u[p]=x(u[p-3]^u[p-8]^u[p-14]^u[p-16],1);for(var m=i[0],f=i[1],v=i[2],y=i[3],b=i[4],w=0;w<80;++w)var S=Math.floor(w/20),S=x(m,5)+function(e,t,i,r){switch(e){case 0:return t&i^~t&r;case 1:return t^i^r;case 2:return t&i^t&r^i&r;case 3:return t^i^r}}(S,f,v,y)+b+t[S]+u[w]>>>0,b=y,y=v,v=x(f,30)>>>0,f=m,m=S;i[0]=i[0]+m>>>0,i[1]=i[1]+f>>>0,i[2]=i[2]+v>>>0,i[3]=i[3]+y>>>0,i[4]=i[4]+b>>>0}return[i[0]>>24&255,i[0]>>16&255,i[0]>>8&255,255&i[0],i[1]>>24&255,i[1]>>16&255,i[1]>>8&255,255&i[1],i[2]>>24&255,i[2]>>16&255,i[2]>>8&255,255&i[2],i[3]>>24&255,i[3]>>16&255,i[3]>>8&255,255&i[3],i[4]>>24&255,i[4]>>16&255,i[4]>>8&255,255&i[4]]});var I=r(Object.freeze({__proto__:null,v1:function(e,t,i){var r=t&&i||0,o=t||new Array(16),n=(e=e||{}).node||c,s=void 0!==e.clockseq?e.clockseq:u;null!=n&&null!=s||(a=e.random||(e.rng||h)(),null==n&&(n=c=[1|a[0],a[1],a[2],a[3],a[4],a[5]]),null==s&&(s=u=16383&(a[6]<<8|a[7])));var l=void 0!==e.msecs?e.msecs:Date.now(),i=void 0!==e.nsecs?e.nsecs:f+1,a=l-m+(i-f)/1e4;if(a<0&&void 0===e.clockseq&&(s=s+1&16383),1e4<=(i=(a<0||m<l)&&void 0===e.nsecs?0:i))throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");m=l,u=s,i=(1e4*(268435455&(l+=122192928e5))+(f=i))%4294967296,o[r++]=i>>>24&255,o[r++]=i>>>16&255,o[r++]=i>>>8&255,o[r++]=255&i,l=l/4294967296*1e4&268435455,o[r++]=l>>>8&255,o[r++]=255&l,o[r++]=l>>>24&15|16,o[r++]=l>>>16&255,o[r++]=s>>>8|128,o[r++]=255&s;for(var d=0;d<6;++d)o[r+d]=n[d];return t||p(o)},v3:E,v4:function(e,t,i){var r=(e=e||{}).random||(e.rng||h)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t){i=i||0;for(var o=0;o<16;++o)t[i+o]=r[o];return t}return p(r)},v5:B,NIL:"00000000-0000-0000-0000-000000000000",version:function(e){if(!a(e))throw TypeError("Invalid UUID");return parseInt(e.substr(14,1),16)},validate:a,stringify:p,parse:v})),_={},E={};Object.defineProperty(E,"__esModule",{value:!0});const A=[{TEXT:"BASIC",COLOR:"#19aa19",BACKGROUND:"#e8f6e8"},{TEXT:"ADVANCED",COLOR:"#f55000",BACKGROUND:"#feede5"},{TEXT:"EXPERT",COLOR:"#a00a50",BACKGROUND:"#F5E6ED"},{TEXT:"MASTER",COLOR:"#8200dc",BACKGROUND:"#f2e5fb"},{TEXT:"WORLD'S END",COLOR:"#000000",BACKGROUND:"#e5e5e5"}],O=["SONGID","TITLE","ARTIST","DESIGNER","DIFFICULTY","PLAYLEVEL","WAVE","WAVEOFFSET","JACKET","BACKGROUND","MOVIE","MOVIEOFFSET","BASEBPM"],H=["SONGID","TITLE","ARTIST","DESIGNER","DIFFICULTY","PLAYLEVEL"],N=["ARTIST","BACKGROUND","DESIGNER","JACKET","MOVIE","SONGID","TITLE","WAVE"],R=["BASEBPM","MOVIEOFFSET","WAVEOFFSET"];function k(e){return e.split("\n").filter(e=>"#"===e.slice(0,1)).map(e=>e.slice(1)).filter(e=>!e.match(/^\d{3}/)).reduce((e,t)=>{var i,r=t.slice(0,t.indexOf(" ")).trim().toUpperCase();return i=r,-1<O.indexOf(i)&&(t={key:r,value:t.slice(t.indexOf(" ")+1,t.length).trim()},e.push(t)),e},[]).map(e=>(e.value=e.value.match(/^".*"$/)?e.value.slice(1,e.value.length-1):e.value,e)).filter(e=>e.value).reduce((e,t)=>{if(-1<N.indexOf(t.key)&&(e[t.key]=t.value),-1<R.indexOf(t.key)&&Number(t.value)&&(e[t.key]=Number(t.value)),"DIFFICULTY"===t.key){var i=Number(t.value.slice(0,1));if(isNaN(i)||Number(i)<0||4<Number(i))return e;e.DIFFICULTY=Object.assign({},A[i],{LEVEL:Number(i),MARK:4===Number(i)?1!==t.value.length?`${t.value}:`.split(":")[1]:"":void 0})}if("PLAYLEVEL"===t.key){if(!Number(t.value)&&!Number(t.value.slice(0,-1)))return e;e.PLAYLEVEL={LEVEL:Number(t.value)||Number(t.value.slice(0,-1)),PLUS:/\+$/.test(t.value),TEXT:t.value}}return e},{})}E.getMeta=k,E.validate=function(e){const t=k(e),i=H.slice();return null!=t.WAVE&&i.push("WAVEOFFSET"),null!=t.MOVIE&&i.push("MOVIEOFFSET"),null!=t.DIFFICULTY&&4===t.DIFFICULTY.LEVEL&&i.splice(i.indexOf("PLAYLEVEL"),1),{MISSING_META:e=i.filter(e=>!t.hasOwnProperty(e)),VALIDITY:0===e.length}};var P,B={};Object.defineProperty(B,"__esModule",{value:!0});const D=E;function j(e,t,i,r){return e.filter(e=>e.match(t)).reduce((e,t)=>(e[Number(t.slice(i,r))]=Number(t.split(":")[1].trim()),e),[])}function W(o,e){return[...Array(e)].reduce((e,t,i)=>{let r=i;for(;e[i]=o[r--],void 0===e[i];);return e},[])}function U(e,r){const o=[];return e.filter(e=>e.laneType===r).reduce((e,t)=>(e[t.measure]=e[t.measure]||[],e[t.measure][t.tick]=e[t.measure][t.tick]||[],e[t.measure][t.tick].push(t),e),[]).reduce((i,e)=>(e.forEach(e=>{e.filter(e=>2===e.noteType).forEach(e=>{var t=2===r?e.lane:0;e.channel&&o[t]&&o[t][e.channel]&&(o[t][e.channel].push(e),i.push(o[t][e.channel]),delete o[t][e.channel])}),e.filter(e=>1===e.noteType).forEach(e=>{var t=2===r?e.lane:0;e.channel&&(o[t]=o[t]||[],o[t][e.channel]=[],o[t][e.channel].push(e))}),e.filter(e=>-1<[3,4,5].indexOf(e.noteType)).forEach(e=>{var t=2===r?e.lane:0;e.channel&&o[t]&&o[t][e.channel]&&o[t][e.channel].push(e)})}),i),[])}function F(e){for(var t in e)P.hasOwnProperty(t)||(P[t]=e[t])}B.getScore=function(e,t=192){const i=e.split("\n").filter(e=>"#"===e.slice(0,1)).map(e=>e.slice(1));var r,s,l,o=i.filter(e=>e.match(/^\d{3}[1-5][0-9a-fA-F][0-9a-zA-Z]?:/)).map(e=>Number(e.slice(0,3))).reduce((e,t)=>t<e?e:t,0)+1,n=function(e,t){const i=j(e,/^\d{3}02:/,0,3);return i[0]=Number.isFinite(i[0])?i[0]:4,W(i,t)}(i,o);const a=(r=i,s=t,l=n,r.filter(e=>e.match(/^\d{3}[1-5][0-9a-fA-F][0-9a-zA-Z]?:(\s*[0-9a-zA-Z][0-9a-gA-G])+\s*$/)).map(e=>e.split(":",2)).reduce((t,r)=>{const o=r[1].trim().replace(/ /g,""),n=Number(r[0].slice(0,3));return[...Array(o.length/2)].map((e,t)=>{const i={lane:parseInt(r[0].slice(4,5),16),laneType:Number(r[0].slice(3,4)),measure:n,noteType:parseInt(o[2*t],36),tick:Math.round(s*l[n]/(o.length/2)*t),width:parseInt(o[2*t+1],17)};return 6===r[0].length&&(i.channel=r[0].slice(5,6).toUpperCase().charCodeAt(0)),i}).filter(e=>0!==e.width).forEach(e=>t.push(e)),t},[]));return{BEATs:n,BPMs:function(e,t,i=120){const r=j(e,/^BPM\d{2}:/,3,5),o=j(e,/^\d{3}08:/,0,3).map(e=>{if(r[e])return r[e]});return o[0]=Number(o[0])?o[0]:i,W(o,t)}(i,o,D.getMeta(e).BASEBPM),airActionNotes:U(a,4),airNotes:a.filter(e=>5===e.laneType),holdNotes:U(a,2),measure:o,shortNotes:a.filter(e=>1===e.laneType),slideNotes:U(a,3)}},P=_,Object.defineProperty(P,"__esModule",{value:!0}),F(E),F(B);var Y={};E=Y,Object.defineProperty(E,"__esModule",{value:!0}),E.FlickDirection=E.CurveType=E.NoteType=void 0,(B=E.NoteType||(E.NoteType={}))[B.Tap=0]="Tap",B[B.Flick=1]="Flick",B[B.SlideStart=2]="SlideStart",B[B.SlideInvisible=3]="SlideInvisible",B[B.SlideVisible=4]="SlideVisible",B[B.SlideEndDefault=5]="SlideEndDefault",B[B.SlideEndFlick=6]="SlideEndFlick",(B=E.CurveType||(E.CurveType={}))[B.None=0]="None",B[B.Linear=1]="Linear",B[B.EaseIn=2]="EaseIn",B[B.EaseOut=3]="EaseOut",B[B.EaseInOut=4]="EaseInOut",B[B.CubicBezier=5]="CubicBezier",(E=E.FlickDirection||(E.FlickDirection={}))[E.Up=0]="Up",E[E.Left=1]="Left",E[E.Right=2]="Right";const z=I["v4"],X=_,{NoteType:$,CurveType:V,FlickDirection:G}=Y;function q(e,t){return X.getScore(e,t)}function K(e,t){return e.measure===t.measure&&e.tick===t.tick&&e.lane===t.lane&&e.width===t.width}function Z(e,t,i){var r=function(e,t){if(0===e||0===t)return Math.max(e,t,1);for(;0!==t;){var i=t;t=e%t,e=i}return e}(t%i,i);return[4*e+Math.floor(t/i),t%i/r,t?i/r:1]}var E={convertor:function(e){const l=q(e,480),r=z(),o={timelines:[{id:r,name:"Timeline 1"}],bpms:[{id:z(),timeline:r,beat:[0,0,1],bpm:l.BPMs[0]}],notes:[],slides:[]};return l.slideNotes.forEach(e=>{const s={id:z(),timeline:r,notes:[]};e.forEach((t,e)=>{var i=l.airNotes.findIndex(e=>K(t,e)),r=l.shortNotes.findIndex(e=>3===e.noteType&&K(t,e)),o=l.shortNotes.findIndex(e=>K(t,e));const n={id:z(),type:{1:$.SlideStart,2:$.SlideEndDefault,3:$.SlideVisible,5:$.SlideInvisible}[t.noteType],beat:Z(t.measure,t.tick,480),lane:t.lane-2,width:t.width,curve:V.Linear};0===e&&-1!==o&&2===l.shortNotes[o].noteType?(l.shortNotes.splice(o,1),s.critical=!0):n.type===$.SlideEndDefault&&-1!==i?([e]=l.airNotes.splice(i,1),n.type=$.SlideEndFlick,n.direction=3===e.noteType?G.Left:4===e.noteType?G.Right:G.Up,-1!==o&&([e]=l.shortNotes.splice(o,1),2===e.noteType&&(n.critical=!0))):-1!==i&&-1!==o&&(l.shortNotes.splice(o,1),[i]=l.airNotes.splice(i,1),n.curve={2:V.EaseIn,5:V.EaseOut,6:V.EaseOut}[i.noteType]),-1!==r&&n.type===$.SlideVisible&&(l.shortNotes.splice(r,1),delete n.width,delete n.lane,delete n.curve),s.notes.push(n)}),o.slides.push(s)}),l.shortNotes.forEach(t=>{if(!(t.lane<2||13<t.lane)){var e=l.airNotes.find(e=>K(e,t));const i={id:z(),timeline:r,type:e?$.Flick:$.Tap,beat:Z(t.measure,t.tick,480),lane:t.lane-2,width:t.width};2===t.noteType&&(i.critical=!0),e&&(i.direction=3===e.noteType?G.Left:4===e.noteType?G.Right:G.Up),o.notes.push(i)}}),o}}["convertor"],J=E;class Q{constructor(e){this.editor=e,this._totalTime=10,this._follow=!1,this._playing=!1,this.playTicker=new s.Ticker,this.playTicker.autoStart=!1}async getBuffer(e){const t=await fetch(e);e=await t.arrayBuffer();return this.audioContext.decodeAudioData(e)}loadAudio(e){this.audio=new Audio,this.audioContext=new AudioContext,this.audio.addEventListener("loadeddata",()=>{this.editor.renderer.render()}),this.audio.addEventListener("ended",()=>{this._playing=!1}),this.audio.src=URL.createObjectURL(e),this.audioSource=this.audioContext.createMediaElementSource(this.audio),this.audioSource.connect(this.audioContext.destination)}async play(){this.audio&&!this.playing&&(await this.audio.play(),this._playing=!0,this.playTicker.start())}stop(){this.pause(),this.currentTime=0,this.editor.renderer.updateCurrentTimeLine()}pause(){this.playing&&this.audioSource&&(this.audio.pause(),this._playing=!1,this.playTicker.stop())}get currentTime(){return this.audio?.currentTime||0}set currentTime(e){this.audio&&(this.audio.currentTime=e)}get totalTime(){return this.audio?.duration||this._totalTime}set totalTime(e){this._totalTime=e,this.editor.renderer.parseAndRender()}get follow(){return this._follow}set follow(e){this._follow=e,this.editor.renderer.render()}get playing(){return this._playing}}class ee{constructor(e){this.editor=e}getTimeByBeat(t,i){let r=0;var o=this.map.bpms.filter(e=>e.timeline===i);for(let e=0;e<o.length;e++){var n=o[e],s=this.editor.fraction(n.beat);if(t.le(s))break;var l=o[e+1];const a=l?this.editor.fraction(l.beat):null;r+=(l&&t.gt(a)?a:t).minus(s).decimal/n.bpm*60}return r}getHeightByBeat(e,t){return this.editor.const.spaceY+this.getTimeByBeat(e,t)*this.editor.const.heightPerSecond}getHeightByTime(e){return this.editor.const.spaceY+e*this.editor.const.heightPerSecond}getYInCanvas(e){return this.editor.const.height-(e-this.editor.scrollController.scrollBottom)}getLaneX(e){return this.editor.const.width*(6*e+14)/100}getLaneWidth(e){return this.editor.const.width*(6*e)/100}get map(){return this.editor.map}}const te={background:16777215,primeLane:0,primeLaneAlpha:1,secondaryLane:0,secondaryLaneAlpha:.2,bpmLine:65535,timeText:0,currentTimeLine:16711680,beatLineWhole:0,beatLineWholeAlpha:1,beatLineHalf:0,beatLineHalfAlpha:.2,beatLineThird:16711680,beatLineThirdAlpha:.4,beatLineQuarter:255,beatLineQuarterAlpha:.4,slideCurve:14285551,slideCurveAlpha:.8,slideInvisibleNode:3204520,slideCriticalCurve:16579021,slideCriticalCurveAlpha:.8,slideCriticalInvisibleNode:15852573,selectionBox:233724,selectionBoxAlpha:.2,selectionRect:233724,cursor:0};class ie{constructor(e){this.editor=e,this._resolution=window.devicePixelRatio,this._fontSize=18,this._paddingX=4,this._paddingY=2,this._heightPerSecond=500,this._lineWidth=1,this._invisibleLineWidth=3,this._cursorLineWidth=3,this._noteHeight=32,this._arrowHeight=32,this._curveRenderStep=8;var{width:t,height:e}=this.editor.container.getBoundingClientRect();this._width=t,this._height=e}get width(){return this._width}set width(e){this._width=e}get height(){return this._height}set height(e){this._height=e}get maxHeight(){return this.heightPerSecond*this.editor.audioManager.totalTime+2*this.spaceY}get resolution(){return this._resolution}set resolution(e){this._resolution=e}get fontSizeRaw(){return this._fontSize}set fontSizeRaw(e){this._fontSize=e}get fontSize(){return this._fontSize/this.resolution}get paddingXRaw(){return this._paddingX}set paddingXRaw(e){this._paddingX=e}get paddingX(){return this._paddingX/this.resolution}get paddingYRaw(){return this._paddingY}set paddingYRaw(e){this._paddingY=e}get paddingY(){return this._paddingY/this.resolution}get heightPerSecondRaw(){return this._heightPerSecond}set heightPerSecondRaw(e){var t;e<100||2e3<e||(t=(this.editor.scrollController.scrollBottom-this.spaceY)/this._heightPerSecond,this._heightPerSecond=e,this.editor.scrollController.scrollBottom=t*this._heightPerSecond+this.spaceY,this.editor.renderer.parseAndRender())}get heightPerSecond(){return this._heightPerSecond/this.resolution}get spaceY(){return this.heightPerSecond/2}get lineWidthRaw(){return this._lineWidth}set lineWidthRaw(e){this._lineWidth=e}get lineWidth(){return this._lineWidth/this.resolution}get invisibleLineWidthRaw(){return this._invisibleLineWidth}set invisibleLineWidthRaw(e){this._invisibleLineWidth=e}get invisibleLineWidth(){return this._invisibleLineWidth/this.resolution}get cursorLineWidthRaw(){return this._cursorLineWidth}set cursorLineWidthRaw(e){this._cursorLineWidth=e}get cursorLineWidth(){return this._cursorLineWidth/this.resolution}get noteHeightRaw(){return this._noteHeight}set noteHeightRaw(e){this._noteHeight=e}get noteHeight(){return this._noteHeight/this.resolution}get arrowHeightRaw(){return this._arrowHeight}set arrowHeightRaw(e){this._arrowHeight=e}get arrowHeight(){return this._arrowHeight/this.resolution}get curveRenderStepRaw(){return this._curveRenderStep}set curveRenderStepRaw(e){this._curveRenderStep=e}get curveRenderStep(){return this._curveRenderStep/this.resolution}}class re{constructor(e){this.editor=e}getCursorPosition(){var t=this.editor.scrollController.scrollBottom+this.editor.const.height-this.editor.handler.lastMousePosition.y;let i=0,r=this.editor.fraction([0,0,1]);var o=this.editor.beatSlice;for(let e=0;;e++){var n=this.editor.fraction([Math.floor(e/o),e%o,o]),s=this.editor.calculator.getHeightByBeat(n,this.editor.timeLineManager.prime);if(s<t)i=t-s,r=n;else if(t<=s){var l=s-t,s=this.editor.handler.lastMousePosition.x-this.editor.calculator.getLaneX(0),s=Math.floor(s/(.06*this.editor.const.width));return[l<i?n:r,s]}}}}var oe={},I={},_={};Object.defineProperty(_,"__esModule",{value:!0}),_.DenominatorZeroError=void 0;class ne extends Error{constructor(e){super(),this.name="DenominatorZeroError",this.message=`Denominator cannot be zero: [${e.toString()}]`}}_.DenominatorZeroError=ne,Object.defineProperty(I,"__esModule",{value:!0}),I.Fraction=void 0;const se=oe,le=_;I.Fraction=class ke{constructor(e){if(0===e[3])throw new le.DenominatorZeroError(e);this.frac=e}static fromInteger(e){return new ke([e/Math.abs(e),Math.abs(e),0,1])}eq(e){var t=this.simplified,e=e.simplified;return t.sign===e.sign&&t.integer===e.integer&&t.numerator===e.numerator&&t.denominator===e.denominator}gt(e){return 0<this.sign&&e.sign<0||(0<this.sign&&0<e.sign?this.integer>e.integer||this.integer===e.integer&&(this.denominator===e.denominator?this.numerator>e.numerator:this.reduceToCommonDenominator(e).numerator>e.reduceToCommonDenominator(this).numerator):!this.opposite.gt(e.opposite))}ge(e){return this.gt(e)||this.eq(e)}lt(e){return!this.ge(e)}le(e){return!this.gt(e)}add(e){if(this.sign!==e.sign)return this.sign<0?e.minus(this.opposite):this.minus(e.opposite);var t=this.reduceToCommonDenominator(e),e=e.reduceToCommonDenominator(this);return new ke([this.sign,t.integer+e.integer,t.numerator+e.numerator,this.denominator])}minus(e){if(this.sign===-e.sign)return this.add(e.opposite);if(0<this.sign){if(this.ge(e)){var t=this.reduceToCommonDenominator(e).improper,i=e.reduceToCommonDenominator(this).improper;return new ke([this.sign,0,t.numerator-i.numerator,t.denominator]).simplified}return e.minus(this).opposite}return this.opposite.minus(e.opposite).opposite}reduceToCommonDenominator(e){if(this.denominator===e.denominator)return this.copy;var t=this.simplified,e=e.simplified,e=se.MathUtils.lcm(t.denominator,e.denominator);return new ke([t.sign,t.integer,t.numerator*(e/t.denominator),e])}get improper(){const e=this.copy;return e.numerator+=e.integer*e.denominator,e.integer=0,e}get simplified(){const e=this.copy;var t;return e.integer<0&&(e.integer=-e.integer,e.sign=-e.sign),e.numerator<0&&(e.numerator=-e.numerator,e.sign=-e.sign),e.denominator<0&&(e.denominator=-e.denominator,e.sign=-e.sign),1!==(t=se.MathUtils.gcd(e.numerator,e.denominator))&&(e.numerator=e.numerator/t,e.denominator=e.denominator/t),e.numerator>=e.denominator&&(t=Math.floor(e.numerator/e.denominator),e.numerator-=t*e.denominator,e.integer+=t),e}get decimal(){return this.sign*(this.integer+this.numerator/this.denominator)}get fraction(){return[...this.frac]}set fraction(e){this.frac=e}get opposite(){return new ke([-this.sign,this.integer,this.numerator,this.denominator])}get abs(){return new ke([1,this.integer,this.numerator,this.denominator])}get copy(){return new ke([this.sign,this.integer,this.numerator,this.denominator])}get sign(){return this.frac[0]}set sign(e){this.frac[0]=e}get integer(){return this.frac[1]}set integer(e){this.frac[1]=e}get numerator(){return this.frac[2]}set numerator(e){this.frac[2]=e}get denominator(){return this.frac[3]}set denominator(e){this.frac[3]=e}};var ae,de,E={};Object.defineProperty(E,"__esModule",{value:!0}),E.MathUtils=void 0;class he{static gcd(e,t){if(0===e||0===t)return Math.max(e+t,1);for(;0!==t;){var i=t;t=e%t,e=i}return e}static lcm(e,t){return Math.abs(e*t)/he.gcd(e,t)}}E.MathUtils=he,_=oe,ae=i&&i.__createBinding||(Object.create?function(e,t,i,r){void 0===r&&(r=i),Object.defineProperty(e,r,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,r){e[r=void 0===r?i:r]=t[i]}),i=i&&i.__exportStar||function(e,t){for(var i in e)"default"===i||Object.prototype.hasOwnProperty.call(t,i)||ae(t,e,i)},Object.defineProperty(_,"__esModule",{value:!0}),i(I,_),i(E,_);class ce extends s.utils.EventEmitter{constructor(e){super(),this.editor=e}dispatchScrollEvent(e,t){this.emit(de.Scroll,{oldScrollBottom:e,newScrollBottom:t})}dispatchSelectEvent(){var e=JSON.parse(JSON.stringify(this.editor.selectionManager.selection));this.editor.selectionManager.isSelectionEqual(this.editor.selectionManager.oldSelection,e)||(this.editor.event.emit(de.Select,{oldSelection:this.editor.selectionManager.oldSelection,newSelection:e}),this.editor.selectionManager.oldSelection=JSON.parse(JSON.stringify(e)))}dispatchAudioTimeUpdateEvent(){this.emit(de.AudioTimeUpdate,{currentTime:this.editor.audioManager.currentTime})}dispatchDestroyEvent(){this.emit(de.Destroy)}}(_=de=de||{}).Scroll="scroll",_.Destroy="destroy",_.Select="select",_.AudioTimeUpdate="audioTimeUpdate";class ue{constructor(e){this.editor=e,this.lastMousePosition={x:0,y:0},this.windowMouseUpHandler=this._windowMouseUpHandler.bind(this),this.selectAreaMouseMoveWhenMouseDownHandler=this._selectAreaMouseMoveWhenMouseDownHandler.bind(this)}listen(){this.editor.renderer.app.view.addEventListener("wheel",this.mouseWheelHandler.bind(this)),this.editor.renderer.app.stage.on("mousedown",this.selectAreaMouseDownHandler.bind(this)),this.editor.renderer.app.stage.on("mousemove",this.selectAreaMouseMoveHandler.bind(this)),this.scrollController.scrollTicker.add(this.scrollTickerHandler.bind(this)),this.editor.audioManager.playTicker.add(this.audioPlayTickerHandler.bind(this)),this.editor.event.on(de.Scroll,()=>{var[e,t]=this.editor.cursorManager.getCursorPosition();this.editor.renderer.updateCursorPosition(e,t)})}mouseWheelHandler(e){e=Math.min(this.editor.const.maxHeight-this.editor.const.height,Math.max(0,this.editor.scrollController.scrollBottom-e.deltaY/this.editor.const.resolution));this.editor.scrollController.scrollTo(e)}selectAreaMouseDownHandler(e){var t;0===e.data.button&&(e.data.originalEvent.ctrlKey||this.editor.selectionManager.emptySelection(),e=(t=e.data.global).x,t=this.editor.scrollController.scrollBottom+(this.editor.const.height-t.y),this.editor.selectionManager.selectionBox=[e,t,e,t],this.editor.renderer.app.stage.on("mousemove",this.selectAreaMouseMoveWhenMouseDownHandler),this.editor.event.on(de.Scroll,this.selectAreaMouseMoveWhenMouseDownHandler),this.editor.renderer.render(),window.addEventListener("mouseup",this.windowMouseUpHandler))}_selectAreaMouseMoveWhenMouseDownHandler(){var e=this.lastMousePosition;this.selectionManager.selectionBox[2]=e.x,this.selectionManager.selectionBox[3]=this.scrollController.scrollBottom+(this.editor.const.height-e.y);var t=this.editor.const.height/20,i=this.editor.const.height-t;e.y<t||e.y>i?(this.scrollController.scrollTicker.started||this.scrollController.scrollTicker.start(),this.scrollController.autoScrollDelta=((e.y<t?t:i)-e.y)/(t/10)):(this.scrollController.autoScrollDelta=0,this.scrollController.scrollTicker.stop()),this.editor.selectionManager.findSelectedNote(),this.editor.renderer.render()}_windowMouseUpHandler(){window.removeEventListener("mouseup",this.windowMouseUpHandler),this.selectionManager.selectionBox=[0,0,0,0],this.editor.renderer.app.stage.off("mousemove",this.selectAreaMouseMoveWhenMouseDownHandler),this.editor.event.off(de.Scroll,this.selectAreaMouseMoveWhenMouseDownHandler),this.scrollController.autoScrollDelta=0,this.scrollController.scrollTicker.stop(),this.selectionManager.mergeTempSelection(),this.editor.event.dispatchSelectEvent(),this.editor.renderer.render()}selectAreaMouseMoveHandler(e){var t;this.lastMousePosition.x=e.data.global.x,this.lastMousePosition.y=e.data.global.y,this.editor.map&&([t,e]=this.editor.cursorManager.getCursorPosition(),this.editor.renderer.updateCursorPosition(t,e))}scrollTickerHandler(){this.editor.scrollController.scrollTo(this.editor.scrollController.scrollBottom+this.editor.scrollController.autoScrollDelta)}audioPlayTickerHandler(){var e;this.editor.event.dispatchAudioTimeUpdateEvent(),this.editor.audioManager.follow?(e=this.editor.calculator.getHeightByTime(this.editor.audioManager.currentTime),this.editor.scrollController.scrollBottom=e-this.editor.const.spaceY):this.editor.renderer.updateCurrentTimeLine()}get selectionManager(){return this.editor.selectionManager}get scrollController(){return this.editor.scrollController}}var ge=4,pe=1e-7,me=10,fe="function"==typeof Float32Array;function ve(e,t){return 1-3*t+3*e}function ye(e,t,i){return((ve(t,i)*e+(3*i-6*t))*e+3*t)*e}function be(e,t,i){return 3*ve(t,i)*e*e+2*(3*i-6*t)*e+3*t}function we(e){return e}function Se(n,t,s,i){if(!(0<=n&&n<=1&&0<=s&&s<=1))throw new Error("bezier x values must be in [0, 1] range");if(n===t&&s===i)return we;for(var l=new(fe?Float32Array:Array)(11),e=0;e<11;++e)l[e]=ye(.1*e,n,s);function r(e){for(var t=0,i=1;10!==i&&l[i]<=e;++i)t+=.1;var r=t+.1*((e-l[--i])/(l[i+1]-l[i])),o=be(r,n,s);return.001<=o?function(e,t,i,r){for(var o=0;o<ge;++o){var n=be(t,i,r);if(0===n)return t;t-=(ye(t,i,r)-e)/n}return t}(e,r,n,s):0===o?r:function(e,t,i,r,o){for(var n,s,l=0;0<(n=ye(s=t+(i-t)/2,r,o)-e)?i=s:t=s,Math.abs(n)>pe&&++l<me;);return s}(e,t,t+.1,n,s)}return function(e){return 0===e?0:1===e?1:ye(r(e),t,i)}}class Te{constructor(e){this.editor=e,this.bezier=[!1,[0,0,1,1],[.11,0,.5,0],[.5,1,.89,1],[.45,0,.55,1]],this.initRenderObjects()}initRenderObjects(){this.renderObjects={lanes:[],beatLines:[],texts:[],notes:[],curves:[],arrows:[],visibleNodes:[],invisibleNodes:[]}}parse(){this.initRenderObjects(),this.addLanes(),0<this.map?.timelines.length&&0<this.map?.bpms.length&&(this.parseBeatLines(),this.parseBPMLines(),this.addTimeText(),this.parseNotes(),this.parseSlide())}addLanes(){for(let e=0;e<=12;e++)this.renderObjects.lanes.push({name:`Lane-${e}`,x:this.editor.const.width*((6*e+14)/100),color:e%2?this.editor.color.secondaryLane:this.editor.color.primeLane,alpha:e%2?this.editor.color.secondaryLaneAlpha:this.editor.color.primeLaneAlpha})}parseBeatLines(){var t=this.editor.beatSlice;for(let e=0;;e++){var i=this.editor.fraction([Math.floor(e/t),e%t,t]),r=this.editor.calculator.getTimeByBeat(i,this.editor.timeLineManager.prime),r=this.editor.calculator.getHeightByTime(r);if(r>this.editor.const.maxHeight-this.editor.const.spaceY)break;const o={name:`BeatLine-${i.decimal}`,x:this.editor.calculator.getLaneX(0),width:this.editor.calculator.getLaneWidth(12),scrollHeight:r,color:0,alpha:0};if(e%t==0)o.color=this.editor.color.beatLineWhole,o.alpha=this.editor.color.beatLineWholeAlpha,o.width=this.editor.const.width-this.editor.calculator.getLaneX(0),this.renderObjects.texts.push({name:`BeatLineText-${i.decimal}`,x:this.editor.const.width-this.editor.const.paddingX,fontSize:this.editor.const.fontSize,scrollHeight:r+this.editor.const.paddingY,alignX:"right",alignY:"bottom",color:this.editor.color.beatLineWhole,alpha:this.editor.color.beatLineWholeAlpha,text:`${Math.floor(i.integer/4)+1}:${i.integer%4+1}`});else if(e%(t/2)==0)o.color=this.editor.color.beatLineHalf,o.alpha=this.editor.color.beatLineHalfAlpha;else if(e%(t/3)==0)o.color=this.editor.color.beatLineThird,o.alpha=this.editor.color.beatLineThirdAlpha;else{if(e%(t/4)!=0)continue;o.color=this.editor.color.beatLineQuarter,o.alpha=this.editor.color.beatLineQuarterAlpha}this.renderObjects.beatLines.push(o)}}formatTime(e){return`${Math.floor(e/60).toString().padStart(2,"0")}:${(e%60).toFixed(3).padStart(6,"0")}`}parseBPMLines(){var t=this.map.bpms.filter(e=>e.timeline===this.editor.timeLineManager.prime);for(let e=0;e<t.length;e++){const o=t[e];var i=this.editor.calculator.getTimeByBeat(this.editor.fraction(o.beat),this.editor.timeLineManager.prime),r=this.editor.calculator.getHeightByTime(i);this.renderObjects.beatLines.push({name:`BPM-${o.id}-line`,x:0,width:this.editor.const.width,scrollHeight:r,color:this.editor.color.bpmLine,alpha:1}),this.renderObjects.texts.push({name:`BPM-${o.id}-time`,x:this.editor.const.paddingX,scrollHeight:r+this.editor.const.paddingY,alignY:"bottom",fontSize:this.editor.const.fontSize,color:this.editor.color.bpmLine,alpha:1,text:this.formatTime(i)}),this.renderObjects.texts.push({name:`BPM-${o.id}-value`,x:this.editor.calculator.getLaneX(12)+this.editor.const.paddingX,scrollHeight:r+this.editor.const.paddingY,alignY:"bottom",fontSize:this.editor.const.fontSize,color:this.editor.color.bpmLine,alpha:1,text:o.bpm.toString()})}}addTimeText(){for(let e=0;e<=this.editor.audioManager.totalTime;e++){var t=this.editor.calculator.getHeightByTime(e);const i=this.formatTime(e);this.renderObjects.texts.some(e=>e.text===i)||this.renderObjects.texts.push({name:`Time-${e}`,x:this.editor.calculator.getLaneX(0)-this.editor.const.paddingX,scrollHeight:t,alignX:"right",alignY:"middle",fontSize:this.editor.const.fontSize,color:this.editor.color.timeText,alpha:1,text:i})}}pushFlickObject(e,t,i=!1){const r=Math.min(6,e.width);var o=Math.max(.8,Math.min(4,.6*r));this.renderObjects.arrows.push({name:`Arrow-${e.id}`,x:this.editor.calculator.getLaneX(e.lane+(e.width-o)/2),width:this.editor.calculator.getLaneWidth(o),scrollHeight:t,texture:`flick_arrow_${e.critical||i?"critical_":""}${r.toString().padStart(2,"0")}${{0:"",1:"_left",2:"_right"}[e.direction]}`,id:e.id})}parseNotes(){var t=this.map.notes.filter(e=>this.editor.timeLineManager.visible.includes(e.timeline));for(let e=0;e<t.length;e++){var i=t[e],r=this.editor.calculator.getHeightByBeat(this.editor.fraction(i.beat),i.timeline);i.type===Y.NoteType.Flick&&this.pushFlickObject(i,r),this.renderObjects.notes.push({name:`Note-${i.id}`,x:this.editor.calculator.getLaneX(i.lane-.1),width:this.editor.calculator.getLaneWidth(i.width+.2),scrollHeight:r,texture:i.critical?"critical":i.type?"flick":"tap",id:i.id,alpha:1})}}parseUnPositionedNote(t,i,r){var o=t.notes[i],n=t.notes[r],s=this.editor.calculator.getHeightByBeat(this.editor.fraction(o.beat),t.timeline),l=this.editor.calculator.getHeightByBeat(this.editor.fraction(n.beat),t.timeline),a=[...this.bezier,o.bezier][o.curve];const d=a&&Se(a[0],a[1],a[2],a[3]);for(let e=i+1;e<r;e++){var h=t.notes[e],c=this.editor.calculator.getHeightByBeat(this.editor.fraction(t.notes[e].beat),t.timeline),u=(c-s)/(l-s),g=a?o.lane+(n.lane-o.lane)*d(u):o.lane,u=a?o.width+(n.width-o.width)*d(u):o.width;this.renderObjects.visibleNodes.push({name:`Visible-${h.id}`,x:this.editor.calculator.getLaneX(g),width:this.editor.calculator.getLaneWidth(u),scrollHeight:c,texture:`slide_node${t.critical?"_critical":""}`,id:h.id,slideId:t.id})}}parseSlide(){var t=this.map.slides.filter(e=>this.editor.timeLineManager.visible.includes(e.timeline));for(let e=0;e<t.length;e++){const s=t[e];for(let i=0;i<s.notes.length;i++){var r,o=s.notes[i],n=this.editor.calculator.getHeightByBeat(this.editor.fraction(o.beat),s.timeline);[Y.NoteType.SlideStart,Y.NoteType.SlideEndDefault].includes(o.type)?this.renderObjects.notes.push({name:`SlideNote-${o.id}`,x:this.editor.calculator.getLaneX(o.lane-.1),width:this.editor.calculator.getLaneWidth(o.width+.2),scrollHeight:n,texture:s.critical?"critical":"slide",id:o.id,slideId:s.id,alpha:1}):o.type===Y.NoteType.SlideEndFlick?(this.renderObjects.notes.push({name:`SlideEndFlick-${o.id}`,x:this.editor.calculator.getLaneX(o.lane-.1),width:this.editor.calculator.getLaneWidth(o.width+.2),scrollHeight:n,texture:o.critical||s.critical?"critical":"flick",id:o.id,slideId:s.id,alpha:1}),this.pushFlickObject(o,n,s.critical)):o.type===Y.NoteType.SlideInvisible?this.renderObjects.invisibleNodes.push({name:`Invisible-${o.id}`,x:this.editor.calculator.getLaneX(o.lane+.1),width:this.editor.calculator.getLaneWidth(o.width-.2),scrollHeight:n,color:s.critical?this.editor.color.slideCriticalInvisibleNode:this.editor.color.slideInvisibleNode,id:o.id,slideId:s.id}):o.type===Y.NoteType.SlideVisible&&this.renderObjects.visibleNodes.push({name:`Visible-${o.id}`,x:this.editor.calculator.getLaneX(o.lane),width:this.editor.calculator.getLaneWidth(o.width),scrollHeight:n,texture:`slide_node${s.critical?"_critical":""}`,id:o.id,slideId:s.id});let e=s.notes[i+1];if(void 0===e)break;void 0===e.lane&&(r=s.notes.findIndex((e,t)=>t>i&&void 0!==e.lane),e=s.notes[r],this.parseUnPositionedNote(s,i,r),i=r-1),this.renderObjects.curves.push({name:`Curve-${o.id}`,startScrollHeight:n,endScrollHeight:this.editor.calculator.getHeightByBeat(this.editor.fraction(e.beat),s.timeline),points:[...this.getCurvePoints(this.editor.calculator.getLaneX(o.lane+.1),n,this.editor.calculator.getLaneX(e.lane+.1),this.editor.calculator.getHeightByBeat(this.editor.fraction(e.beat),s.timeline),[...this.bezier,o.bezier][o.curve]),...this.getCurvePoints(this.editor.calculator.getLaneX(o.lane+o.width-.1),n,this.editor.calculator.getLaneX(e.lane+e.width-.1),this.editor.calculator.getHeightByBeat(this.editor.fraction(e.beat),s.timeline),[...this.bezier,o.bezier][o.curve]).reverse()],color:s.critical?this.editor.color.slideCriticalCurve:this.editor.color.slideCurve,alpha:s.critical?this.editor.color.slideCriticalCurveAlpha:this.editor.color.slideCurveAlpha,id:o.id,slideId:s.id})}}}getCurvePoints(i,r,e,o,t){if(!t)return[{x:i,scrollHeight:r},{x:e,scrollHeight:o}];const n=this.editor.const.curveRenderStep;var s=Math.ceil((o-r)/n);const l=Se(t[0],t[1],t[2],t[3]),a=e-i,d=o-r;return new Array(s+1).fill(0).map((e,t)=>{t=Math.min(1,t*n/(o-r));return{x:i+l(t)*a,scrollHeight:r+t*d}})}get map(){return this.editor.map}}class Le extends n.NineSlicePlane{constructor(e,t,i){super(e,91,0,91,0),this.id=t,this.slideId=i,this.interactive=!0}}class Ce extends n.Sprite{constructor(e,t,i){super(e),this.id=t,this.slideId=i,this.interactive=!0}}class Me extends n.NineSlicePlane{constructor(e,t){super(e,91,0,91,0),this.id=t,this.interactive=!0}}class Ee extends n.Container{constructor(e,t,i){super(),this.name="Cursor",this.draw(e,t,i)}draw(e,t,i){const r=new n.Graphics;r.lineStyle(e,i),r.moveTo(0,0),r.lineTo(t,0),this.addChild(r);const o=new n.Graphics;o.lineStyle(e,i),o.moveTo(0,0),o.lineTo(0,t),o.x=t/2,o.y=-t/2,this.addChild(o)}}class xe{constructor(e){this.editor=e,this.textures=s.Loader.shared.resources["images/sprite.json"].textures;var{width:t,height:e}=this.editor.const;this.app=new s.Application({backgroundAlpha:0,width:t,height:e,antialias:!0,resolution:this.editor.const.resolution}),this.app.view.style.width=t+"px",this.app.view.style.height=e+"px",this.editor.container.appendChild(this.app.view),this.app.stage.sortableChildren=!0,this.app.stage.interactive=!0,this.cursor=new Ee(this.editor.const.cursorLineWidth,this.editor.calculator.getLaneWidth(1.2),this.editor.color.cursor),this.cursor.visible=!1,this.cursor.zIndex=15,this.app.stage.addChild(this.cursor),this.containers={lane:null,time:null,note:null,slide:null,arrow:null,selection:null},this.initContainers(),this.initLaneContainer()}initLaneContainer(){this.containers.lane=new s.Container,this.containers.lane.name="Lane",this.app.stage.addChild(this.containers.lane)}updateColorTheme(){}parseAndRender(){this.editor.parser.parse(),this.render()}render(){this.destroyContainers(),this.initContainers(),this.renderBeatLines(),this.renderTexts(),this.renderNotes(),this.renderArrows(),this.renderCurves(),this.renderVisibleNodes(),this.renderInvisibleNodes(),this.renderSelectionBox(),this.updateCurrentTimeLine()}renderOnce(){this.renderBackground(),this.renderLanes(),this.renderCurrentTimeLine()}renderBackground(){this.background=new s.Graphics,this.background.name="Background",this.background.zIndex=-1,this.background.interactive=!0,this.background.beginFill(this.editor.color.background,1),this.background.drawRect(0,0,this.editor.const.width,this.editor.const.height),this.background.endFill(),this.app.stage.addChild(this.background)}renderSelectionBox(){var e=this.editor.selectionManager.selectionBox;if(e[0]!==e[2]&&e[1]!==e[3]){const r=new s.Graphics;r.beginFill(this.editor.color.selectionBox,this.editor.color.selectionBoxAlpha),r.lineStyle(this.editor.const.lineWidth,this.editor.color.selectionBox);var t=this.editor.calculator.getYInCanvas(e[1]),i=this.editor.calculator.getYInCanvas(e[3])-t;r.drawRect(e[0],t,e[2]-e[0],i),r.endFill(),this.containers.selection.addChild(r)}}renderSelectionRect(e,t,i,r,o){const n=new s.Graphics;n.name=e,n.lineStyle(4*this.editor.const.lineWidth,this.editor.color.selectionRect),n.drawRect(t,i,r,o),this.containers.selection.addChild(n)}renderLanes(){for(let e=0;e<this.renderObjects.lanes.length;e++){var t=this.renderObjects.lanes[e];const i=new s.Graphics;i.name=t.name,i.lineStyle(this.editor.const.lineWidth,t.color,t.alpha),i.moveTo(0,0),i.lineTo(0,this.editor.const.height),i.x=t.x,this.containers.lane.addChild(i)}}renderBeatLines(){var t=this.renderObjects.beatLines.filter(e=>e.scrollHeight>=this.editor.scrollController.scrollBottom-this.editor.const.noteHeight&&e.scrollHeight<=this.editor.scrollController.scrollBottom+this.editor.const.height+this.editor.const.noteHeight);for(let e=0;e<t.length;e++){var i=t[e];const r=new s.Graphics;r.name=i.name,r.lineStyle(this.editor.const.lineWidth,i.color,i.alpha),r.moveTo(i.x,0),r.lineTo(i.x+i.width,0),r.y=this.editor.calculator.getYInCanvas(i.scrollHeight),this.containers.time.addChild(r)}}renderCurrentTimeLine(){this.currentTimeLine=new s.Graphics,this.currentTimeLine.name="CurrentTime-line",this.currentTimeLine.lineStyle(this.editor.const.lineWidth,this.editor.color.currentTimeLine,1),this.currentTimeLine.moveTo(0,0),this.currentTimeLine.lineTo(.8*this.editor.const.width,0),this.currentTimeLine.x=.1*this.editor.const.width,this.currentTimeLine.y=this.editor.calculator.getYInCanvas(0),this.currentTimeLine.zIndex=5,this.app.stage.addChild(this.currentTimeLine)}renderTexts(){var t=this.renderObjects.texts.filter(e=>e.scrollHeight>=this.editor.scrollController.scrollBottom&&e.scrollHeight<=this.editor.scrollController.scrollBottom+this.editor.const.height+this.editor.const.fontSize);for(let e=0;e<t.length;e++){var i=t[e];const r=new s.Text(i.text,{fontSize:i.fontSize,fill:i.color});r.name=i.name,r.x=i.x-{left:0,center:.5,right:1}[i.alignX||"left"]*r.width,r.y=this.editor.calculator.getYInCanvas(i.scrollHeight)-{top:0,middle:.5,bottom:1}[i.alignY||"bottom"]*r.height,this.containers.time.addChild(r)}}renderNotes(){var t=this.renderObjects.notes.filter(e=>e.scrollHeight>=this.editor.scrollController.scrollBottom-this.editor.const.noteHeight&&e.scrollHeight<=this.editor.scrollController.scrollBottom+this.editor.const.height+this.editor.const.noteHeight);for(let e=0;e<t.length;e++){var i=t[e];const o=void 0===i.slideId?new Me(this.textures[i.texture],i.id):new Le(this.textures[i.texture],i.id,i.slideId);o.name=i.name;var r=this.editor.const.noteHeight/o.height;o.scale.set(r),o.x=i.x,o.y=this.editor.calculator.getYInCanvas(i.scrollHeight)-this.editor.const.noteHeight/2,o.width=i.width/r,(this.editor.selectionManager.selection.single.includes(o.id)||this.editor.selectionManager.tempSelection.single.includes(o.id)||this.editor.selectionManager.selection.slide[i.slideId]?.includes(i.id)||this.editor.selectionManager.tempSelection.slide[i.slideId]?.includes(i.id))&&this.renderSelectionRect(`SelectionRect-${o.id}`,o.x,o.y,i.width,this.editor.const.noteHeight),this.containers.note.addChild(o)}}renderArrows(){var t=this.renderObjects.arrows.filter(e=>e.scrollHeight>=this.editor.scrollController.scrollBottom-this.editor.const.arrowHeight&&e.scrollHeight<=this.editor.scrollController.scrollBottom+this.editor.const.height+this.editor.const.arrowHeight);for(let e=0;e<t.length;e++){var i=t[e];const n=new s.Sprite(this.textures[i.texture]);n.name=i.name;var r=i.width/n.width,o=n.height*r;n.scale.set(r),n.x=i.x,n.y=this.editor.calculator.getYInCanvas(i.scrollHeight)-o,this.containers.arrow.addChild(n)}}renderCurves(){var t=this.renderObjects.curves.filter(e=>e.startScrollHeight<=this.editor.scrollController.scrollBottom+this.editor.const.height&&e.endScrollHeight>=this.editor.scrollController.scrollBottom);for(let e=0;e<t.length;e++){var i=t[e];const r=new s.Graphics;r.name=i.name,r.beginFill(i.color,i.alpha),r.moveTo(i.points[0].x,this.editor.calculator.getYInCanvas(i.points[0].scrollHeight));for(let e=1;e<i.points.length;e++)r.lineTo(i.points[e].x,this.editor.calculator.getYInCanvas(i.points[e].scrollHeight));r.endFill(),this.containers.slide.addChild(r)}}renderVisibleNodes(){var t=this.renderObjects.visibleNodes.filter(e=>e.scrollHeight>=this.editor.scrollController.scrollBottom-this.editor.const.noteHeight&&e.scrollHeight<=this.editor.scrollController.scrollBottom+this.editor.const.height+this.editor.const.noteHeight);for(let e=0;e<t.length;e++){var i=t[e];const o=new Ce(this.textures[i.texture],i.id,i.slideId);o.name=i.name;var r=this.editor.const.noteHeight/o.height;o.scale.set(r),o.x=i.x+(i.width-o.width)/2,o.y=this.editor.calculator.getYInCanvas(i.scrollHeight)-o.height/2,this.containers.slide.addChild(o),(this.editor.selectionManager.selection.slide[i.slideId]?.includes(i.id)||this.editor.selectionManager.tempSelection.slide[i.slideId]?.includes(i.id))&&(r=this.editor.calculator.getLaneWidth(.1),this.renderSelectionRect(`SelectionRect-${i.id}`,i.x-r,o.y,i.width+2*r,this.editor.const.noteHeight))}}renderInvisibleNodes(){var t=this.renderObjects.invisibleNodes.filter(e=>e.scrollHeight>=this.editor.scrollController.scrollBottom-this.editor.const.noteHeight&&e.scrollHeight<=this.editor.scrollController.scrollBottom+this.editor.const.height+this.editor.const.noteHeight);for(let e=0;e<t.length;e++){var i,r,o=t[e];const n=new s.Graphics;n.name=o.name,n.lineStyle(this.editor.const.invisibleLineWidth,o.color,1),n.moveTo(o.x,0),n.lineTo(o.x+o.width,0),n.y=this.editor.calculator.getYInCanvas(o.scrollHeight),this.containers.slide.addChild(n),(this.editor.selectionManager.selection.slide[o.slideId]?.includes(o.id)||this.editor.selectionManager.tempSelection.slide[o.slideId]?.includes(o.id))&&(i=this.editor.const.noteHeight,r=this.editor.calculator.getLaneWidth(.2),this.renderSelectionRect(`SelectionRect-${o.id}`,o.x-r,n.y-i/2,o.width+2*r,i))}}updateCursorPosition(e,t){e=this.editor.calculator.getHeightByBeat(e,this.editor.timeLineManager.prime);e>this.editor.const.maxHeight-this.editor.const.spaceY||t<0||11<t?this.cursor.visible=!1:(this.cursor.x=this.editor.calculator.getLaneX(t-.1),this.cursor.y=this.editor.calculator.getYInCanvas(e),this.cursor.visible=!0)}updateCurrentTimeLine(){var e,t;this.currentTimeLine&&(t=(e=this.editor.calculator.getHeightByTime(this.editor.audioManager.currentTime))>=this.editor.scrollController.scrollBottom&&e<=this.editor.scrollController.scrollBottom+this.editor.const.height,(this.currentTimeLine.visible=t)&&(this.currentTimeLine.y=this.editor.calculator.getYInCanvas(e)))}initContainers(){this.containers.time=new s.Container,this.containers.note=new s.Container,this.containers.slide=new s.Container,this.containers.arrow=new s.Container,this.containers.selection=new s.Container,this.containers.time.name="Time",this.containers.note.name="Note",this.containers.slide.name="Slide",this.containers.arrow.name="Arrow",this.containers.selection.name="Selection",this.containers.time.zIndex=1,this.containers.arrow.zIndex=2,this.containers.slide.zIndex=3,this.containers.note.zIndex=4,this.containers.selection.zIndex=6,this.app.stage.addChild(this.containers.time),this.app.stage.addChild(this.containers.note),this.app.stage.addChild(this.containers.slide),this.app.stage.addChild(this.containers.arrow),this.app.stage.addChild(this.containers.selection)}destroyContainers(){["time","note","slide","arrow","selection"].forEach(e=>{this.containers[e].destroy({children:!0})})}get renderObjects(){return this.editor.parser.renderObjects}}class Be{constructor(e){this.editor=e,this._scrollBottom=0,this.scrollTicker=new s.Ticker,this.autoScrollDelta=0,this.scrollTicker.autoStart=!1}scrollTo(e){this.editor.audioManager.follow&&(this.editor.audioManager.currentTime=e/this.editor.const.heightPerSecond),this.scrollBottom=e}get scrollBottom(){return this._scrollBottom}set scrollBottom(e){var t=Math.min(this.editor.const.maxHeight-this.editor.const.height,Math.max(0,e));t!==this.scrollBottom&&(e=this._scrollBottom,this._scrollBottom=t,this.editor.event.dispatchScrollEvent(e,this._scrollBottom)),this.editor.renderer.render()}}class Ie{constructor(){this._prime="",this._visible=[]}get prime(){return this._prime}set prime(e){this._prime=e}get visible(){return this._visible}set visible(e){(1===(this._visible=e).length||1<e.length&&!e.includes(this.prime))&&(this.prime=e[0])}}class _e{constructor(e){this.editor=e,this.selection={single:[],slide:{}},this.tempSelection={single:[],slide:{}},this.oldSelection={single:[],slide:{}},this.selectionBox=[0,0,0,0]}emptySelection(){this.selection.single=[],this.selection.slide={}}isUniqueArrayEqual(e,t){return e.length===t.length&&e.every(e=>t.includes(e))}isSelectionEqual(t,i){if(!this.isUniqueArrayEqual(t.single,i.single))return!1;const e=Object.keys(t.slide);var r=Object.keys(i.slide);return!!this.isUniqueArrayEqual(e,r)&&e.every(e=>this.isUniqueArrayEqual(t.slide[e],i.slide[e]))}mergeTempSelection(){this.selection.single.push(...this.tempSelection.single);for(const t in this.tempSelection.slide){var e;Object.prototype.hasOwnProperty.call(this.tempSelection.slide,t)&&(e=this.tempSelection.slide[t],this.selection.slide[t]||(this.selection.slide[t]=[]),this.selection.slide[t].push(...e))}this.tempSelection.single=[],this.tempSelection.slide={}}findSelectedNote(){const r=Math.min(this.selectionBox[1],this.selectionBox[3]),o=Math.max(this.selectionBox[1],this.selectionBox[3]),n=Math.min(this.selectionBox[0],this.selectionBox[2]),s=Math.max(this.selectionBox[0],this.selectionBox[2]);this.tempSelection.single=[],this.tempSelection.slide={};var e=t=>{for(let e=0;e<t.length;e++){var i=t[e];i.scrollHeight>=r&&i.scrollHeight<=o&&i.x>=n&&i.x+i.width<=s&&(void 0===i.slideId||this.selection.slide[i.slideId]?.includes(i.id)?this.selection.single.includes(i.id)||this.tempSelection.single.push(i.id):(this.tempSelection.slide[i.slideId]||(this.tempSelection.slide[i.slideId]=[]),this.tempSelection.slide[i.slideId].push(i.id)))}},t=this.editor.parser.renderObjects;e(t.notes),e(t.visibleNodes),e(t.invisibleNodes)}getNotesBySelection(i){return{single:i.single.map(t=>this.editor.map.notes.find(e=>e.id===t)),slide:Object.keys(i.slide).map(t=>{const e=this.editor.map.slides.find(e=>e.id===t);return{...e,notes:e.notes.filter(e=>i.slide[t].includes(e.id))}})}}deleteNotesBySelection(r){const o={single:[],slide:[]};return this.editor.map.notes=this.editor.map.notes.filter(e=>!r.single.includes(e.id)||(o.single.push(e),!1)),this.editor.map.slides=this.editor.map.slides.map(t=>{if(!r.slide[t.id])return t;const i={...t,notes:[]};return o.slide.push(i),t.notes=t.notes.filter(e=>!r.slide[t.id].includes(e.id)||(i.notes.push(e),!1)),t.notes.forEach((e,t)=>{}),t}).filter(t=>(1===t.notes.length&&o.slide.find(e=>e.id===t.id).notes.push(t.notes[0]),1<t.notes.length)),this.editor.renderer.parseAndRender(),o}}class Ae{constructor(e){this.container=e,this._beatSlice=1,this._color=te,this.const=new ie(this),this.event=new ce(this),this.handler=new ue(this),this.parser=new Te(this),this.calculator=new ee(this),this.scrollController=new Be(this),this.audioManager=new Q(this),this.renderer=new xe(this),this.timeLineManager=new Ie,this.selectionManager=new _e(this),this.cursorManager=new re(this),this.start()}start(){this.handler.listen(),this.renderer.parseAndRender(),this.renderer.renderOnce()}destroy(){this.event.dispatchDestroyEvent(),this.renderer.destroyContainers(),this.renderer.app.destroy(!0,{children:!0})}static loadResource(i,r){return new Promise(e=>{const t=s.Loader.shared;t.add("images/sprite.json").load(()=>{console.log("load resources completed"),e()}),i&&t.onLoad.add(i),r&&t.onError.add(r)})}set map(e){this._map=e,this.timeLineManager.visible.some(e=>this.map.timelines.map(e=>e.id).includes(e))||(this.timeLineManager.visible=[this.map.timelines[0].id]),this.renderer.parseAndRender()}get map(){return this._map}set beatSlice(e){this._beatSlice=e,this.renderer.parseAndRender()}get beatSlice(){return this._beatSlice}get color(){return this._color}set color(e){this._color=e,this.renderer.updateColorTheme(),this.renderer.parseAndRender()}fraction(e){return new oe.Fraction([1,...e])}}var Oe,He,Ne,Re;Oe="* {\n\tmargin: 0;\n}\n\nhtml, body {\n\twidth: 100%;\n\theight: 100%;\n}\n\nbody {\n\tuser-select: none;\n}\n\n#selector {\n\theight: 80px;\n\tposition: relative;\n}\n\n#app {\n\theight: calc(100% - 85px);\n\t max-width: 600px;\n}\n",Re=(He=void 0===He?{}:He).insertAt,Oe&&"undefined"!=typeof document&&(Ne=document.head||document.getElementsByTagName("head")[0],(He=document.createElement("style")).type="text/css","top"===Re&&Ne.firstChild?Ne.insertBefore(He,Ne.firstChild):Ne.appendChild(He),He.styleSheet?He.styleSheet.cssText=Oe:He.appendChild(document.createTextNode(Oe))),document.addEventListener("DOMContentLoaded",async function(){console.log("ready"),await Ae.loadResource((e,t)=>{console.log(`${e.progress}% loading: ${t.url}`)});const e=document.getElementById("app"),t=new Ae(e);console.log(t);const i=document.getElementById("load"),r=document.getElementById("id"),o=document.getElementById("diff"),n=e=>{t.map=e,t.beatSlice=1,t.audioManager.totalTime=180,t.scrollController.scrollTo(0)};i.addEventListener("click",async()=>{const e=await fetch(`https://assets.pjsek.ai/file/pjsekai-assets/startapp/music/music_score/${r.value.padStart(4,"0")}_01/${o.value}`);var t=J(await e.text());n(t)});const s=document.getElementById("input"),l=document.getElementById("container"),a=document.getElementById("text"),d=document.getElementById("draw");s.addEventListener("click",()=>{l.style.display="none"===l.style.display?"block":"none"}),d.addEventListener("click",()=>{var e;l.style.display="none",a.value&&(e=J(a.value),n(e))});const h=document.getElementById("add"),c=document.getElementById("minus"),u=e=>{t.const.heightPerSecondRaw*=e};h.addEventListener("click",()=>{u(1.5)}),c.addEventListener("click",()=>{u(1/1.5)});const g=document.getElementById("bottom"),p=document.getElementById("scroll");t.event.on(de.Scroll,e=>{g.value=e.newScrollBottom.toString()}),p.addEventListener("click",()=>{t.scrollController.scrollTo(parseInt(g.value))});const m=document.getElementById("music"),f=document.getElementById("play"),v=document.getElementById("pause"),y=document.getElementById("stop"),b=document.getElementById("follow");m.addEventListener("input",()=>{var e=m.files[0];t.audioManager.loadAudio(e)}),f.addEventListener("click",()=>{t.audioManager.play()}),v.addEventListener("click",()=>{t.audioManager.pause()}),y.addEventListener("click",()=>{t.audioManager.stop()}),b.addEventListener("input",()=>{t.audioManager.follow=b.checked});const w=document.getElementById("delete");w.addEventListener("click",()=>{t.selectionManager.deleteNotesBySelection(t.selectionManager.selection)});const S=await fetch("map/lzn.json"),T=await S.json();n(T)})}(PIXI);
