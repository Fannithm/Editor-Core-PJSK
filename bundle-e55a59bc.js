!function(o){"use strict";function e(i){if(i&&i.__esModule)return i;var n=Object.create(null);return i&&Object.keys(i).forEach(function(e){var t;"default"!==e&&(t=Object.getOwnPropertyDescriptor(i,e),Object.defineProperty(n,e,t.get?t:{enumerable:!0,get:function(){return i[e]}}))}),n.default=i,Object.freeze(n)}var c=e(o),t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function i(i){if(i.__esModule)return i;var n=Object.defineProperty({},"__esModule",{value:!0});return Object.keys(i).forEach(function(e){var t=Object.getOwnPropertyDescriptor(i,e);Object.defineProperty(n,e,t.get?t:{enumerable:!0,get:function(){return i[e]}})}),n}var u={},n={};K=n,Object.defineProperty(K,"__esModule",{value:!0}),K.MapTypeInfo=K.DiffColor=K.ResourceTypeName=void 0,K.ResourceTypeName={[0]:"Other",1:"Meta",2:"Map",3:"Audio",4:"Image",5:"Video",6:"Script"},($=K.DiffColor||(K.DiffColor={})).BLUE="blue",$.GREEN="green",$.YELLOW="yellow",$.RED="red",$.PURPLE="purple",$.PINK="pink",K.MapTypeInfo={[0]:{name:"Project Sekai",version:1},1:{name:"BanG Dream",version:1}};var s,r={};$=r,Object.defineProperty($,"__esModule",{value:!0}),$.FlickDirection=$.CurveType=$.NoteType=void 0,(K=$.NoteType||($.NoteType={}))[K.Tap=0]="Tap",K[K.Flick=1]="Flick",K[K.SlideStart=2]="SlideStart",K[K.SlideInvisible=3]="SlideInvisible",K[K.SlideVisible=4]="SlideVisible",K[K.SlideEndDefault=5]="SlideEndDefault",K[K.SlideEndFlick=6]="SlideEndFlick",(K=$.CurveType||($.CurveType={}))[K.None=0]="None",K[K.Linear=1]="Linear",K[K.EaseIn=2]="EaseIn",K[K.EaseOut=3]="EaseOut",K[K.EaseInOut=4]="EaseInOut",K[K.CubicBezier=5]="CubicBezier",($=$.FlickDirection||($.FlickDirection={}))[$.Up=0]="Up",$[$.Left=1]="Left",$[$.Right=2]="Right",K=u,s=t&&t.__createBinding||(Object.create?function(e,t,i,n){void 0===n&&(n=i),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[i]}})}:function(e,t,i,n){e[n=void 0===n?i:n]=t[i]}),$=t&&t.__exportStar||function(e,t){for(var i in e)"default"===i||Object.prototype.hasOwnProperty.call(t,i)||s(t,e,i)},Object.defineProperty(K,"__esModule",{value:!0}),K.PJSK=void 0,$(n,K),K.PJSK=r;var l=4,h=1e-7,d=10,p="function"==typeof Float32Array;function a(e,t){return 1-3*t+3*e}function g(e,t){return 3*t-6*e}function m(e,t,i){return((a(t,i)*e+g(t,i))*e+3*t)*e}function f(e,t,i){return 3*a(t,i)*e*e+2*g(t,i)*e+3*t}function v(e){return e}function w(o,t,r,i){if(!(0<=o&&o<=1&&0<=r&&r<=1))throw new Error("bezier x values must be in [0, 1] range");if(o===t&&r===i)return v;for(var a=new(p?Float32Array:Array)(11),e=0;e<11;++e)a[e]=m(.1*e,o,r);function n(e){for(var t=0,i=1;10!==i&&a[i]<=e;++i)t+=.1;var n=t+.1*((e-a[--i])/(a[i+1]-a[i])),s=f(n,o,r);return.001<=s?function(e,t,i,n){for(var s=0;s<l;++s){var o=f(t,i,n);if(0===o)return t;t-=(m(t,i,n)-e)/o}return t}(e,n,o,r):0===s?n:function(e,t,i,n,s){for(var o,r,a=0;0<(o=m(r=t+(i-t)/2,n,s)-e)?i=r:t=r,Math.abs(o)>h&&++a<d;);return r}(e,t,t+.1,o,r)}return function(e){return 0===e?0:1===e?1:m(n(e),t,i)}}var y,S;class b extends o.NineSlicePlane{constructor(e,t){super(e,91,0,91,0),this.interactive=!0,this.id=t.id}}class B extends o.NineSlicePlane{constructor(e,t,i){super(e,91,0,91,0),this.interactive=!0,this.id=t.id,this.slideId=i.id}}(t=y=y||{}).Scroll="scroll",t.Destroy="destroy",t.Select="select";class E extends o.Sprite{constructor(e,t,i){super(e),this.interactive=!0,this.id=t.id,this.slideId=i.id}}class T extends o.Container{constructor(e,t,i){super(),this.name="Cursor",this.draw(e,t,i)}draw(e,t,i){const n=new o.Graphics;n.lineStyle(e,i),n.moveTo(0,0),n.lineTo(t,0),this.addChild(n);const s=new o.Graphics;s.lineStyle(e,i),s.moveTo(0,0),s.lineTo(0,t),s.x=t/2,s.y=-t/2,this.addChild(s)}}class C{constructor(e,t,i){this.scrollBottom=0,this.colors={background:16777215,lane:0,bpm:65535,time:16711680,beat:{third:16711680,half:0,quarter:255},slide:14285551,slideNote:3204520,critical:16579021,criticalNote:15852573,selection:233724,cursor:0};var{width:n,height:s}=e.getBoundingClientRect(),o=window.devicePixelRatio;this.resolution=o,this.setMap(t),this.app=new c.Application({backgroundAlpha:0,width:n,height:s,antialias:!0,resolution:o}),this.const={resolution:o,fontSize:18/o,heightPerSecond:500/o,spaceY:200/o,width:n,height:s,paddingX:4/o,paddingY:2/o,lineWidth:1/o,noteHeight:32/o,arrowHeight:32/o,maxHeight:0,cursorLineWidth:3/o},this.time=i,this.currentTime=0,this.const.maxHeight=this.const.heightPerSecond*i+2*this.const.spaceY,this.container={lane:new c.Container,time:new c.Container,note:new c.Container,slide:new c.Container,arrow:new c.Container,selection:new c.Container,cursor:new T(this.const.cursorLineWidth,.06*this.const.width*1.2,this.colors.cursor)},this.scrollBottom/=o,this.app.view.style.width=n+"px",this.app.view.style.height=s+"px",e.appendChild(this.app.view),this.app.stage.addChild(this.container.cursor),this.container.cursor.visible=!1,this.container.cursor.zIndex=15,this.app.stage.addChild(this.container.lane),this.app.stage.sortableChildren=!0,this.app.stage.interactive=!0,this.container.lane.name="Lane",this.notes=c.Loader.shared.resources["images/sprite.json"].textures,this.event=new EventTarget,this.selection={single:[],slide:{}},this.tempSelection={single:[],slide:{}},this.selectionBox=[0,0,0,0],this.scrollTicker=new c.Ticker,this.scrollTicker.autoStart=!1,this.scrollTicker.add(this.scrollTickerHandler.bind(this)),this.beatSlice=4,this.lastMouseCursorPosition={x:0,y:0},this.start()}start(){this.drawLane();const e=new c.Graphics;e.name="SelectArea",e.beginFill(this.colors.background,1),e.drawRect(0,0,this.const.width,this.const.height),e.zIndex=-1,e.interactive=!0,e.endFill(),this.app.stage.addChild(e),this.listen(e),this.reRender()}listen(i){this.app.view.addEventListener("wheel",e=>{e=Math.min(this.const.maxHeight-this.const.height,Math.max(0,this.scrollBottom-e.deltaY/this.resolution));this.scrollTo(e)});const n=this.selectAreaMoveHandler.bind(this);this.oldSelection={single:[],slide:{}},i.on("mousedown",e=>{var t;0===e.data.button&&(e.data.originalEvent.ctrlKey||this.emptySelection(),e=(t=e.data.global).x,t=this.scrollBottom+(this.const.height-t.y),this.selectionBox=[e,t,e,t],i.on("mousemove",n),this.event.addEventListener(y.Scroll,n),this.reRender(),window.addEventListener("mouseup",s))});const s=()=>{window.removeEventListener("mouseup",s),this.selectionBox=[0,0,0,0],i.off("mousemove",n),this.event.removeEventListener(y.Scroll,n),this.autoScrollDelta=0,this.scrollTicker.stop(),this.selection.single.push(...this.tempSelection.single);for(const t in this.tempSelection.slide){var e;Object.prototype.hasOwnProperty.call(this.tempSelection.slide,t)&&(e=this.tempSelection.slide[t],this.selection.slide[t]||(this.selection.slide[t]=[]),this.selection.slide[t].push(...e))}this.tempSelection.single=[],this.tempSelection.slide={},this.dispatchSelectEvent(),this.reRender()};i.on("mousemove",e=>{this.lastMouseCursorPosition.x=e.data.global.x,this.lastMouseCursorPosition.y=e.data.global.y;var[t,e]=this.getCursorPosition();this.moveCursor(t,e)}),this.event.addEventListener(y.Scroll,()=>{var[e,t]=this.getCursorPosition();this.moveCursor(e,t)})}dispatchSelectEvent(){var e=JSON.parse(JSON.stringify(this.selection));this.isSelectionEqual(this.oldSelection,e)||(console.log(e),this.event.dispatchEvent(new CustomEvent(y.Select,{detail:{oldSelection:this.oldSelection,newSelection:e}})),this.oldSelection=JSON.parse(JSON.stringify(e)))}selectAreaMoveHandler(){var e=this.lastMouseCursorPosition;this.selectionBox[2]=e.x,this.selectionBox[3]=this.scrollBottom+(this.const.height-e.y);var t=this.const.height/20,i=this.const.height-t;e.y<t||e.y>i?(this.scrollTicker.started||this.scrollTicker.start(),this.autoScrollDelta=((e.y<t?t:i)-e.y)/(t/10)):(this.autoScrollDelta=0,this.scrollTicker.stop()),this.findSelectedNote(),this.reRender()}findSelectedNote(){var n=Math.min(this.selectionBox[1],this.selectionBox[3]),s=Math.max(this.selectionBox[1],this.selectionBox[3]),o=Math.min(this.selectionBox[0],this.selectionBox[2]),r=Math.max(this.selectionBox[0],this.selectionBox[2]);this.tempSelection.single=[],this.tempSelection.slide={};for(let e=0;e<this.map.notes.length;e++){var t=this.map.notes[e],i=this.getHeightByBeat(t.beat),a=this.getLaneX(t.lane),l=this.getLaneX(t.lane+t.width);if(n<=i&&i<=s&&o<=a&&l<=r&&!this.selection.single.includes(t.id))this.tempSelection.single.push(t.id);else if(s<i)break}for(let e=0;e<this.map.slides.length;e++){const f=this.map.slides[e];if(!(this.getHeightByBeat(f.notes[f.notes.length-1].beat)<n))for(let i=0;i<f.notes.length;i++){var c=f.notes[i],h=this.getHeightByBeat(c.beat);let e=void 0!==c.lane?this.getLaneX(c.lane):0,t=void 0!==c.lane?this.getLaneX(c.lane+c.width):0;if(void 0===c.lane){const v=f.notes.length-i-1;var d=f.notes.concat().reverse().find((e,t)=>t>v&&void 0!==e.lane),u=f.notes.find((e,t)=>t>i&&void 0!==e.lane),p=this.getHeightByBeat(d.beat),g=(h-p)/(this.getHeightByBeat(u.beat)-p),m=[!1,[0,0,1,1],[0,0,0,.5],[1,.5,1,1],[1,.5,0,.5],d.bezier][d.curve];const y=m&&w(m[0],m[1],m[2],m[3]);p=d.width+(u.width-d.width)*y(g),g=d.lane+(u.lane-d.lane)*y(g);e=this.getLaneX(m?g:d.lane),t=this.getLaneX(m?g+p:d.lane+d.width)}if(n<=h&&h<=s&&e>=o&&t<=r&&!this.selection.slide[f.id]?.includes(c.id))this.tempSelection.slide[f.id]||(this.tempSelection.slide[f.id]=[]),this.tempSelection.slide[f.id].push(c.id);else{if(s<h&&0===i)return;if(s<h)break}}}}emptySelection(){this.selection.single=[],this.selection.slide={}}scrollTickerHandler(){this.scrollTo(this.scrollBottom+this.autoScrollDelta)}scrollTo(e){const t={oldScrollBottom:this.scrollBottom,newScrollBottom:0};this.scrollBottom=Math.min(this.const.maxHeight-this.const.height,Math.max(0,e)),t.newScrollBottom=this.scrollBottom,this.event.dispatchEvent(new CustomEvent(y.Scroll,{detail:t})),this.reRender()}reRender(){this.container.time.destroy({children:!0}),this.container.note.destroy({children:!0}),this.container.slide.destroy({children:!0}),this.container.arrow.destroy({children:!0}),this.container.selection.destroy({children:!0}),this.container.time=new c.Container,this.container.note=new c.Container,this.container.slide=new c.Container,this.container.arrow=new c.Container,this.container.selection=new c.Container,this.container.time.name="Time",this.container.note.name="Note",this.container.slide.name="Slide",this.container.arrow.name="Arrow",this.container.selection.name="Selection",this.container.time.zIndex=5,this.container.arrow.zIndex=7,this.container.slide.zIndex=8,this.container.note.zIndex=9,this.container.selection.zIndex=10,this.app.stage.addChild(this.container.time),this.app.stage.addChild(this.container.note),this.app.stage.addChild(this.container.slide),this.app.stage.addChild(this.container.arrow),this.app.stage.addChild(this.container.selection),this.drawBeat(),this.drawBPM(),this.drawCurrentTimeLine(),this.drawNote(),this.drawSlide(),this.drawSelectionBox()}destroy(){this.event.dispatchEvent(new CustomEvent(y.Destroy)),this.app.destroy(!0,{children:!0})}static loadResource(i,n){return new Promise(e=>{const t=c.Loader.shared;t.add("images/sprite.json").load(()=>{console.log("load resources completed"),e()}),i&&t.onLoad.add(i),n&&t.onError.add(n)})}minusBeat(e,t){return this.fractionToDecimal(e)-this.fractionToDecimal(t)}getTimeByBeat(t){let i=0;for(let e=0;e<this.map.bpms.length;e++){var n=this.map.bpms[e];if(this.minusBeat(t,n.beat)<=0)break;var s=this.map.bpms[e+1];i+=(s&&0<this.minusBeat(t,s.beat)?this.minusBeat(s.beat,n.beat):this.minusBeat(t,n.beat))/n.bpm*60}return i}getHeightByBeat(e){return this.const.spaceY+this.getTimeByBeat(e)*this.const.heightPerSecond}getHeightByTime(e){return this.const.spaceY+e*this.const.heightPerSecond}formatTime(e){return`${Math.floor(e/60)}:${(e%60).toFixed(3).padStart(6,"0")}`}getYInCanvas(e){return this.const.height-(e-this.scrollBottom)}getLaneX(e){return this.const.width*(6*e+14)/100}fractionToDecimal(e){return e[0]+e[1]/e[2]}drawSelectionBox(){var e=this.selectionBox;if(e[0]!==e[2]&&e[1]!==e[3]){const n=new c.Graphics;n.beginFill(this.colors.selection,.2),n.lineStyle(this.const.lineWidth,this.colors.selection);var t=this.getYInCanvas(e[1]),i=this.getYInCanvas(e[3])-t;n.drawRect(e[0],t,e[2]-e[0],i),n.endFill(),this.container.selection.addChild(n)}}drawCurrentTimeLine(){var e=this.getHeightByTime(this.currentTime);if(e>=this.scrollBottom&&e<=this.scrollBottom+this.const.height){const t=new c.Graphics;t.name="Time-line",t.lineStyle(this.const.lineWidth,this.colors.time,1),t.moveTo(0,0),t.lineTo(.8*this.const.width,0),t.x=.1*this.const.width,t.y=this.getYInCanvas(e),this.container.time.addChild(t)}}drawBPM(){for(let e=0;e<this.map.bpms.length;e++){const n=this.map.bpms[e];var t=this.getTimeByBeat(n.beat),i=this.getHeightByTime(t);if(i>=this.scrollBottom&&i<=this.scrollBottom+this.const.height){const s=new c.Graphics;s.name=`BPM-${n.id}-line`,s.lineStyle(this.const.lineWidth,this.colors.bpm,1),s.moveTo(0,0),s.lineTo(this.const.width,0),s.y=this.getYInCanvas(i);const o=new c.Text(this.formatTime(t),{fontSize:this.const.fontSize,fill:this.colors.bpm,align:"left"});o.name=`BPM-${n.id}-time`,o.x=this.const.paddingX,o.y=this.getYInCanvas(i)-o.height-this.const.paddingY;const r=new c.Text(n.bpm.toString(),{fontSize:this.const.fontSize,fill:this.colors.bpm,align:"left"});r.name=`BPM-${n.id}-value`,r.x=this.getLaneX(12)+this.const.paddingX,r.y=this.getYInCanvas(i)-r.height-this.const.paddingY,this.container.time.addChild(s),this.container.time.addChild(o),this.container.time.addChild(r)}else if(i>this.scrollBottom+this.const.height)break}}drawBeatLine(e,t,i,n,s=!1){const o=new c.Graphics;var r=this.fractionToDecimal(e);if(o.name=`Beat-${r}-line`,o.lineStyle(this.const.lineWidth,t,i),o.moveTo(this.getLaneX(0),0),o.lineTo(s?this.const.width:this.getLaneX(12),0),o.y=this.getYInCanvas(n),s){const a=new c.Text(`${Math.floor(e[0]/4)+1}:${e[0]%4+1}`,{fontSize:this.const.fontSize,fill:t,align:"left"});a.name=`Beat-${r}-beat`,a.x=this.const.width-a.width-this.const.paddingX,a.y=this.getYInCanvas(n)-a.height-this.const.paddingY,this.container.time.addChild(a)}this.container.time.addChild(o)}drawBeat(){this.container.time.destroy({children:!0}),this.container.time=new c.Container;var t=this.beatSlice;for(let e=0;;e++){var i=[Math.floor(e/t),e%t,t],n=this.getTimeByBeat(i),n=this.getHeightByTime(n);if(n>this.const.maxHeight-this.const.spaceY)break;if(n>=this.scrollBottom&&n<=this.scrollBottom+this.const.height)e%t==0?this.drawBeatLine(i,this.colors.beat.half,1,n,!0):e%(t/2)==0?this.drawBeatLine(i,this.colors.beat.half,.2,n):e%(t/3)==0?this.drawBeatLine(i,this.colors.beat.third,.4,n):e%(t/4)==0&&this.drawBeatLine(i,this.colors.beat.quarter,.4,n);else if(n>this.scrollBottom+this.const.height)break}this.app.stage.addChild(this.container.time)}drawLane(){for(let e=0;e<=12;e++){const i=new c.Graphics;i.name=`Lane-${e}`;var t=this.const.width*((6*e+14)/100);i.lineStyle(this.const.lineWidth,this.colors.lane,e%2?.2:1),i.moveTo(0,0),i.lineTo(0,this.const.height),i.x=t,this.container.lane.addChild(i)}}drawBaseNote(e,t,i,n){const s=void 0===n?new b(this.notes[t],e):new B(this.notes[t],e,n);s.name=`Note-${t}-${e.id}`;t=this.const.noteHeight/s.height;s.scale.set(t),s.x=this.getLaneX(e.lane)-.006*this.const.width,s.y=this.getYInCanvas(i)-this.const.noteHeight/2,s.width=.06*(e.width+.2)*this.const.width/t,s.on("click",(void 0===n?this.singleClickHandler:this.slideClickHandler).bind(this)),this.container.note.addChild(s)}singleClickHandler(e){var t;0===e.data.button&&(t=e.target.id,e.data.originalEvent.ctrlKey||this.emptySelection(),-1===(e=this.selection.single.indexOf(t))?this.selection.single.push(t):this.selection.single.splice(e,1),this.dispatchSelectEvent(),this.reRender())}slideClickHandler(e){var t,i;0===e.data.button&&(t=e.target.id,i=e.target.slideId,e.data.originalEvent.ctrlKey||this.emptySelection(),this.selection.slide[i]||(this.selection.slide[i]=[]),-1===(e=this.selection.slide[i].indexOf(t))?this.selection.slide[i].push(t):this.selection.slide[i].splice(e,1),this.dispatchSelectEvent(),this.reRender())}drawFlickArrow(e,t){const i=Math.min(6,e.width);var n=`flick_arrow_${e.critical?"critical_":""}${i.toString().padStart(2,"0")}${{0:"",1:"_left",2:"_right"}[e.direction]}`;const s=new c.Sprite(this.notes[n]);s.name=`Arrow-${e.id}`;var o=.8*i*.06*this.const.width/s.width,n=s.height*o;s.scale.set(o),s.x=this.getLaneX(e.lane+(e.width-i)/2+.1*i),s.y=this.getYInCanvas(t)-n,this.container.arrow.addChild(s)}drawCurve(e,t,i,n,s=!1){const o=new c.Graphics;o.name=`Curve-${e.id}`;var r,a,l=[!1,[0,0,1,1],[1,.5,1,1],[0,0,0,.5],[.42,0,.58,1],e.bezier][e.curve];l&&(a=[this.getLaneX(e.lane+.1),this.getYInCanvas(i)],r=[this.getLaneX(t.lane+.1),this.getYInCanvas(n)],o.beginFill(s?this.colors.critical:this.colors.slide,.8),o.moveTo(a[0],a[1]),o.bezierCurveTo(a[0]+l[0]*(r[0]-a[0]),a[1]+l[1]*(r[1]-a[1]),a[0]+l[2]*(r[0]-a[0]),a[1]+l[3]*(r[1]-a[1]),r[0],r[1]),o.lineTo(this.getLaneX(t.lane+t.width-.1),this.getYInCanvas(n)),r=[this.getLaneX(e.lane+e.width-.1),this.getYInCanvas(i)],a=[this.getLaneX(t.lane+t.width-.1),this.getYInCanvas(n)],[e,i,t,n]=l,l=[1-t,1-n,1-e,1-i],o.bezierCurveTo(a[0]+l[0]*(r[0]-a[0]),a[1]+l[1]*(r[1]-a[1]),a[0]+l[2]*(r[0]-a[0]),a[1]+l[3]*(r[1]-a[1]),r[0],r[1]),o.endFill()),this.container.slide.addChild(o)}drawInvisibleNote(e,t,i=!1){const n=new c.Graphics;n.name=`Invisible-${e.id}`,n.lineStyle(3*this.const.lineWidth,i?this.colors.criticalNote:this.colors.slideNote,1),n.moveTo(this.getLaneX(e.lane+.1),0),n.lineTo(this.getLaneX(e.lane+e.width-.1),0),n.y=this.getYInCanvas(t),this.container.slide.addChild(n)}drawVisibleNote(e,t,i){const n=new E(this.notes[`slide_node${i.critical?"_critical":""}`],e,i);n.name=`Visible-${e.id}`;i=this.const.noteHeight/n.height;n.scale.set(i),n.x=this.getLaneX(e.lane+e.width/2)-n.width/2,n.y=this.getYInCanvas(t)-n.height/2,n.on("click",this.slideClickHandler.bind(this)),this.container.slide.addChild(n)}drawSkippedVisibleNote(t,i,n,s){var o=this.getHeightByBeat(i.beat),r=t.notes[s],a=this.getHeightByBeat(r.beat),e=[!1,[0,0,1,1],[0,0,0,.5],[1,.5,1,1],[1,.5,0,.5],i.bezier][i.curve];const l=e&&w(e[0],e[1],e[2],e[3]);for(let e=n;e<s;e++){var c=t.notes[e],h=this.getHeightByBeat(c.beat);if(h>=this.scrollBottom-this.const.noteHeight&&h<=this.scrollBottom+this.const.height+this.const.noteHeight){var d=(h-o)/(a-o),d={id:c.id,type:u.PJSK.NoteType.SlideVisible,beat:c.beat,width:i.width+(r.width-i.width)*l(d),lane:i.lane+(r.lane-i.lane)*l(d)};this.drawVisibleNote(d,h,t),(this.selection.slide[t.id]?.includes(c.id)||this.tempSelection.slide[t.id]?.includes(c.id))&&this.drawSelectionRect(d,h)}else if(h>this.scrollBottom+this.const.height+this.const.noteHeight)break}}drawSlide(){for(let e=0;e<this.map.slides.length;e++){const a=this.map.slides[e];if(!(this.getHeightByBeat(a.notes[a.notes.length-1].beat)<this.scrollBottom)){if(this.getHeightByBeat(a.notes[0].beat)>this.scrollBottom+this.const.height+this.const.noteHeight)break;for(let i=0;i<a.notes.length;i++){var n,s=a.notes[i],o=a.notes[i+1],r=this.getHeightByBeat(s.beat);let e=o,t=i;o&&void 0===o.lane&&(t+=1+a.notes.slice(i+1).findIndex(e=>void 0!==e.lane),e=a.notes[t]),void 0!==s.lane&&e&&r<this.scrollBottom+this.const.height+this.const.noteHeight&&this.getHeightByBeat(e.beat)>this.scrollBottom-this.const.noteHeight&&(n=this.getHeightByBeat(e.beat),this.drawCurve(s,e,r,n,a.critical),void 0===o.lane&&this.drawSkippedVisibleNote(a,s,i+1,t)),r>=this.scrollBottom-this.const.noteHeight&&r<=this.scrollBottom+this.const.height+this.const.noteHeight&&([u.PJSK.NoteType.SlideStart,u.PJSK.NoteType.SlideEndDefault].includes(s.type)?this.drawBaseNote(s,a.critical?"critical":"slide",r,a):s.type===u.PJSK.NoteType.SlideEndFlick?(this.drawBaseNote(s,s.critical||a.critical?"critical":"flick",r,a),this.drawFlickArrow({...s,critical:s?.critical||a.critical},r)):s.type===u.PJSK.NoteType.SlideInvisible?this.drawInvisibleNote(s,r,a.critical):s.type===u.PJSK.NoteType.SlideVisible&&this.drawVisibleNote(s,r,a),(this.selection.slide[a.id]?.includes(s.id)||this.tempSelection.slide[a.id]?.includes(s.id))&&this.drawSelectionRect(s,r))}}}}drawSelectionRect(e,t){const i=new c.Graphics;i.name=`Selection-${e.id}`,i.lineStyle(4*this.const.lineWidth,this.colors.selection),i.drawRect(this.getLaneX(e.lane)-this.const.paddingX,this.getYInCanvas(t)-this.const.noteHeight/2,.06*this.const.width*e.width+2*this.const.paddingX,this.const.noteHeight),this.container.selection.addChild(i)}moveCursor(e,t){void 0!==e&&((e=this.getHeightByBeat(e))>this.const.maxHeight-this.const.spaceY||(t<0||11<t?this.container.cursor.visible=!1:(e=this.getYInCanvas(e),this.container.cursor.y=e,this.container.cursor.x=this.getLaneX(t-.1),this.container.cursor.visible=!0)))}drawNote(){for(let e=0;e<this.map.notes.length;e++){var t=this.map.notes[e],i=this.getHeightByBeat(t.beat);if(i>=this.scrollBottom-this.const.noteHeight&&i<=this.scrollBottom+this.const.height+this.const.noteHeight&&(t.type===u.PJSK.NoteType.Flick&&this.drawFlickArrow(t,i),this.drawBaseNote(t,t.critical?"critical":t.type?"flick":"tap",i),(this.selection.single.includes(t.id)||this.tempSelection.single.includes(t.id))&&this.drawSelectionRect(t,i)),i>this.scrollBottom+this.const.height+this.const.noteHeight)break}}isUniqueArrayEqual(e,t){return e.length===t.length&&e.every(e=>t.includes(e))}isSelectionEqual(t,i){if(!this.isUniqueArrayEqual(t.single,i.single))return!1;const e=Object.keys(t.slide);var n=Object.keys(i.slide);return!!this.isUniqueArrayEqual(e,n)&&e.every(e=>this.isUniqueArrayEqual(t.slide[e],i.slide[e]))}getSelection(){return JSON.parse(JSON.stringify(this.selection))}getNotesBySelection(i){return{single:i.single.map(t=>{return this.map.notes.find(e=>e.id===t)}),slide:Object.keys(i.slide).map(t=>{const e=this.map.slides.find(e=>e.id===t);return{...e,notes:e.notes.filter(e=>i.slide[t].includes(e.id))}})}}deleteNotesBySelection(o){const r={single:[],slide:[]};return this.map.notes=this.map.notes.filter(e=>!o.single.includes(e.id)||(r.single.push(e),!1)),this.map.slides=this.map.slides.map(s=>(o.slide[s.id]&&(r.slide.push({...s,notes:[]}),s.notes=s.notes.filter((e,t)=>{if(o.slide[s.id].includes(e.id)){const i=r.slide.find(e=>e.id===s.id);if(i.notes.push(e),(0===t||t===s.notes.length-1)&&2!==s.notes.length){const n=s.notes[t+(0===t?1:-1)];n.type=e.type,void 0===n.lane&&(i.notes.push({...n}),n.width=e.width,n.lane=e.lane,n.curve=e.curve,void 0!==e.bezier&&(n.bezier=e.bezier),void 0!==e.direction&&(n.direction=e.direction),void 0!==e.critical&&(n.critical=e.critical))}return!1}return!0})),s)).filter(t=>(1===t.notes.length&&r.slide.find(e=>e.id===t.id).notes.push(t.notes[0]),1<t.notes.length)),this.reRender(),r}setMap(e){this.map=e,this.map.bpms=this.map.bpms.sort((e,t)=>this.minusBeat(e.beat,t.beat)),this.map.notes=this.map.notes.sort((e,t)=>this.minusBeat(e.beat,t.beat)),this.map.slides=this.map.slides.map(e=>({...e,notes:e.notes.sort((e,t)=>this.minusBeat(e.beat,t.beat))})).sort((e,t)=>this.minusBeat(e.notes[0].beat,t.notes[0].beat)),console.log(this.map)}getHeightPerSecond(){return this.const.heightPerSecond*this.resolution}setHeightPerSecond(e){var t;e<100||2e3<e||(t=(this.scrollBottom-this.const.spaceY)/this.const.heightPerSecond,this.const.heightPerSecond=e/this.resolution,this.const.spaceY=this.const.heightPerSecond/2.5,this.const.maxHeight=this.const.heightPerSecond*this.time+2*this.const.spaceY,this.scrollTo(t*this.const.heightPerSecond+this.const.spaceY),this.reRender())}getCurrentTime(){return this.currentTime}setCurrentTime(e){this.currentTime=e,this.reRender()}setBeatSlice(e){this.beatSlice=e}getCursorPosition(){var t=this.scrollBottom+this.const.height-this.lastMouseCursorPosition.y;let i=0,n=[0,0,1];var s=this.beatSlice;for(let e=0;;e++){var o=[Math.floor(e/s),e%s,s],r=this.getHeightByBeat(o);if(r<t)i=t-r,n=o;else if(t<=r){var a=r-t,r=this.lastMouseCursorPosition.x-this.getLaneX(0),r=Math.floor(r/(.06*this.const.width));return[a<i?o:n,r]}}}getConst(e){return this.const[e]}}var I=new Uint8Array(16);function L(){if(!S&&!(S="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return S(I)}var N=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function k(e){return"string"==typeof e&&N.test(e)}for(var O,x,A=[],P=0;P<256;++P)A.push((P+256).toString(16).substr(1));function M(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:0,t=(A[e[t+0]]+A[e[t+1]]+A[e[t+2]]+A[e[t+3]]+"-"+A[e[t+4]]+A[e[t+5]]+"-"+A[e[t+6]]+A[e[t+7]]+"-"+A[e[t+8]]+A[e[t+9]]+"-"+A[e[t+10]]+A[e[t+11]]+A[e[t+12]]+A[e[t+13]]+A[e[t+14]]+A[e[t+15]]).toLowerCase();if(!k(t))throw TypeError("Stringified UUID is invalid");return t}var R=0,D=0;function H(e){if(!k(e))throw TypeError("Invalid UUID");var t,i=new Uint8Array(16);return i[0]=(t=parseInt(e.slice(0,8),16))>>>24,i[1]=t>>>16&255,i[2]=t>>>8&255,i[3]=255&t,i[4]=(t=parseInt(e.slice(9,13),16))>>>8,i[5]=255&t,i[6]=(t=parseInt(e.slice(14,18),16))>>>8,i[7]=255&t,i[8]=(t=parseInt(e.slice(19,23),16))>>>8,i[9]=255&t,i[10]=(t=parseInt(e.slice(24,36),16))/1099511627776&255,i[11]=t/4294967296&255,i[12]=t>>>24&255,i[13]=t>>>16&255,i[14]=t>>>8&255,i[15]=255&t,i}function F(e,r,a){function t(e,t,i,n){if("string"==typeof e&&(e=function(e){e=unescape(encodeURIComponent(e));for(var t=[],i=0;i<e.length;++i)t.push(e.charCodeAt(i));return t}(e)),16!==(t="string"==typeof t?H(t):t).length)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");var s=new Uint8Array(16+e.length);if(s.set(t),s.set(e,t.length),(s=a(s))[6]=15&s[6]|r,s[8]=63&s[8]|128,i){n=n||0;for(var o=0;o<16;++o)i[n+o]=s[o];return i}return M(s)}try{t.name=e}catch(e){}return t.DNS="6ba7b810-9dad-11d1-80b4-00c04fd430c8",t.URL="6ba7b811-9dad-11d1-80b4-00c04fd430c8",t}function Y(e){return 14+(e+64>>>9<<4)+1}function U(e,t){var i=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(i>>16)<<16|65535&i}function V(e,t,i,n,s,o){return U((o=U(U(t,e),U(n,o)))<<s|o>>>32-s,i)}function _(e,t,i,n,s,o,r){return V(t&i|~t&n,e,t,s,o,r)}function X(e,t,i,n,s,o,r){return V(t&n|i&~n,e,t,s,o,r)}function j(e,t,i,n,s,o,r){return V(t^i^n,e,t,s,o,r)}function z(e,t,i,n,s,o,r){return V(i^(t|~n),e,t,s,o,r)}var $=F("v3",48,function(e){if("string"==typeof e){var t=unescape(encodeURIComponent(e));e=new Uint8Array(t.length);for(var i=0;i<t.length;++i)e[i]=t.charCodeAt(i)}return function(e){for(var t=[],i=32*e.length,n="0123456789abcdef",s=0;s<i;s+=8){var o=e[s>>5]>>>s%32&255,o=parseInt(n.charAt(o>>>4&15)+n.charAt(15&o),16);t.push(o)}return t}(function(e,t){e[t>>5]|=128<<t%32,e[Y(t)-1]=t;for(var i=1732584193,n=-271733879,s=-1732584194,o=271733878,r=0;r<e.length;r+=16){var a=i,l=n,c=s,h=o;i=_(i,n,s,o,e[r],7,-680876936),o=_(o,i,n,s,e[r+1],12,-389564586),s=_(s,o,i,n,e[r+2],17,606105819),n=_(n,s,o,i,e[r+3],22,-1044525330),i=_(i,n,s,o,e[r+4],7,-176418897),o=_(o,i,n,s,e[r+5],12,1200080426),s=_(s,o,i,n,e[r+6],17,-1473231341),n=_(n,s,o,i,e[r+7],22,-45705983),i=_(i,n,s,o,e[r+8],7,1770035416),o=_(o,i,n,s,e[r+9],12,-1958414417),s=_(s,o,i,n,e[r+10],17,-42063),n=_(n,s,o,i,e[r+11],22,-1990404162),i=_(i,n,s,o,e[r+12],7,1804603682),o=_(o,i,n,s,e[r+13],12,-40341101),s=_(s,o,i,n,e[r+14],17,-1502002290),n=_(n,s,o,i,e[r+15],22,1236535329),i=X(i,n,s,o,e[r+1],5,-165796510),o=X(o,i,n,s,e[r+6],9,-1069501632),s=X(s,o,i,n,e[r+11],14,643717713),n=X(n,s,o,i,e[r],20,-373897302),i=X(i,n,s,o,e[r+5],5,-701558691),o=X(o,i,n,s,e[r+10],9,38016083),s=X(s,o,i,n,e[r+15],14,-660478335),n=X(n,s,o,i,e[r+4],20,-405537848),i=X(i,n,s,o,e[r+9],5,568446438),o=X(o,i,n,s,e[r+14],9,-1019803690),s=X(s,o,i,n,e[r+3],14,-187363961),n=X(n,s,o,i,e[r+8],20,1163531501),i=X(i,n,s,o,e[r+13],5,-1444681467),o=X(o,i,n,s,e[r+2],9,-51403784),s=X(s,o,i,n,e[r+7],14,1735328473),n=X(n,s,o,i,e[r+12],20,-1926607734),i=j(i,n,s,o,e[r+5],4,-378558),o=j(o,i,n,s,e[r+8],11,-2022574463),s=j(s,o,i,n,e[r+11],16,1839030562),n=j(n,s,o,i,e[r+14],23,-35309556),i=j(i,n,s,o,e[r+1],4,-1530992060),o=j(o,i,n,s,e[r+4],11,1272893353),s=j(s,o,i,n,e[r+7],16,-155497632),n=j(n,s,o,i,e[r+10],23,-1094730640),i=j(i,n,s,o,e[r+13],4,681279174),o=j(o,i,n,s,e[r],11,-358537222),s=j(s,o,i,n,e[r+3],16,-722521979),n=j(n,s,o,i,e[r+6],23,76029189),i=j(i,n,s,o,e[r+9],4,-640364487),o=j(o,i,n,s,e[r+12],11,-421815835),s=j(s,o,i,n,e[r+15],16,530742520),n=j(n,s,o,i,e[r+2],23,-995338651),i=z(i,n,s,o,e[r],6,-198630844),o=z(o,i,n,s,e[r+7],10,1126891415),s=z(s,o,i,n,e[r+14],15,-1416354905),n=z(n,s,o,i,e[r+5],21,-57434055),i=z(i,n,s,o,e[r+12],6,1700485571),o=z(o,i,n,s,e[r+3],10,-1894986606),s=z(s,o,i,n,e[r+10],15,-1051523),n=z(n,s,o,i,e[r+1],21,-2054922799),i=z(i,n,s,o,e[r+8],6,1873313359),o=z(o,i,n,s,e[r+15],10,-30611744),s=z(s,o,i,n,e[r+6],15,-1560198380),n=z(n,s,o,i,e[r+13],21,1309151649),i=z(i,n,s,o,e[r+4],6,-145523070),o=z(o,i,n,s,e[r+11],10,-1120210379),s=z(s,o,i,n,e[r+2],15,718787259),n=z(n,s,o,i,e[r+9],21,-343485551),i=U(i,a),n=U(n,l),s=U(s,c),o=U(o,h)}return[i,n,s,o]}(function(e){if(0===e.length)return[];for(var t=8*e.length,i=new Uint32Array(Y(t)),n=0;n<t;n+=8)i[n>>5]|=(255&e[n/8])<<n%32;return i}(e),8*e.length))});function G(e,t){return e<<t|e>>>32-t}n=F("v5",80,function(e){var t=[1518500249,1859775393,2400959708,3395469782],i=[1732584193,4023233417,2562383102,271733878,3285377520];if("string"==typeof e){var n=unescape(encodeURIComponent(e));e=[];for(var s=0;s<n.length;++s)e.push(n.charCodeAt(s))}else Array.isArray(e)||(e=Array.prototype.slice.call(e));e.push(128);for(var o=e.length/4+2,r=Math.ceil(o/16),a=new Array(r),l=0;l<r;++l){for(var c=new Uint32Array(16),h=0;h<16;++h)c[h]=e[64*l+4*h]<<24|e[64*l+4*h+1]<<16|e[64*l+4*h+2]<<8|e[64*l+4*h+3];a[l]=c}a[r-1][14]=8*(e.length-1)/Math.pow(2,32),a[r-1][14]=Math.floor(a[r-1][14]),a[r-1][15]=8*(e.length-1)&4294967295;for(var d=0;d<r;++d){for(var u=new Uint32Array(80),p=0;p<16;++p)u[p]=a[d][p];for(var g=16;g<80;++g)u[g]=G(u[g-3]^u[g-8]^u[g-14]^u[g-16],1);for(var m=i[0],f=i[1],v=i[2],y=i[3],w=i[4],S=0;S<80;++S)var b=Math.floor(S/20),b=G(m,5)+function(e,t,i,n){switch(e){case 0:return t&i^~t&n;case 1:return t^i^n;case 2:return t&i^t&n^i&n;case 3:return t^i^n}}(b,f,v,y)+w+t[b]+u[S]>>>0,w=y,y=v,v=G(f,30)>>>0,f=m,m=b;i[0]=i[0]+m>>>0,i[1]=i[1]+f>>>0,i[2]=i[2]+v>>>0,i[3]=i[3]+y>>>0,i[4]=i[4]+w>>>0}return[i[0]>>24&255,i[0]>>16&255,i[0]>>8&255,255&i[0],i[1]>>24&255,i[1]>>16&255,i[1]>>8&255,255&i[1],i[2]>>24&255,i[2]>>16&255,i[2]>>8&255,255&i[2],i[3]>>24&255,i[3]>>16&255,i[3]>>8&255,255&i[3],i[4]>>24&255,i[4]>>16&255,i[4]>>8&255,255&i[4]]});var K=i(Object.freeze({__proto__:null,v1:function(e,t,i){var n=t&&i||0,s=t||new Array(16),o=(e=e||{}).node||O,r=void 0!==e.clockseq?e.clockseq:x;null!=o&&null!=r||(l=e.random||(e.rng||L)(),null==o&&(o=O=[1|l[0],l[1],l[2],l[3],l[4],l[5]]),null==r&&(r=x=16383&(l[6]<<8|l[7])));var a=void 0!==e.msecs?e.msecs:Date.now(),i=void 0!==e.nsecs?e.nsecs:D+1,l=a-R+(i-D)/1e4;if(l<0&&void 0===e.clockseq&&(r=r+1&16383),1e4<=(i=(l<0||R<a)&&void 0===e.nsecs?0:i))throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");R=a,x=r,i=(1e4*(268435455&(a+=122192928e5))+(D=i))%4294967296,s[n++]=i>>>24&255,s[n++]=i>>>16&255,s[n++]=i>>>8&255,s[n++]=255&i,a=a/4294967296*1e4&268435455,s[n++]=a>>>8&255,s[n++]=255&a,s[n++]=a>>>24&15|16,s[n++]=a>>>16&255,s[n++]=r>>>8|128,s[n++]=255&r;for(var c=0;c<6;++c)s[n+c]=o[c];return t||M(s)},v3:$,v4:function(e,t,i){var n=(e=e||{}).random||(e.rng||L)();if(n[6]=15&n[6]|64,n[8]=63&n[8]|128,t){i=i||0;for(var s=0;s<16;++s)t[i+s]=n[s];return t}return M(n)},v5:n,NIL:"00000000-0000-0000-0000-000000000000",version:function(e){if(!k(e))throw TypeError("Invalid UUID");return parseInt(e.substr(14,1),16)},validate:k,stringify:M,parse:H})),r={},t={};Object.defineProperty(t,"__esModule",{value:!0});const W=[{TEXT:"BASIC",COLOR:"#19aa19",BACKGROUND:"#e8f6e8"},{TEXT:"ADVANCED",COLOR:"#f55000",BACKGROUND:"#feede5"},{TEXT:"EXPERT",COLOR:"#a00a50",BACKGROUND:"#F5E6ED"},{TEXT:"MASTER",COLOR:"#8200dc",BACKGROUND:"#f2e5fb"},{TEXT:"WORLD'S END",COLOR:"#000000",BACKGROUND:"#e5e5e5"}],J=["SONGID","TITLE","ARTIST","DESIGNER","DIFFICULTY","PLAYLEVEL","WAVE","WAVEOFFSET","JACKET","BACKGROUND","MOVIE","MOVIEOFFSET","BASEBPM"],q=["SONGID","TITLE","ARTIST","DESIGNER","DIFFICULTY","PLAYLEVEL"],Z=["ARTIST","BACKGROUND","DESIGNER","JACKET","MOVIE","SONGID","TITLE","WAVE"],Q=["BASEBPM","MOVIEOFFSET","WAVEOFFSET"];function ee(e){return e.split("\n").filter(e=>"#"===e.slice(0,1)).map(e=>e.slice(1)).filter(e=>!e.match(/^\d{3}/)).reduce((e,t)=>{var i,n=t.slice(0,t.indexOf(" ")).trim().toUpperCase();return i=n,-1<J.indexOf(i)&&(t={key:n,value:t.slice(t.indexOf(" ")+1,t.length).trim()},e.push(t)),e},[]).map(e=>(e.value=e.value.match(/^".*"$/)?e.value.slice(1,e.value.length-1):e.value,e)).filter(e=>e.value).reduce((e,t)=>{if(-1<Z.indexOf(t.key)&&(e[t.key]=t.value),-1<Q.indexOf(t.key)&&Number(t.value)&&(e[t.key]=Number(t.value)),"DIFFICULTY"===t.key){var i=Number(t.value.slice(0,1));if(isNaN(i)||Number(i)<0||4<Number(i))return e;e.DIFFICULTY=Object.assign({},W[i],{LEVEL:Number(i),MARK:4===Number(i)?1!==t.value.length?`${t.value}:`.split(":")[1]:"":void 0})}if("PLAYLEVEL"===t.key){if(!Number(t.value)&&!Number(t.value.slice(0,-1)))return e;e.PLAYLEVEL={LEVEL:Number(t.value)||Number(t.value.slice(0,-1)),PLUS:/\+$/.test(t.value),TEXT:t.value}}return e},{})}t.getMeta=ee,t.validate=function(e){const t=ee(e),i=q.slice();return null!=t.WAVE&&i.push("WAVEOFFSET"),null!=t.MOVIE&&i.push("MOVIEOFFSET"),null!=t.DIFFICULTY&&4===t.DIFFICULTY.LEVEL&&i.splice(i.indexOf("PLAYLEVEL"),1),{MISSING_META:e=i.filter(e=>!t.hasOwnProperty(e)),VALIDITY:0===e.length}};var te,$={};Object.defineProperty($,"__esModule",{value:!0});const ie=t;function ne(e,t,i,n){return e.filter(e=>e.match(t)).reduce((e,t)=>(e[Number(t.slice(i,n))]=Number(t.split(":")[1].trim()),e),[])}function se(s,e){return[...Array(e)].reduce((e,t,i)=>{let n=i;for(;e[i]=s[n--],void 0===e[i];);return e},[])}function oe(e,n){const s=[];return e.filter(e=>e.laneType===n).reduce((e,t)=>(e[t.measure]=e[t.measure]||[],e[t.measure][t.tick]=e[t.measure][t.tick]||[],e[t.measure][t.tick].push(t),e),[]).reduce((i,e)=>(e.forEach(e=>{e.filter(e=>2===e.noteType).forEach(e=>{var t=2===n?e.lane:0;e.channel&&s[t]&&s[t][e.channel]&&(s[t][e.channel].push(e),i.push(s[t][e.channel]),delete s[t][e.channel])}),e.filter(e=>1===e.noteType).forEach(e=>{var t=2===n?e.lane:0;e.channel&&(s[t]=s[t]||[],s[t][e.channel]=[],s[t][e.channel].push(e))}),e.filter(e=>-1<[3,4,5].indexOf(e.noteType)).forEach(e=>{var t=2===n?e.lane:0;e.channel&&s[t]&&s[t][e.channel]&&s[t][e.channel].push(e)})}),i),[])}function re(e){for(var t in e)te.hasOwnProperty(t)||(te[t]=e[t])}$.getScore=function(e,t=192){const i=e.split("\n").filter(e=>"#"===e.slice(0,1)).map(e=>e.slice(1));var n,r,a,s=i.filter(e=>e.match(/^\d{3}[1-5][0-9a-fA-F][0-9a-zA-Z]?:/)).map(e=>Number(e.slice(0,3))).reduce((e,t)=>t<e?e:t,0)+1,o=function(e,t){const i=ne(e,/^\d{3}02:/,0,3);return i[0]=Number.isFinite(i[0])?i[0]:4,se(i,t)}(i,s);const l=(n=i,r=t,a=o,n.filter(e=>e.match(/^\d{3}[1-5][0-9a-fA-F][0-9a-zA-Z]?:(\s*[0-9a-zA-Z][0-9a-gA-G])+\s*$/)).map(e=>e.split(":",2)).reduce((t,n)=>{const s=n[1].trim().replace(/ /g,""),o=Number(n[0].slice(0,3));return[...Array(s.length/2)].map((e,t)=>{const i={lane:parseInt(n[0].slice(4,5),16),laneType:Number(n[0].slice(3,4)),measure:o,noteType:parseInt(s[2*t],36),tick:Math.round(r*a[o]/(s.length/2)*t),width:parseInt(s[2*t+1],17)};return 6===n[0].length&&(i.channel=n[0].slice(5,6).toUpperCase().charCodeAt(0)),i}).filter(e=>0!==e.width).forEach(e=>t.push(e)),t},[]));return{BEATs:o,BPMs:function(e,t,i=120){const n=ne(e,/^BPM\d{2}:/,3,5),s=ne(e,/^\d{3}08:/,0,3).map(e=>{if(n[e])return n[e]});return s[0]=Number(s[0])?s[0]:i,se(s,t)}(i,s,ie.getMeta(e).BASEBPM),airActionNotes:oe(l,4),airNotes:l.filter(e=>5===e.laneType),holdNotes:oe(l,2),measure:s,shortNotes:l.filter(e=>1===e.laneType),slideNotes:oe(l,3)}},te=r,Object.defineProperty(te,"__esModule",{value:!0}),re(t),re($);n={};t=n,Object.defineProperty(t,"__esModule",{value:!0}),t.FlickDirection=t.CurveType=t.NoteType=void 0,($=t.NoteType||(t.NoteType={}))[$.Tap=0]="Tap",$[$.Flick=1]="Flick",$[$.SlideStart=2]="SlideStart",$[$.SlideInvisible=3]="SlideInvisible",$[$.SlideVisible=4]="SlideVisible",$[$.SlideEndDefault=5]="SlideEndDefault",$[$.SlideEndFlick=6]="SlideEndFlick",($=t.CurveType||(t.CurveType={}))[$.None=0]="None",$[$.Linear=1]="Linear",$[$.EaseIn=2]="EaseIn",$[$.EaseOut=3]="EaseOut",$[$.EaseInOut=4]="EaseInOut",$[$.CubicBezier=5]="CubicBezier",(t=t.FlickDirection||(t.FlickDirection={}))[t.Up=0]="Up",t[t.Left=1]="Left",t[t.Right=2]="Right";const ae=K["v4"],le=r,{NoteType:ce,CurveType:he,FlickDirection:de}=n;function ue(e,t){return le.getScore(e,t)}function pe(e,t){return e.measure===t.measure&&e.tick===t.tick&&e.lane===t.lane&&e.width===t.width}function ge(e,t,i){var n=function(e,t){if(0===e||0===t)return 1;for(;0!==t;){var i=t;t=e%t,e=i}return e}(t%i,i);return[4*e+Math.floor(t/i),t%i/n,t?i/n:1]}var n={convertor:function(e){const a=ue(e,480),n=ae(),s={timelines:[{id:n,name:"Timeline 1"}],bpms:[{id:ae(),timeline:n,beat:[0,0,1],bpm:a.BPMs[0]}],notes:[],slides:[]};return a.slideNotes.forEach(e=>{const r={id:ae(),timeline:n,notes:[]};e.forEach((t,e)=>{var i=a.airNotes.findIndex(e=>pe(t,e)),n=a.shortNotes.findIndex(e=>3===e.noteType&&pe(t,e)),s=a.shortNotes.findIndex(e=>pe(t,e));const o={id:ae(),type:{1:ce.SlideStart,2:ce.SlideEndDefault,3:ce.SlideVisible,5:ce.SlideInvisible}[t.noteType],beat:ge(t.measure,t.tick,480),lane:t.lane-2,width:t.width,curve:he.Linear};0===e&&-1!==s&&2===a.shortNotes[s].noteType?(a.shortNotes.splice(s,1),r.critical=!0):o.type===ce.SlideEndDefault&&-1!==i?([e]=a.airNotes.splice(i,1),o.type=ce.SlideEndFlick,o.direction=3===e.noteType?de.Left:4===e.noteType?de.Right:de.Up,-1!==s&&([e]=a.shortNotes.splice(s,1),2===e.noteType&&(o.critical=!0))):-1!==i&&-1!==s&&(a.shortNotes.splice(s,1),[i]=a.airNotes.splice(i,1),o.curve={2:he.EaseOut,5:he.EaseIn,6:he.EaseIn}[i.noteType]),-1!==n&&o.type===ce.SlideVisible&&(a.shortNotes.splice(n,1),delete o.width,delete o.lane,delete o.curve),r.notes.push(o)}),s.slides.push(r)}),a.shortNotes.forEach(t=>{if(!(t.lane<2||13<t.lane)){var e=a.airNotes.find(e=>pe(e,t));const i={id:ae(),timeline:n,type:e?ce.Flick:ce.Tap,beat:ge(t.measure,t.tick,480),lane:t.lane-2,width:t.width};2===t.noteType&&(i.critical=!0),e&&(i.direction=3===e.noteType?de.Left:4===e.noteType?de.Right:de.Up),s.notes.push(i)}}),s}}["convertor"],me=n;var fe,ve,ye,we;fe="* {\n\tmargin: 0;\n}\n\nhtml, body {\n\twidth: 100%;\n\theight: 100%;\n}\n\nbody {\n\tuser-select: none;\n}\n\n#selector {\n\theight: 80px;\n\tposition: relative;\n}\n\n#app {\n\theight: calc(100% - 80px);\n\tmax-width: 600px;\n}\n",we=(ve=void 0===ve?{}:ve).insertAt,fe&&"undefined"!=typeof document&&(ye=document.head||document.getElementsByTagName("head")[0],(ve=document.createElement("style")).type="text/css","top"===we&&ye.firstChild?ye.insertBefore(ve,ye.firstChild):ye.appendChild(ve),ve.styleSheet?ve.styleSheet.cssText=fe:ve.appendChild(document.createTextNode(fe))),function(){document.addEventListener("DOMContentLoaded",async function(){console.log("ready");const e=document.getElementById("add"),t=document.getElementById("minus"),i=document.getElementById("id"),n=document.getElementById("diff"),s=document.getElementById("load"),o=document.getElementById("bottom"),r=document.getElementById("scroll"),a=document.getElementById("input"),l=document.getElementById("container"),c=document.getElementById("text"),h=document.getElementById("draw");function d(e){var t;null!==v&&(t=v.getHeightPerSecond(),v.setHeightPerSecond("+"===e?t+(t<1e3?100:200):t-100))}e.addEventListener("click",()=>{d("+")}),t.addEventListener("click",()=>{d("-")}),a.addEventListener("click",()=>{l.style.display="none"===l.style.display?"block":"none"}),h.addEventListener("click",()=>{l.style.display="none";var e=me(c.value);null!==v&&(v.destroy(),v=null),v=new C(document.getElementById("app"),e,180),v.event.addEventListener("scroll",e=>{o.value=e.detail.scrollBottom}),v.scrollTo(0)}),await C.loadResource((e,t)=>{console.log(`${e.progress}% loading: ${t.url}`)}),r.addEventListener("click",()=>{var e=parseInt(o.value);v&&v.scrollTo(e)}),s.addEventListener("click",async()=>{const e=await fetch(`https://assets.pjsek.ai/file/pjsekai-assets/startapp/music/music_score/${i.value.padStart(4,"0")}_01/${n.value}`);var t=me(await e.text());null!==v&&(v.destroy(),v=null),v=new C(document.getElementById("app"),t,180),v.event.addEventListener(y.Scroll,e=>{o.value=e.detail.newScrollBottom.toString()}),v.event.addEventListener(y.Select,e=>{console.log(v.getNotesBySelection(e.detail.newSelection))}),v.scrollTo(0)}),i.value="135",s.click();const u=document.getElementById("music"),p=document.getElementById("audio"),g=document.getElementById("follow");u.addEventListener("input",()=>{var e=u.files[0],e=URL.createObjectURL(e);p.src=e});let m=null;p.addEventListener("play",()=>{m=setInterval(()=>{null!==v&&(v.setCurrentTime(p.currentTime),g.checked&&v.scrollTo(v.getHeightByTime(p.currentTime)-v.getConst("spaceY")))},16)}),p.addEventListener("pause",()=>{clearInterval(m)});const f=document.getElementById("delete");f.addEventListener("click",()=>{var e;null!==v&&(e=v.deleteNotesBySelection(v.getSelection()),console.log("deleted:",e))})});let v=null}()}(PIXI);
